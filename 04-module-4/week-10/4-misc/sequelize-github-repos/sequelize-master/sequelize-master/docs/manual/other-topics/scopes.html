<h1 id="scopes">Scopes</h1>
<p>Scopes are used to help you reuse code. You can define commonly used queries, specifying options such as <code>where</code>, <code>include</code>, <code>limit</code>, etc.</p>
<p>This guide concerns model scopes. You might also be interested in the <a href="association-scopes.html">guide for association scopes</a>, which are similar but not the same thing.</p>
<h2 id="definition">Definition</h2>
<p>Scopes are defined in the model definition and can be finder objects, or functions returning finder objects - except for the default scope, which can only be an object:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">class</span> Project <span class="kw">extends</span> Model <span class="op">{}</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="va">Project</span>.<span class="at">init</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="co">// Attributes</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="op">},</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="dt">defaultScope</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-7" title="7">      <span class="dt">active</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-9" title="9">  <span class="op">},</span></a>
<a class="sourceLine" id="cb1-10" title="10">  <span class="dt">scopes</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-11" title="11">    <span class="dt">deleted</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-12" title="12">      <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-13" title="13">        <span class="dt">deleted</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb1-14" title="14">      <span class="op">}</span></a>
<a class="sourceLine" id="cb1-15" title="15">    <span class="op">},</span></a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="dt">activeUsers</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-17" title="17">      <span class="dt">include</span><span class="op">:</span> [</a>
<a class="sourceLine" id="cb1-18" title="18">        <span class="op">{</span> <span class="dt">model</span><span class="op">:</span> User<span class="op">,</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> <span class="dt">active</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb1-19" title="19">      ]</a>
<a class="sourceLine" id="cb1-20" title="20">    <span class="op">},</span></a>
<a class="sourceLine" id="cb1-21" title="21">    <span class="at">random</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-22" title="22">      <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-23" title="23">        <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-24" title="24">          <span class="dt">someNumber</span><span class="op">:</span> <span class="va">Math</span>.<span class="at">random</span>()</a>
<a class="sourceLine" id="cb1-25" title="25">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-26" title="26">      <span class="op">}</span></a>
<a class="sourceLine" id="cb1-27" title="27">    <span class="op">},</span></a>
<a class="sourceLine" id="cb1-28" title="28">    <span class="at">accessLevel</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-29" title="29">      <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-30" title="30">        <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-31" title="31">          <span class="dt">accessLevel</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-32" title="32">            [<span class="va">Op</span>.<span class="at">gte</span>]<span class="op">:</span> value</a>
<a class="sourceLine" id="cb1-33" title="33">          <span class="op">}</span></a>
<a class="sourceLine" id="cb1-34" title="34">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-35" title="35">      <span class="op">}</span></a>
<a class="sourceLine" id="cb1-36" title="36">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-37" title="37">    sequelize<span class="op">,</span></a>
<a class="sourceLine" id="cb1-38" title="38">    <span class="dt">modelName</span><span class="op">:</span> <span class="st">&#39;project&#39;</span></a>
<a class="sourceLine" id="cb1-39" title="39">  <span class="op">}</span></a>
<a class="sourceLine" id="cb1-40" title="40"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>You can also add scopes after a model has been defined by calling <a href="../class/lib/model.js~Model.html#static-method-addScope"><code>YourModel.addScope</code></a>. This is especially useful for scopes with includes, where the model in the include might not be defined at the time the other model is being defined.</p>
<p>The default scope is always applied. This means, that with the model definition above, <code>Project.findAll()</code> will create the following query:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> projects <span class="kw">WHERE</span> active <span class="op">=</span> <span class="kw">true</span></a></code></pre></div>
<p>The default scope can be removed by calling <code>.unscoped()</code>, <code>.scope(null)</code>, or by invoking another scope:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="cf">await</span> <span class="va">Project</span>.<span class="at">scope</span>(<span class="st">&#39;deleted&#39;</span>).<span class="at">findAll</span>()<span class="op">;</span> <span class="co">// Removes the default scope</span></a></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> projects <span class="kw">WHERE</span> deleted <span class="op">=</span> <span class="kw">true</span></a></code></pre></div>
<p>It is also possible to include scoped models in a scope definition. This allows you to avoid duplicating <code>include</code>, <code>attributes</code> or <code>where</code> definitions. Using the above example, and invoking the <code>active</code> scope on the included User model (rather than specifying the condition directly in that include object):</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// The `activeUsers` scope defined in the example above could also have been defined this way:</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="va">Project</span>.<span class="at">addScope</span>(<span class="st">&#39;activeUsers&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="dt">include</span><span class="op">:</span> [</a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="op">{</span> <span class="dt">model</span><span class="op">:</span> <span class="va">User</span>.<span class="at">scope</span>(<span class="st">&#39;active&#39;</span>) <span class="op">}</span></a>
<a class="sourceLine" id="cb5-5" title="5">  ]</a>
<a class="sourceLine" id="cb5-6" title="6"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="usage">Usage</h2>
<p>Scopes are applied by calling <code>.scope</code> on the model definition, passing the name of one or more scopes. <code>.scope</code> returns a fully functional model instance with all the regular methods: <code>.findAll</code>, <code>.update</code>, <code>.count</code>, <code>.destroy</code> etc. You can save this model instance and reuse it later:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">const</span> DeletedProjects <span class="op">=</span> <span class="va">Project</span>.<span class="at">scope</span>(<span class="st">&#39;deleted&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="cf">await</span> <span class="va">DeletedProjects</span>.<span class="at">findAll</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co">// The above is equivalent to:</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="cf">await</span> <span class="va">Project</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb6-6" title="6">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="dt">deleted</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb6-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Scopes apply to <code>.find</code>, <code>.findAll</code>, <code>.count</code>, <code>.update</code>, <code>.increment</code> and <code>.destroy</code>.</p>
<p>Scopes which are functions can be invoked in two ways. If the scope does not take any arguments it can be invoked as normally. If the scope takes arguments, pass an object:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="cf">await</span> <span class="va">Project</span>.<span class="at">scope</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">method</span><span class="op">:</span> [<span class="st">&#39;accessLevel&#39;</span><span class="op">,</span> <span class="dv">19</span>] <span class="op">}</span>).<span class="at">findAll</span>()<span class="op">;</span></a></code></pre></div>
<p>Generated SQL:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> projects <span class="kw">WHERE</span> someNumber <span class="op">=</span> <span class="dv">42</span> <span class="kw">AND</span> accessLevel <span class="op">&gt;=</span> <span class="dv">19</span></a></code></pre></div>
<h2 id="merging">Merging</h2>
<p>Several scopes can be applied simultaneously by passing an array of scopes to <code>.scope</code>, or by passing the scopes as consecutive arguments.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="co">// These two are equivalent</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="cf">await</span> <span class="va">Project</span>.<span class="at">scope</span>(<span class="st">&#39;deleted&#39;</span><span class="op">,</span> <span class="st">&#39;activeUsers&#39;</span>).<span class="at">findAll</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="cf">await</span> <span class="va">Project</span>.<span class="at">scope</span>([<span class="st">&#39;deleted&#39;</span><span class="op">,</span> <span class="st">&#39;activeUsers&#39;</span>]).<span class="at">findAll</span>()<span class="op">;</span></a></code></pre></div>
<p>Generated SQL:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> projects</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw">INNER</span> <span class="kw">JOIN</span> users <span class="kw">ON</span> projects.userId <span class="op">=</span> users.<span class="kw">id</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="kw">WHERE</span> projects.deleted <span class="op">=</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="kw">AND</span> users.active <span class="op">=</span> <span class="kw">true</span></a></code></pre></div>
<p>If you want to apply another scope alongside the default scope, pass the key <code>defaultScope</code> to <code>.scope</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="cf">await</span> <span class="va">Project</span>.<span class="at">scope</span>(<span class="st">&#39;defaultScope&#39;</span><span class="op">,</span> <span class="st">&#39;deleted&#39;</span>).<span class="at">findAll</span>()<span class="op">;</span></a></code></pre></div>
<p>Generated SQL:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> projects <span class="kw">WHERE</span> active <span class="op">=</span> <span class="kw">true</span> <span class="kw">AND</span> deleted <span class="op">=</span> <span class="kw">true</span></a></code></pre></div>
<p>When invoking several scopes, keys from subsequent scopes will overwrite previous ones (similarly to <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign</a>), except for <code>where</code> and <code>include</code>, which will be merged. Consider two scopes:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="va">YourMode</span>.<span class="at">addScope</span>(<span class="st">&#39;scope1&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-3" title="3">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&#39;bob&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb13-4" title="4">    <span class="dt">age</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-5" title="5">      [<span class="va">Op</span>.<span class="at">gt</span>]<span class="op">:</span> <span class="dv">20</span></a>
<a class="sourceLine" id="cb13-6" title="6">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-7" title="7">  <span class="op">},</span></a>
<a class="sourceLine" id="cb13-8" title="8">  <span class="dt">limit</span><span class="op">:</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb13-9" title="9"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-10" title="10"><span class="va">YourMode</span>.<span class="at">addScope</span>(<span class="st">&#39;scope2&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-11" title="11">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-12" title="12">    <span class="dt">age</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-13" title="13">      [<span class="va">Op</span>.<span class="at">gt</span>]<span class="op">:</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb13-14" title="14">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-15" title="15">  <span class="op">},</span></a>
<a class="sourceLine" id="cb13-16" title="16">  <span class="dt">limit</span><span class="op">:</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb13-17" title="17"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Using <code>.scope('scope1', 'scope2')</code> will yield the following WHERE clause:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">WHERE</span> firstName <span class="op">=</span> <span class="st">&#39;bob&#39;</span> <span class="kw">AND</span> age <span class="op">&gt;</span> <span class="dv">30</span> <span class="kw">LIMIT</span> <span class="dv">10</span></a></code></pre></div>
<p>Note how <code>limit</code> and <code>age</code> are overwritten by <code>scope2</code>, while <code>firstName</code> is preserved. The <code>limit</code>, <code>offset</code>, <code>order</code>, <code>paranoid</code>, <code>lock</code> and <code>raw</code> fields are overwritten, while <code>where</code> is shallowly merged (meaning that identical keys will be overwritten). The merge strategy for <code>include</code> will be discussed later on.</p>
<p>Note that <code>attributes</code> keys of multiple applied scopes are merged in such a way that <code>attributes.exclude</code> are always preserved. This allows merging several scopes and never leaking sensitive fields in final scope.</p>
<p>The same merge logic applies when passing a find object directly to <code>findAll</code> (and similar finders) on a scoped model:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" title="1"><span class="va">Project</span>.<span class="at">scope</span>(<span class="st">&#39;deleted&#39;</span>).<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-3" title="3">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&#39;john&#39;</span></a>
<a class="sourceLine" id="cb15-4" title="4">  <span class="op">}</span></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="op">}</span>)</a></code></pre></div>
<p>Generated where clause:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">WHERE</span> deleted <span class="op">=</span> <span class="kw">true</span> <span class="kw">AND</span> firstName <span class="op">=</span> <span class="st">&#39;john&#39;</span></a></code></pre></div>
<p>Here the <code>deleted</code> scope is merged with the finder. If we were to pass <code>where: { firstName: 'john', deleted: false }</code> to the finder, the <code>deleted</code> scope would be overwritten.</p>
<h3 id="merging-includes">Merging includes</h3>
<p>Includes are merged recursively based on the models being included. This is a very powerful merge, added on v5, and is better understood with an example.</p>
<p>Consider the models <code>Foo</code>, <code>Bar</code>, <code>Baz</code> and <code>Qux</code>, with One-to-Many associations as follows:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">const</span> Foo <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Foo&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="kw">const</span> Bar <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Bar&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="kw">const</span> Baz <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Baz&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="kw">const</span> Qux <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Qux&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="va">Foo</span>.<span class="at">hasMany</span>(Bar<span class="op">,</span> <span class="op">{</span> <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;fooId&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="va">Bar</span>.<span class="at">hasMany</span>(Baz<span class="op">,</span> <span class="op">{</span> <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;barId&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-7" title="7"><span class="va">Baz</span>.<span class="at">hasMany</span>(Qux<span class="op">,</span> <span class="op">{</span> <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;bazId&#39;</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now, consider the following four scopes defined on Foo:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb18-1" title="1"><span class="va">Foo</span>.<span class="at">addScope</span>(<span class="st">&#39;includeEverything&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-2" title="2">  <span class="dt">include</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-3" title="3">    <span class="dt">model</span><span class="op">:</span> Bar<span class="op">,</span></a>
<a class="sourceLine" id="cb18-4" title="4">    <span class="dt">include</span><span class="op">:</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb18-5" title="5">      <span class="dt">model</span><span class="op">:</span> Baz<span class="op">,</span></a>
<a class="sourceLine" id="cb18-6" title="6">      <span class="dt">include</span><span class="op">:</span> Qux</a>
<a class="sourceLine" id="cb18-7" title="7">    <span class="op">}</span>]</a>
<a class="sourceLine" id="cb18-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-10" title="10"></a>
<a class="sourceLine" id="cb18-11" title="11"><span class="va">Foo</span>.<span class="at">addScope</span>(<span class="st">&#39;limitedBars&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-12" title="12">  <span class="dt">include</span><span class="op">:</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb18-13" title="13">    <span class="dt">model</span><span class="op">:</span> Bar<span class="op">,</span></a>
<a class="sourceLine" id="cb18-14" title="14">    <span class="dt">limit</span><span class="op">:</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb18-15" title="15">  <span class="op">}</span>]</a>
<a class="sourceLine" id="cb18-16" title="16"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-17" title="17"></a>
<a class="sourceLine" id="cb18-18" title="18"><span class="va">Foo</span>.<span class="at">addScope</span>(<span class="st">&#39;limitedBazs&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-19" title="19">  <span class="dt">include</span><span class="op">:</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb18-20" title="20">    <span class="dt">model</span><span class="op">:</span> Bar<span class="op">,</span></a>
<a class="sourceLine" id="cb18-21" title="21">    <span class="dt">include</span><span class="op">:</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb18-22" title="22">      <span class="dt">model</span><span class="op">:</span> Baz<span class="op">,</span></a>
<a class="sourceLine" id="cb18-23" title="23">      <span class="dt">limit</span><span class="op">:</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb18-24" title="24">    <span class="op">}</span>]</a>
<a class="sourceLine" id="cb18-25" title="25">  <span class="op">}</span>]</a>
<a class="sourceLine" id="cb18-26" title="26"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-27" title="27"></a>
<a class="sourceLine" id="cb18-28" title="28"><span class="va">Foo</span>.<span class="at">addScope</span>(<span class="st">&#39;excludeBazName&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-29" title="29">  <span class="dt">include</span><span class="op">:</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb18-30" title="30">    <span class="dt">model</span><span class="op">:</span> Bar<span class="op">,</span></a>
<a class="sourceLine" id="cb18-31" title="31">    <span class="dt">include</span><span class="op">:</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb18-32" title="32">      <span class="dt">model</span><span class="op">:</span> Baz<span class="op">,</span></a>
<a class="sourceLine" id="cb18-33" title="33">      <span class="dt">attributes</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-34" title="34">        <span class="dt">exclude</span><span class="op">:</span> [<span class="st">&#39;name&#39;</span>]</a>
<a class="sourceLine" id="cb18-35" title="35">      <span class="op">}</span></a>
<a class="sourceLine" id="cb18-36" title="36">    <span class="op">}</span>]</a>
<a class="sourceLine" id="cb18-37" title="37">  <span class="op">}</span>]</a>
<a class="sourceLine" id="cb18-38" title="38"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>These four scopes can be deeply merged easily, for example by calling <code>Foo.scope('includeEverything', 'limitedBars', 'limitedBazs', 'excludeBazName').findAll()</code>, which would be entirely equivalent to calling the following:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb19-1" title="1"><span class="cf">await</span> <span class="va">Foo</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb19-2" title="2">  <span class="dt">include</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-3" title="3">    <span class="dt">model</span><span class="op">:</span> Bar<span class="op">,</span></a>
<a class="sourceLine" id="cb19-4" title="4">    <span class="dt">limit</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-5" title="5">    <span class="dt">include</span><span class="op">:</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb19-6" title="6">      <span class="dt">model</span><span class="op">:</span> Baz<span class="op">,</span></a>
<a class="sourceLine" id="cb19-7" title="7">      <span class="dt">limit</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-8" title="8">      <span class="dt">attributes</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-9" title="9">        <span class="dt">exclude</span><span class="op">:</span> [<span class="st">&#39;name&#39;</span>]</a>
<a class="sourceLine" id="cb19-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb19-11" title="11">      <span class="dt">include</span><span class="op">:</span> Qux</a>
<a class="sourceLine" id="cb19-12" title="12">    <span class="op">}</span>]</a>
<a class="sourceLine" id="cb19-13" title="13">  <span class="op">}</span></a>
<a class="sourceLine" id="cb19-14" title="14"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-15" title="15"></a>
<a class="sourceLine" id="cb19-16" title="16"><span class="co">// The above is equivalent to:</span></a>
<a class="sourceLine" id="cb19-17" title="17"><span class="cf">await</span> <span class="va">Foo</span>.<span class="at">scope</span>([</a>
<a class="sourceLine" id="cb19-18" title="18">  <span class="st">&#39;includeEverything&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-19" title="19">  <span class="st">&#39;limitedBars&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-20" title="20">  <span class="st">&#39;limitedBazs&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-21" title="21">  <span class="st">&#39;excludeBazName&#39;</span></a>
<a class="sourceLine" id="cb19-22" title="22">]).<span class="at">findAll</span>()<span class="op">;</span></a></code></pre></div>
<p>Observe how the four scopes were merged into one. The includes of scopes are merged based on the model being included. If one scope includes model A and another includes model B, the merged result will include both models A and B. On the other hand, if both scopes include the same model A, but with different options (such as nested includes or other attributes), those will be merged recursively, as shown above.</p>
<p>The merge illustrated above works in the exact same way regardless of the order applied to the scopes. The order would only make a difference if a certain option was set by two different scopes - which is not the case of the above example, since each scope does a different thing.</p>
<p>This merge strategy also works in the exact same way with options passed to <code>.findAll</code>, <code>.findOne</code> and the like.</p>
