<h1 id="sequelize-relationships-ultimate-guide">Sequelize relationships — Ultimate guide</h1>
<figure>
<img src="https://miro.medium.com/max/1622/1*fygqfizATFjt6ALek2W1jg.png" alt="Image for post" /><figcaption>Image for post</figcaption>
</figure>
<p>We will take as an example 3 models.<br />
- <strong>- Company</strong><br />
- <strong>- Employee</strong><br />
- <strong>- Working day</strong></p>
<ul>
<li>Employe has one company (belongsTo) 1:1<br />
</li>
<li>Company has many employees (hasMany) 1:n<br />
</li>
<li>Employe has many WorkingDay and WorkingDay has any employees (manyToMany) n:n</li>
</ul>
<p><strong>To create many to many relationship, we will need a joining table that we will call WorkingDaysEmploye</strong>.</p>
<p><code>npm install express-generator -g</code> <code>npm install -g sequelize-cli</code></p>
<p>Then we will generate a new app thanks to express and install the necessary libraries</p>
<p>express relationship-app-demo –no-view</p>
<p>cd relationship-app-demo</p>
<p>npm install –save sequelize mysql2</p>
<p>sequelize initThe last command will create 3 folders (Models, Migrations and Seeder) and a `config.json` file in the `/config` directory</p>
<p>We need to modify this file with your credentials to the local mysql server like this</p>
<p>after configuration you can run<br />
`sequelize db:create` to create a new database named `nodejs_relationship_demo`</p>
<p>now, we’re going to create all the models we’re going to need</p>
<p>sequelize model:generate –name Company –attributes name:STRINGsequelize model:generate –name User –attributes email:STRING,firstName:STRING,lastName:STRING,companyId:INTEGERsequelize model:generate –name WorkingDay –attributes weekDay:STRING,workingDate:DATE,isWorking:BOOLEANsequelize model:generate –name UsersWorkingDay –attributes userId:INTEGER,workingDayId:INTEGER</p>
<p>UsersWorkingDay will be used to join User and WorkingDay (many to many relationship).<br />
Now that we have generated the necessary templates, we will have to indicate the relationships in the migration files by adding a reference key on all foreign keys.<br />
I also added for each foreign key an AllowNull false to prevent creation if the model is not linked</p>
<p>You can then check with any database explorer that the tables are linked to each other.</p>
<figure>
<img src="https://miro.medium.com/max/60/1*ssd1pTPfoS7hbZT6HeL9mw.png?q=20" alt="Image for post" /><figcaption>Image for post</figcaption>
</figure>
<figure>
<img src="https://miro.medium.com/max/3084/1*ssd1pTPfoS7hbZT6HeL9mw.png" alt="Image for post" /><figcaption>Image for post</figcaption>
</figure>
<figure>
<img src="https://miro.medium.com/max/60/1*YkTCy483-pw-qNSnI6-63A.png?q=20" alt="Image for post" /><figcaption>Image for post</figcaption>
</figure>
<figure>
<img src="https://miro.medium.com/max/3084/1*YkTCy483-pw-qNSnI6-63A.png" alt="Image for post" /><figcaption>Image for post</figcaption>
</figure>
<p>The relationships being well defined on the mysql side, we will now have to explain to sequelize what the relationships are between our models</p>
<p>1:1</p>
<p>The first relationship is a User belongs to a Company, open the `models/user.js` and add the association line 10 like this :</p>
<p>Association line 10</p>
<p>1:N</p>
<p>Knowing that a company has several Users we can add the 1:n relationship in the Company model. I rename the user model using an alias (employes) for more clarity, I put this alias in the plural because the relationship is hasMany</p>
<p>Association line 7</p>
<p>N:N</p>
<p>Finally, there is only one relationship left to manage and probably the most difficult. For this, we will need to describe the association in the 3 files concerned. (user.js, workingday.js, usersworkingday.js)</p>
<p>N:N relationship need a joining table (here UsersWorkingDays)</p>
<p>And that’s it, we configured the database and the sequelize models with the 3 types of relationships. It may seem simple after all, but before that, long hours of research were needed.</p>
<p>The last thing to do once the configuration is finished, is to test the relationships between them to make sure that everything works as you want it to.<br />
For that, I create a new test file that I will delete later</p>
<p>touch relationshipTester.js</p>
<p>First, import all the models we need</p>
<p>The first registration we will need is Company, so let’s start by creating a new company.</p>
<p>Company creation</p>
<p>Now, we will create 3 Users (employees) linked to this company</p>
<p>Users (employees) creation</p>
<p>Let’s see now if we can recover a company from an User and Users from a Company</p>
<p>Test belongsTo and hasMany relationship</p>
<p>Everything here is perfect! All that remains is to test the many to many relationship in this way.<br />
Let’s start by creating 3 working days</p>
<p>WorkingDays creation and Users (employees) associations</p>
<p>Finally, we want to be able to retrieve the list of employees for a given work day, but also to know the work days of a given employee.</p>
<p>First I would like to apologize for the horror mistake that is in the code, I realized when writing this article that in English employee to take two ‘e’. (sorry, I’m French)</p>
<p>I would then say that what we need to remember is that when associating in models, it is a good practice to use aliases (as:) because sequelize pluralizes the name of models and it can sometimes bring surprises, by using aliases, you rename the associations which then allows you to use this alias in include. Sequelize also create functions for each association, we also use aliases in singular or plural to call these functions. The list is available <a href="http://docs.sequelizejs.com/manual/tutorial/associations.html">here in the documentation</a>.</p>
<p>Finally, during an belongsToMany association it is not mandatory but specifying the foreign key ensures a good connection. It also happened to me that Sequelize does not associate the model with the right table if it happens to you, you can specify a classname in the second parameter of the model definition.</p>
<p>David MARIE<br />
Full stack web developer<br />
Ruby, Node and React specialist.<br />
https://dmkreation.com</p>
<p><a href="https://medium.com/@eth3rnit3/sequelize-relationships-ultimate-guide-f26801a75554">Source</a></p>
