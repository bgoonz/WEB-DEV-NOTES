<h1 id="week-10-day-4-sequelize-orm" data-ignore="true">WEEK-10 DAY-4<br><em>Sequelize ORM</em></h1>
<hr />
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=2 orderedList=false} -->
<!-- code_chunk_output -->
<ul>
<li><a href="#week-10-day-4brsequelize-orm">WEEK-10 DAY-4<br><em>Sequelize ORM</em> {ignore=true}</a></li>
<li><a href="#installing-and-using-sequelize">Installing And Using Sequelize</a>
<ul>
<li><a href="#what-is-an-orm">What Is An ORM?</a></li>
<li><a href="#how-to-install-sequelize">How To Install Sequelize</a></li>
<li><a href="#how-to-initialize-sequelize">How To Initialize Sequelize</a></li>
<li><a href="#verifying-that-sequelize-can-connect-to-the-database">Verifying That Sequelize Can Connect To The Database</a></li>
<li><a href="#our-preexisting-database-schema">Our Preexisting Database Schema</a></li>
<li><a href="#using-sequelize-to-generate-the-model-file">Using Sequelize To Generate The Model File</a></li>
<li><a href="#examining-and-modifying-a-sequelize-model-file">Examining (And Modifying) A Sequelize Model File</a></li>
<li><a href="#using-the-cat-model-to-fetch-and-update-sql-data">Using The <code>Cat</code> Model To Fetch And Update SQL Data</a></li>
<li><a href="#reading-and-changing-record-attributes">Reading And Changing Record Attributes</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul></li>
<li><a href="#using-database-migrations">Using Database Migrations</a>
<ul>
<li><a href="#sequelize-migration-files">Sequelize Migration Files</a></li>
<li><a href="#running-a-migration">Running A Migration</a></li>
<li><a href="#rolling-back-a-migration">Rolling Back A Migration</a></li>
<li><a href="#editing-a-migration-file">Editing A Migration File</a></li>
<li><a href="#up-and-down-are-asynchronous"><code>up</code> And <code>down</code> are Asynchronous</a></li>
<li><a href="#writing-a-down-method">Writing A <code>down</code> Method</a></li>
<li><a href="#advantages-of-migrations">Advantages Of Migrations</a></li>
<li><a href="#conclusion-1">Conclusion</a></li>
</ul></li>
<li><a href="#crud-operations-using-sequelize">CRUD Operations Using Sequelize</a>
<ul>
<li><a href="#creating-a-new-record">Creating A New Record</a></li>
<li><a href="#reading-a-record-by-primary-key">Reading A Record By Primary Key</a></li>
<li><a href="#updating-a-record">Updating A Record</a></li>
<li><a href="#destroying-a-record">Destroying A Record</a></li>
<li><a href="#class-methods-for-crud">Class Methods For CRUD</a></li>
<li><a href="#conclusion-2">Conclusion</a></li>
</ul></li>
<li><a href="#querying-using-sequelize">Querying Using Sequelize</a>
<ul>
<li><a href="#basic-usage-of-findall-to-retrieve-multiple-records">Basic Usage Of <code>findAll</code> To Retrieve Multiple Records</a></li>
<li><a href="#using-findall-to-find-objects-not-matching-a-criterion">Using <code>findAll</code> To Find Objects Not Matching A Criterion</a></li>
<li><a href="#combining-criteria-with-opand">Combining Criteria with <code>Op.and</code></a></li>
<li><a href="#combining-criteria-with-opor">Combining Criteria with <code>Op.or</code></a></li>
<li><a href="#querying-with-comparisons">Querying With Comparisons</a></li>
<li><a href="#ordering-results">Ordering Results</a></li>
<li><a href="#limiting-results-and-findone">Limiting Results and <code>findOne</code></a></li>
<li><a href="#conclusion-3">Conclusion</a></li>
</ul></li>
<li><a href="#model-validations-with-sequelize">Model Validations With Sequelize</a>
<ul>
<li><a href="#validating-that-an-attribute-is-not-null">Validating That An Attribute Is Not <code>NULL</code></a></li>
<li><a href="#the-notempty-validation">The <code>notEmpty</code> Validation</a></li>
<li><a href="#forbidding-long-string-values">Forbidding Long String Values</a></li>
<li><a href="#validating-that-a-numeric-value-is-within-a-specified-range">Validating That A Numeric Value Is Within A Specified Range</a></li>
<li><a href="#validating-that-an-attribute-is-among-a-finite-set-of-values">Validating That An Attribute Is Among A Finite Set Of Values</a></li>
<li><a href="#conclusion-4">Conclusion</a></li>
</ul></li>
<li><a href="#recipe-box-with-sequelize-project">Recipe Box With Sequelize Project</a>
<ul>
<li><a href="#the-data-model-analysis">The data model analysis</a></li>
<li><a href="#the-application">The application</a></li>
<li><a href="#getting-started">Getting started</a></li>
<li><a href="#your-code">Your code</a></li>
<li><a href="#phase-1-initialize-the-sequelize-project">Phase 1: Initialize the Sequelize project</a></li>
<li><a href="#phase-2-create-a-database-user-for-the-project">Phase 2: Create a database user for the project</a></li>
<li><a href="#phase-2-change-the-connection-configuration">Phase 2: Change the connection configuration</a></li>
<li><a href="#phase-3-create-your-database">Phase 3: Create your database</a></li>
<li><a href="#phase-4-the-units-of-measurement-data">Phase 4: The units of measurement data</a>
<ul>
<li><a href="#create-a-migration">Create a migration</a></li>
</ul></li>
<li><a href="#run-your-migration">Run your migration</a></li>
<li><a href="#create-the-seed-data">Create the seed data</a></li>
<li><a href="#phase-5-the-recipe-table-model">Phase 5: The recipe table model</a></li>
<li><a href="#phase-6-the-instruction-table-model">Phase 6: The instruction table model</a></li>
<li><a href="#phase-7-the-ingredients-model">Phase 7: The ingredients model</a></li>
<li><a href="#phase-8-seed-data-for-all-of-the-tables">Phase 8: Seed data for all of the tables</a></li>
<li><a href="#phase-9-updating-models-with-references">Phase 9: Updating models with references</a></li>
<li><a href="#phase-10-updating-models-with-validations">Phase 10: Updating models with validations</a></li>
<li><a href="#phase-11-cascade-delete-for-recipes">Phase 11: Cascade delete for recipes</a></li>
<li><a href="#phase-12-building-the-repositories">Phase 12: Building the repositories</a></li>
</ul></li>
</ul>
<!-- /code_chunk_output -->
<hr />
<hr />
<h1 id="installing-and-using-sequelize">Installing And Using Sequelize</h1>
<p>Now that you have gained experience with SQL, it is time to learn how to access data stored in a SQL database using a JavaScript program. You will use a JavaScript library called Sequelize to do this. Sequelize is an example of an <em>Object Relational Mapping</em> (commonly abbreviated <em>ORM</em>). An ORM allows a JavaScript programmer to fetch and store data in a SQL database using JavaScript functions instead of writing SQL code.</p>
<p>When you finish this reading you will be able to:</p>
<ul>
<li>Describe what an Object Relational Mapping is and what it is used for.</li>
<li>Install and configure the packages needed to use Sequelize.</li>
<li>Use Sequelize to generate JavaScript code that fetches and stores data in a SQL database.</li>
<li>Use those auto-generated methods to fetch and store data in a SQL database.</li>
</ul>
<h2 id="what-is-an-orm">What Is An ORM?</h2>
<p>An <em>Object Relational Mapping</em> is a library that allows you to access data stored in a SQL database through object-oriented, non-SQL code (such as JavaScript). You will write <em>object-oriented</em> code that accesses data stored in a <em>relational</em> SQL database like Postgres. The ORM is the <em>mapping</em> that will “translate” your object-oriented code into SQL code that the database can run. The ORM will automatically generate SQL code for common tasks like fetching and storing data.</p>
<p>You will learn how to use the <a href="https://sequelize.org/v5/">Sequelize ORM</a>. Sequelize is the most widely used JavaScript ORM library.</p>
<h2 id="how-to-install-sequelize">How To Install Sequelize</h2>
<p>After creating a new node project with <code>npm init</code> we are ready to install the Sequelize library.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">npm</span> install sequelize@^5.0.0</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ex">npm</span> install sequelize-cli@^5.0.0</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ex">npm</span> install pg@^8.0.0</a></code></pre></div>
<p>We have installed not only the Sequelize library, but also a command line tool called <code>sequelize-cli</code> that will help us auto-generate and manage JavaScript files which will hold our Sequelize ORM code.</p>
<p>Last, we have also installed the pg library. This library allows Sequelize to access a Postgres database. If you were using a different database software (such as MySQL), you would need to install a different library.</p>
<h2 id="how-to-initialize-sequelize">How To Initialize Sequelize</h2>
<p>We can run the command <code>npx sequelize init</code> to automatically setup the following directory structure for our project:</p>
<pre><code>.
├── config
│   └── config.json
├── migrations
├── models
│   └── index.js
├── node_modules
├── package-lock.json
├── package.json
└── seeders</code></pre>
<blockquote>
<p>Aside: the <code>npx</code> tool allows you to easily run scripts provided by packages like <code>sequelize-cli</code>. If you don’t already have <code>npx</code>, you can install it with <code>npm install npx --global</code>. Without <code>npx</code> you would have to run the bash command: <code>./node_modules/.bin/sequelize init</code>. This directly runs the <code>sequelize</code> script provided by the installed <code>sequelize-cli</code> package.</p>
</blockquote>
<p>Having run <code>npx sequelize init</code>, we must write our database login information into <code>config/config.json</code>.</p>
<p>By default this file contains different sections we call “environments”. In a typical company you will have different database servers and configuration depending on where you app is running. Development is usually where you do your development work. In our case this is our local computer. But test might be and environment where you run tests, and production is the environment where real users are interacting with your application.</p>
<p>Since we are doing development, we can just modify the “development” section to look like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb3-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="dt">&quot;development&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="dt">&quot;username&quot;</span><span class="fu">:</span> <span class="st">&quot;catsdbuser&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="dt">&quot;password&quot;</span><span class="fu">:</span> <span class="st">&quot;catsdbpassword&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="dt">&quot;database&quot;</span><span class="fu">:</span> <span class="st">&quot;catsdb&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="dt">&quot;host&quot;</span><span class="fu">:</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb3-7" title="7">    <span class="dt">&quot;dialect&quot;</span><span class="fu">:</span> <span class="st">&quot;postgres&quot;</span></a>
<a class="sourceLine" id="cb3-8" title="8">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="fu">}</span><span class="er">...</span></a></code></pre></div>
<p>Here we are supposing that we have already created a <code>catsdb</code> database owned by the user <code>catsdbuser</code>, with password <code>catsdbpassword</code>. By setting <code>host</code> to <code>127.0.0.1</code>, we are saying that the database will run on the same machine as my JavaScript application. Last, we specify that we are using a <code>postgres</code> database.</p>
<h2 id="verifying-that-sequelize-can-connect-to-the-database">Verifying That Sequelize Can Connect To The Database</h2>
<p>At the top level of our project, we should create an <code>index.js</code> file. From this file we will verify that Sequelize can connect to the SQL database. To do this, we use the <code>authenticate</code> method of the sequelize object.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// ./index.js</span></a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">const</span> <span class="op">{</span> sequelize <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-7" title="7">    <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">authenticate</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb4-8" title="8">  <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-9" title="9">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Database connection failure.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-10" title="10">    <span class="va">console</span>.<span class="at">log</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-11" title="11">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-12" title="12">  <span class="op">}</span></a>
<a class="sourceLine" id="cb4-13" title="13"></a>
<a class="sourceLine" id="cb4-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Database connection success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-15" title="15">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Sequelize is ready to use!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-16" title="16"></a>
<a class="sourceLine" id="cb4-17" title="17">  <span class="co">// Close database connection when done with it.</span></a>
<a class="sourceLine" id="cb4-18" title="18">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb4-19" title="19"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-20" title="20"></a>
<a class="sourceLine" id="cb4-21" title="21"><span class="at">main</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb4-22" title="22"></a>
<a class="sourceLine" id="cb4-23" title="23"><span class="co">// Prints:</span></a>
<a class="sourceLine" id="cb4-24" title="24"><span class="co">//</span></a>
<a class="sourceLine" id="cb4-25" title="25"><span class="co">// Executing (default): SELECT 1+1 AS result</span></a>
<a class="sourceLine" id="cb4-26" title="26"><span class="co">// Database connection success!</span></a>
<a class="sourceLine" id="cb4-27" title="27"><span class="co">// Sequelize is ready to use!</span></a></code></pre></div>
<p>You may observe that the <code>authenticate</code> method returns a JavaScript <code>Promise</code> object. We use <code>await</code> to wait for the database connection to be established. If <code>authenticate</code> fails to connect, the <code>Promise</code> will be rejected. Since we use <code>await</code>, an exception will be thrown.</p>
<p>Many Sequelize methods return <code>Promise</code>s. Using <code>async</code> and <code>await</code> lets us use Sequelize methods as if they were synchronous. This helps reduce code complexity significantly.</p>
<p>Note that I call <code>sequelize.close()</code>. This closes the connection to the database. A Node.js JavaScript program will not terminate until all open files and database connections are closed. Thus, to make sure the Node.js program doesn’t “hang” at the end, we close the database connection. Otherwise we will be forced to kill the Node.js program with <code>CTRL-C</code>, which is somewhat annoying.</p>
<h2 id="our-preexisting-database-schema">Our Preexisting Database Schema</h2>
<p>We are assuming that we are working with a preexisting SQL database. Our <code>catsdb</code> has a single table: <code>Cats</code>. Using the <code>psql</code> command-line program, we can describe the pre-existing <code>Cats</code> table below.</p>
<pre><code>catsdb=&gt; \d &quot;Cats&quot;
                                         Table &quot;public.Cats&quot;
    Column    |           Type           | Collation | Nullable |              Default
--------------+--------------------------+-----------+----------+------------------------------------
 id           | integer                  |           | not null | nextval(&#39;&quot;Cats_id_seq&quot;&#39;::regclass)
 firstName    | character varying(255)   |           |          |
 specialSkill | character varying(255)   |           |          |
 age          | integer                  |           |          |
 createdAt    | timestamp with time zone |           | not null |
 updatedAt    | timestamp with time zone |           | not null |
Indexes:
    &quot;Cats_pkey&quot; PRIMARY KEY, btree (id)</code></pre>
<p>Besides a primary key <code>id</code>, each <code>Cats</code> record has a <code>firstName</code>, a <code>specialSkill</code>, and an <code>age</code>. Each record also keeps track of two timestamps: the time when the cat was created (<code>createdAt</code>), and the most recent time when a column of the cat has been updated (<code>updatedAt</code>).</p>
<h2 id="using-sequelize-to-generate-the-model-file">Using Sequelize To Generate The Model File</h2>
<p>We will configure Sequelize to access the <code>Cats</code> table via a JavaScript class called <code>Cat</code>. To do this, we first use our trusty Sequelize CLI:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># Oops, forgot age:integer! (Don&#39;t worry we&#39;ll fix it later)</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="ex">npx</span> sequelize model:generate --name Cat --attributes <span class="st">&quot;firstName:string,specialSkill:string&quot;</span></a></code></pre></div>
<p>This command generates two files: a <em>model</em> file (<code>./models/cat.js</code>) and a <em>migration</em> file (<code>./migrations/20200203211508-Cat.js</code>). We will ignore the migration file for now, and focus on the model file.</p>
<p>When using Sequelize’s <code>model:generate</code> command, we specify two things. First: we specify the <em>singular</em> form of the <code>Cats</code> table name (<code>Cat</code>). Second: we list the columns of the <code>Cats</code> table after the <code>--attributes</code> flag: <code>firstName</code> and <code>specialSkill</code>. We tell Sequelize that these are both <code>string</code> columns (Sequelize calls SQL <code>character varying(255)</code> columns <code>string</code>s).</p>
<p>We do not need to list <code>id</code>, <code>createdAt</code>, or <code>updatedAt</code>. Sequelize will always presume those exist. Notice that we have <strong>forgotten</strong> to list <code>age:integer</code> – we will fix that soon!</p>
<h2 id="examining-and-modifying-a-sequelize-model-file">Examining (And Modifying) A Sequelize Model File</h2>
<p>Let us examine the generated <code>./models/cat.js</code> file:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-5" title="5">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-6" title="6">    <span class="dt">firstName</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb7-8" title="8">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-9" title="9">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-10" title="10">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb7-11" title="11">  <span class="op">};</span></a>
<a class="sourceLine" id="cb7-12" title="12">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb7-13" title="13"><span class="op">};</span></a></code></pre></div>
<p>This file exports a function that defines a <code>Cat</code> class. When you use <code>Sequelize</code> to query the <code>Cats</code> table, each row retrieved will be transformed by Sequelize into an instance of the <code>Cat</code> class. A JavaScript class like <code>Cat</code> that corresponds to a SQL table is called a <em>model</em> class.</p>
<p>The <code>./models/cat.js</code> will not be loaded by us directly. Sequelize will load this file and call the exported function to define the <code>Cat</code> class. The exported function uses Sequelize’s <code>define</code> method to auto-generate a new class (called <code>Cat</code>).</p>
<blockquote>
<p>Note: You may notice we aren’t using the JavaScript’s <code>class</code> keyword to define the Cat class. With Sequelize, it is going to do all that for us with the <code>define</code> method. This is because Sequelize was around way before the <code>class</code> keyword was added to JavaScript. It is possible to use the class keyword with Sequelize, but it’s <a href="https://codewithhugo.com/using-es6-classes-for-sequelize-4-models/">undocumented</a>.</p>
</blockquote>
<p>The first argument of <code>define</code> is the name of the class to define: <code>Cat</code>. Notice how the second argument is an <code>Object</code> of <code>Cats</code> table columns:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb8-2" title="2">    <span class="dt">firstName</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="op">}</span></a></code></pre></div>
<p>This object tells Sequelize about each of the columns of <code>Cats</code>. It maps each column name (<code>firstName</code>, <code>specialSkill</code>) to the type of data stored in the corresponding column of the <code>Cats</code> table. It is unnecessary to list <code>id</code>, <code>createdAt</code>, <code>updatedAt</code>, since Sequelize will already assume those exist.</p>
<p>We can correct our earlier mistake of forgetting <code>age</code>. We update the definition as so:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-2" title="2">  <span class="dt">firstName</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-3" title="3">  <span class="dt">specialSkill</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-4" title="4">  <span class="dt">age</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a></code></pre></div>
<p>A complete list of Sequelize datatypes can be found in the <a href="https://sequelize.org/v5/manual/data-types.html">documentation</a>.</p>
<h2 id="using-the-cat-model-to-fetch-and-update-sql-data">Using The <code>Cat</code> Model To Fetch And Update SQL Data</h2>
<p>We are now ready to use our <code>Cat</code> model class. When Sequelize defines the <code>Cat</code> class, it will generate instance and class methods needed to interact with the <code>Cats</code> SQL table.</p>
<p>As we mentioned before we don’t require our <code>cats.js</code> file directly. Instead we require <code>./models</code> which loads the file <code>./models/index.js</code>.</p>
<p>Inside this file it reads through all our models and attaches them to an object that it exports. So we can use destructuring to get a reference to our model class <code>Cat</code> like so:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a></code></pre></div>
<p>Now let’s update <em>our</em> <code>index.js</code> file to fetch a <code>Cat</code> from the <code>Cats</code> table:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize <span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-2" title="2"></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-5" title="5">    <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">authenticate</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-6" title="6">  <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-7" title="7">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Database connection failure.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-8" title="8">    <span class="va">console</span>.<span class="at">log</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-9" title="9">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-10" title="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-11" title="11"></a>
<a class="sourceLine" id="cb11-12" title="12">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Database connection success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-13" title="13">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Sequelize is ready to use!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-14" title="14"></a>
<a class="sourceLine" id="cb11-15" title="15">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-16" title="16">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb11-17" title="17"></a>
<a class="sourceLine" id="cb11-18" title="18">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-19" title="19"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-20" title="20"></a>
<a class="sourceLine" id="cb11-21" title="21"><span class="at">main</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-22" title="22"></a>
<a class="sourceLine" id="cb11-23" title="23"><span class="co">// This code prints:</span></a>
<a class="sourceLine" id="cb11-24" title="24"><span class="co">//</span></a>
<a class="sourceLine" id="cb11-25" title="25"><span class="co">// Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;</span></a>
<a class="sourceLine" id="cb11-26" title="26"><span class="co">// {</span></a>
<a class="sourceLine" id="cb11-27" title="27"><span class="co">//   id: 1,</span></a>
<a class="sourceLine" id="cb11-28" title="28"><span class="co">//   firstName: &#39;Markov&#39;,</span></a>
<a class="sourceLine" id="cb11-29" title="29"><span class="co">//   specialSkill: &#39;sleeping&#39;,</span></a>
<a class="sourceLine" id="cb11-30" title="30"><span class="co">//   age: 5,</span></a>
<a class="sourceLine" id="cb11-31" title="31"><span class="co">//   createdAt: 2020-02-03T21:32:28.960Z,</span></a>
<a class="sourceLine" id="cb11-32" title="32"><span class="co">//   updatedAt: 2020-02-03T21:32:28.960Z</span></a>
<a class="sourceLine" id="cb11-33" title="33"><span class="co">// }</span></a></code></pre></div>
<p>We use the <code>Cat.findByPk</code> static class method to fetch a single cat: the one with <code>id</code> equal to 1. This static method exists because our <code>Cat</code> model class <em>extends</em> <code>Sequelize.Model</code>.</p>
<p>“Pk” stands for <em>primary key</em>; the <code>id</code> field is the primary key for the <code>Cats</code> table. <code>findByPk</code> returns a <code>Promise</code>, so we must <code>await</code> the result. The result is an instance of the <code>Cat</code> model class.</p>
<p>The cleanest way to log a fetched database record is to first call the <code>toJSON</code> method. <code>toJSON</code> converts a <code>Cat</code> object to a <em>Plain Old JavaScript Object</em> (POJO). <code>Cat</code> instances have many private variables and methods that can be distracting when printed. When you call <code>toJSON</code>, only the public data fields are copied into a JavaScript <code>Object</code>. Printing this raw JavaScript <code>Object</code> is thus much cleaner.</p>
<blockquote>
<p>The author has a pet-peeve about the <code>.toJSON()</code> method of Sequelize, it does not return JSON. It instead returns a POJO. If you needed it to be JSON you would still need to call <code>JSON.stringify(cat.toJSON())</code>. Perhaps they should have called it <code>.toObject</code> or <code>.toPOJO</code> instead.</p>
</blockquote>
<p>Note that Sequelize has logged the SQL query it ran to fetch Markov’s information. This logging information is often helpful when trying to figure out what Sequelize is doing.</p>
<p>You’ll also notice that Sequelize puts double quotes around the table and field names. So if you are trying to look at your “Cats” table from the <code>psql</code> command you will need to quote them there as well. This is because PostgreSQL lowercases all identifiers like table and fields names before the query is run if they aren’t quoted.</p>
<h2 id="reading-and-changing-record-attributes">Reading And Changing Record Attributes</h2>
<p>While <code>toJSON</code> is useful for logging a <code>Cat</code> object, it is not the simplest way to access individual column values. To read the <code>id</code>, <code>firstName</code>, etc of a <code>Cat</code>, you can directly access those attributes on the <code>Cat</code> instance itself:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="co">// Sequelize authentication code from above...</span></a>
<a class="sourceLine" id="cb12-3" title="3"></a>
<a class="sourceLine" id="cb12-4" title="4">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-5" title="5">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`</span><span class="sc">${</span><span class="va">cat</span>.<span class="at">firstName</span><span class="sc">}</span><span class="vs"> has been assigned id #</span><span class="sc">${</span><span class="va">cat</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-6" title="6">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`They are </span><span class="sc">${</span><span class="va">cat</span>.<span class="at">age</span><span class="sc">}</span><span class="vs"> years old.`</span>)</a>
<a class="sourceLine" id="cb12-7" title="7">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Their special skill is </span><span class="sc">${</span><span class="va">cat</span>.<span class="at">specialSkill</span><span class="sc">}</span><span class="vs">.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-8" title="8"></a>
<a class="sourceLine" id="cb12-9" title="9">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb12-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb12-11" title="11"></a>
<a class="sourceLine" id="cb12-12" title="12"><span class="at">main</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb12-13" title="13"></a>
<a class="sourceLine" id="cb12-14" title="14"><span class="co">// This code prints:</span></a>
<a class="sourceLine" id="cb12-15" title="15"><span class="co">//</span></a>
<a class="sourceLine" id="cb12-16" title="16"><span class="co">// Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;</span></a>
<a class="sourceLine" id="cb12-17" title="17"><span class="co">// Markov has been assigned id #1.</span></a>
<a class="sourceLine" id="cb12-18" title="18"><span class="co">// They are 5 years old.</span></a>
<a class="sourceLine" id="cb12-19" title="19"><span class="co">// Their special skill is sleeping.</span></a></code></pre></div>
<p>Accessing data directly through the <code>Cat</code> object is just like reading an attribute on any other JavaScript class. You may likewise <em>change</em> values in the database:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="co">// Sequelize authentication code from above...</span></a>
<a class="sourceLine" id="cb13-3" title="3"></a>
<a class="sourceLine" id="cb13-4" title="4">  <span class="co">// Fetch existing cat from database.</span></a>
<a class="sourceLine" id="cb13-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-6" title="6">  <span class="co">// Change cat&#39;s attributes.</span></a>
<a class="sourceLine" id="cb13-7" title="7">  <span class="va">cat</span>.<span class="at">firstName</span> <span class="op">=</span> <span class="st">&quot;Curie&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb13-8" title="8">  <span class="va">cat</span>.<span class="at">specialSkill</span> <span class="op">=</span> <span class="st">&quot;jumping&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb13-9" title="9">  <span class="va">cat</span>.<span class="at">age</span> <span class="op">=</span> <span class="dv">123</span><span class="op">;</span></a>
<a class="sourceLine" id="cb13-10" title="10"></a>
<a class="sourceLine" id="cb13-11" title="11">  <span class="co">// Save the new name to the database.</span></a>
<a class="sourceLine" id="cb13-12" title="12">  <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb13-13" title="13"></a>
<a class="sourceLine" id="cb13-14" title="14">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb13-15" title="15"><span class="op">}</span></a>
<a class="sourceLine" id="cb13-16" title="16"></a>
<a class="sourceLine" id="cb13-17" title="17"><span class="co">// Prints:</span></a>
<a class="sourceLine" id="cb13-18" title="18"><span class="co">//</span></a>
<a class="sourceLine" id="cb13-19" title="19"><span class="co">// Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;</span></a>
<a class="sourceLine" id="cb13-20" title="20"><span class="co">// Executing (default): UPDATE &quot;Cats&quot; SET &quot;firstName&quot;=$1,&quot;specialSkill&quot;=$2,&quot;age&quot;=$3,&quot;updatedAt&quot;=$4 WHERE &quot;id&quot; = $5</span></a>
<a class="sourceLine" id="cb13-21" title="21"></a>
<a class="sourceLine" id="cb13-22" title="22"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Note that changing the <code>firstName</code> attribute value does not immediately change the stored value in the SQL database. Changing the <code>firstName</code> without calling <code>save</code> <strong>has no effect</strong> on the database. Only when we call <code>cat.save()</code> (and <code>await</code> the promise to resolve) will the changes to <code>firstName</code>, <code>specialSkill</code>, and <code>age</code> be saved to the SQL database. All these values are updated simultaneously.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Having completed this reading, you should be able to:</p>
<ul>
<li>Describe what an Object Relational Mapping is and what it is used for.</li>
<li>Install the <code>sequelize</code>, <code>sequelize-cli</code>, <code>pg</code> packages.</li>
<li>Configure Sequelize via the <code>config/config.json</code> file.</li>
<li>Use Sequelize’s <code>authenticate</code> method to verify that Sequelize can connect to the database.</li>
<li>Use the Sequelize CLI <code>model:generate</code> command to generate a model file.</li>
<li>Configure a model file to tell Sequelize about each database column.</li>
<li>Use the <code>findByPk</code> class method to fetch data from a SQL table.</li>
<li>Read data attributes from a model instance.</li>
<li>Modify a model instance’s attributes and save the changes back to the SQL database using the <code>save</code> method.</li>
</ul>
<hr />
<h1 id="using-database-migrations">Using Database Migrations</h1>
<p>We’ve seen how to use an ORM like Sequelize to fetch and store data in a SQL database using JavaScript classes and methods. Sequelize also lets you write JavaScript code that creates, modifies, or drops SQL tables. The JavaScript code that does this is called a <em>migration</em>. A migration “moves” the database from an old schema to a new schema.</p>
<p>When you finish this reading you will be able to:</p>
<ul>
<li>Describe advantages to using migrations over raw SQL commands to create and drop tables.</li>
<li>Write migrations that create and drop tables.</li>
<li>Undo incorrect migrations, fix them, and rerun them.</li>
</ul>
<h2 id="sequelize-migration-files">Sequelize Migration Files</h2>
<p>In the prior reading we assumed that a <code>Cats</code> table already existed in our <code>catsdb</code> database. In this reading, we will presume that the <code>Cats</code> table does not exist, and that we have to create the table ourselves. This is the typical case when you aren’t merely interacting with a preexisting database. When you develop your own application, the database will start out empty and with a blank schema.</p>
<p>We previously used the Sequelize CLI tool to autogenerate a <code>Cat</code> model file like so:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" title="1"><span class="co"># Oops, forgot age:integer!</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="ex">npx</span> sequelize model:generate --name Cat --attributes <span class="st">&quot;firstName:string,specialSkill:string&quot;</span></a></code></pre></div>
<p>We noted that this creates <em>two</em> files. We’ve already examined the model file <code>./models/cat.js</code>. We will now look at the auto-generated <em>migration</em> file <code>./migrations/20200203211508-create-cat.js</code>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" title="1"><span class="co">// ./migrations/20200203211508-create-cat.js</span></a>
<a class="sourceLine" id="cb15-2" title="2"></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-5" title="5">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-6" title="6">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Cats&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-7" title="7">      <span class="dt">id</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-8" title="8">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb15-9" title="9">        <span class="dt">autoIncrement</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb15-10" title="10">        <span class="dt">primaryKey</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb15-11" title="11">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb15-12" title="12">      <span class="op">},</span></a>
<a class="sourceLine" id="cb15-13" title="13">      <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-14" title="14">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb15-15" title="15">      <span class="op">},</span></a>
<a class="sourceLine" id="cb15-16" title="16">      <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-17" title="17">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb15-18" title="18">      <span class="op">},</span></a>
<a class="sourceLine" id="cb15-19" title="19">      <span class="dt">createdAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-20" title="20">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb15-21" title="21">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb15-22" title="22">      <span class="op">},</span></a>
<a class="sourceLine" id="cb15-23" title="23">      <span class="dt">updatedAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-24" title="24">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb15-25" title="25">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb15-26" title="26">      <span class="op">}</span></a>
<a class="sourceLine" id="cb15-27" title="27">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-28" title="28">  <span class="op">},</span></a>
<a class="sourceLine" id="cb15-29" title="29">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-30" title="30">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&#39;Cats&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-31" title="31">  <span class="op">}</span></a>
<a class="sourceLine" id="cb15-32" title="32"><span class="op">};</span></a></code></pre></div>
<p>The migration file exports two functions: <code>up</code> and <code>down</code>. The <code>up</code> function tells Sequelize how to create a <code>Cats</code> table. The <code>down</code> function tells Sequelize how to “undo” the <code>up</code> function. The <code>down</code> function drops the <code>Cats</code> table.</p>
<p>We will examine these functions more closely, but let’s first see how to use a migration.</p>
<blockquote>
<p>Note: The timestamp <code>20200203211508</code> preceding <code>-create-cat.js</code> represents February 2, 2020. It gives the time and day that the migration was generated. (Your date should be when you generated your migration) By using the date and time as part of the filename, all migration files will have unique names. Also, alphabetical sorting will order the files from oldest to most recent migration.</p>
</blockquote>
<h2 id="running-a-migration">Running A Migration</h2>
<p>To create the <code>Cats</code> table, we must run our migration code. Having generated the <code>20200203211508-create-cat.js</code> migration file, we will use the Sequelize CLI tool to run the migration. We may do this like so:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" title="1"><span class="co"># Run the migration&#39;s `up` method.</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="ex">npx</span> sequelize db:migrate</a></code></pre></div>
<p>By giving Sequelize the <code>db:migrate</code> subcommand, it will know that we are asking it to run any new migrations. To run a migration, Sequelize will call the <code>up</code> method defined in the migration file. The <code>up</code> method will run the necessary <code>CREATE TABLE ...</code> SQL command for us. Sequelize will record (in a special <code>catsdb</code> table called <code>SequelizeMeta</code>) that the migration has been run. The next time we call <code>npx sequelize db:migrate</code>, Sequelize will not try to “redo” this already performed migration. It will do nothing the second time.</p>
<p>Having run the migration, we can verify that the <code>Cats</code> table looks like it should (with the exception of the <code>age</code> column):</p>
<p>Note that we we are using the table name in quotes here in <code>psql</code>.</p>
<pre><code>catsdb=&gt; \d &quot;Cats&quot;;
                                         Table &quot;public.Cats&quot;
    Column    |           Type           | Collation | Nullable
--------------+--------------------------+-----------+----------
 id           | integer                  |           | not null
 firstName    | character varying(255)   |           |
 specialSkill | character varying(255)   |           |
 createdAt    | timestamp with time zone |           | not null
 updatedAt    | timestamp with time zone |           | not null
Indexes:
    &quot;Cats_pkey&quot; PRIMARY KEY, btree (id)</code></pre>
<h2 id="rolling-back-a-migration">Rolling Back A Migration</h2>
<p>We made a mistake when generating our <code>Cat</code> migration. We forgot to include the <code>age</code> column.</p>
<p>One way to fix this is to generate a <em>second</em> migration that adds the forgotten <code>age</code> column. If we have already pushed our migration code to a remote git server, we should opt for this option.</p>
<p>If the migration has not yet been pushed, we can fix the migration directly. We will “undo” (AKA <em>rollback</em>) the migration that created the <code>Cats</code> table (dropping the table), fix the <code>up</code> method so that the <code>age</code> column is included, and finally rerun the migration.</p>
<blockquote>
<p>Note: this is not the same as the SQL command ROLLBACK.</p>
</blockquote>
<p>To undo the migration, we run:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb18-1" title="1"><span class="ex">npx</span> sequelize db:migrate:undo</a></code></pre></div>
<p>Sequelize will call the <code>down</code> method for us, and the <code>Cats</code> table is dropped.</p>
<p>Why should you not use the <code>db:migrate:undo</code> way when the migration file has already been pushed to a remote git server? The reason is this: you can easily tell other developers to fix a broken migration by writing a second fixup migration (for instance, that adds the <code>age</code> column). All you need to do is check this new migration file into source control and push it. When another developer pulls your new migration code, the next time they run <code>npx sequelize db:migrate</code>, your fixup migration will be run on their local machine.</p>
<p>When rolling back already-checked-in migrations, there is no way to easily communicate to other developers that they should (1) rollback your migration and (2) rerun the newly corrected version of this migration. To avoid this communication problem, you should only rollback commits if you haven’t already pushed them to a remote git server.</p>
<h2 id="editing-a-migration-file">Editing A Migration File</h2>
<p>Let’s examine the <code>up</code> and <code>down</code> methods more closely. Let’s start with the <code>up</code> method:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb19-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-2" title="2">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-3" title="3">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Cats&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-4" title="4">      <span class="dt">id</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-5" title="5">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-6" title="6">        <span class="dt">autoIncrement</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-7" title="7">        <span class="dt">primaryKey</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-8" title="8">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb19-9" title="9">      <span class="op">},</span></a>
<a class="sourceLine" id="cb19-10" title="10">      <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-11" title="11">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb19-12" title="12">      <span class="op">},</span></a>
<a class="sourceLine" id="cb19-13" title="13">      <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-14" title="14">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb19-15" title="15">      <span class="op">},</span></a>
<a class="sourceLine" id="cb19-16" title="16">      <span class="dt">createdAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-17" title="17">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-18" title="18">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb19-19" title="19">      <span class="op">},</span></a>
<a class="sourceLine" id="cb19-20" title="20">      <span class="dt">updatedAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-21" title="21">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-22" title="22">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb19-23" title="23">      <span class="op">}</span></a>
<a class="sourceLine" id="cb19-24" title="24">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-25" title="25">  <span class="op">},</span></a>
<a class="sourceLine" id="cb19-26" title="26">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb19-27" title="27"><span class="op">};</span></a></code></pre></div>
<p>The <code>up</code> method will be passed a QueryInterface (<a href="https://sequelize.org/master/class/lib/query-interface.js~QueryInterface.html">documentation</a>) object. This object provides a number of commands for modifying the SQL database schema. The <code>createTable</code> method is amongst the most important.</p>
<p>We pass the table name (<code>'Cats'</code>) along with an object mapping column names to column attributes. Every column must have a specified <code>type</code>. This is similar to what we saw when we generated a model file. Note that we <strong>do not</strong> take <code>id</code>, <code>createdAt</code>, or <code>updatedAt</code> for granted. We need to include those columns. Luckily, everything has been auto-generated for us!</p>
<p>We will talk about <code>allowNull</code> and <code>primaryKey</code> in a later reading. These attributes ask Sequelize to add database constraints to a column. Likewise we will ignore <code>autoIncrement</code> for the moment (this allows a unique <code>id</code> to be auto-generated by the database for each saved row in the <code>Cats</code> table).</p>
<p>We fix the <code>up</code> method like so:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb20-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb20-2" title="2">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb20-3" title="3">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Cats&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb20-4" title="4">      <span class="co">// ...</span></a>
<a class="sourceLine" id="cb20-5" title="5">      <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb20-6" title="6">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb20-7" title="7">      <span class="op">},</span></a>
<a class="sourceLine" id="cb20-8" title="8">      <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb20-9" title="9">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb20-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb20-11" title="11">      <span class="co">// Here we add the `age` column.</span></a>
<a class="sourceLine" id="cb20-12" title="12">      <span class="dt">age</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb20-13" title="13">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb20-14" title="14">      <span class="op">},</span></a>
<a class="sourceLine" id="cb20-15" title="15">      <span class="co">// ...</span></a>
<a class="sourceLine" id="cb20-16" title="16">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb20-17" title="17">  <span class="op">},</span></a>
<a class="sourceLine" id="cb20-18" title="18">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb20-19" title="19"><span class="op">};</span></a></code></pre></div>
<p>Adding the <code>age</code> column to the migration is a lot like how we added <code>age</code> to our model file.</p>
<p>Having fixed our migration, we may now “rerun” it the same way we ran it the first time:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb21-1" title="1"><span class="ex">npx</span> sequelize db:migrate</a></code></pre></div>
<p>We may now behold the fixed table:</p>
<pre><code>catsdb=&gt; \d &quot;Cats&quot;
                                         Table &quot;public.Cats&quot;
    Column    |           Type           | Collation | Nullable
--------------+--------------------------+-----------+----------
 id           | integer                  |           | not null
 firstName    | character varying(255)   |           |
 specialSkill | character varying(255)   |           |
 age          | integer                  |           |
 createdAt    | timestamp with time zone |           | not null
 updatedAt    | timestamp with time zone |           | not null
Indexes:
    &quot;Cats_pkey&quot; PRIMARY KEY, btree (id)</code></pre>
<h2 id="up-and-down-are-asynchronous"><code>up</code> And <code>down</code> are Asynchronous</h2>
<p>A final note about <code>up</code> (and also <code>down</code>). Sequelize expects <code>up</code> to be <em>asynchronous</em>. That is, Sequelize expects <code>up</code> to return a <code>Promise</code> object. Sequelize will wait for the <code>Promise</code> to be resolved. When the <code>Promise</code> is resolved, Sequelize will know the work of the <code>up</code> method is complete.</p>
<p>The <code>createTable</code> method is also asynchronous (returns a <code>Promise</code>). The promise resolves when <code>createTable</code> is done creating the table. This is why <code>up</code> is written as:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb23-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb23-2" title="2">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb23-3" title="3">    <span class="co">// up returns Promise returned by `createTable`.</span></a>
<a class="sourceLine" id="cb23-4" title="4">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Cats&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb23-5" title="5">      <span class="co">// ...</span></a>
<a class="sourceLine" id="cb23-6" title="6">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb23-7" title="7">  <span class="op">},</span></a>
<a class="sourceLine" id="cb23-8" title="8">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb23-9" title="9"><span class="op">};</span></a></code></pre></div>
<p>Sequelize is able to autogenerate a migration to create a <code>Cats</code> table, but many other migrations (for instance, to add an <code>age</code> column to our <code>Cats</code> table) must be written by hand. When writing your own migrations, you may prefer using <code>async</code>/<code>await</code>, which is clearer:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb24-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb24-2" title="2">  <span class="co">// Note the addition of the `async` keyword</span></a>
<a class="sourceLine" id="cb24-3" title="3">  <span class="dt">up</span><span class="op">:</span> <span class="kw">async</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb24-4" title="4">    <span class="co">// await `createTable` to finish its work.</span></a>
<a class="sourceLine" id="cb24-5" title="5">    <span class="cf">await</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Cats&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb24-6" title="6">      <span class="co">// ...</span></a>
<a class="sourceLine" id="cb24-7" title="7">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-8" title="8"></a>
<a class="sourceLine" id="cb24-9" title="9">    <span class="co">// No need to return anything. An `async` method always returns a</span></a>
<a class="sourceLine" id="cb24-10" title="10">    <span class="co">// Promise that waits for all `await`ed work to be performed.</span></a>
<a class="sourceLine" id="cb24-11" title="11">  <span class="op">},</span></a>
<a class="sourceLine" id="cb24-12" title="12">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb24-13" title="13"><span class="op">};</span></a></code></pre></div>
<h2 id="writing-a-down-method">Writing A <code>down</code> Method</h2>
<p>A <code>down</code> method is written just like an <code>up</code> method. In the <code>down</code> method we “undo” what has been performed by the <code>up</code> method. We call <code>QueryInterface</code>’s <code>dropTable</code> method to drop the <code>Cats</code> table we created in <code>up</code>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb25-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb25-2" title="2">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb25-3" title="3">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb25-4" title="4">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&#39;Cats&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb25-5" title="5">  <span class="op">}</span></a>
<a class="sourceLine" id="cb25-6" title="6"><span class="op">};</span></a>
<a class="sourceLine" id="cb25-7" title="7"></a>
<a class="sourceLine" id="cb25-8" title="8"><span class="co">// OR, async/await way:</span></a>
<a class="sourceLine" id="cb25-9" title="9"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb25-10" title="10">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb25-11" title="11">  <span class="dt">down</span><span class="op">:</span> <span class="kw">async</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb25-12" title="12">    <span class="cf">await</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&#39;Cats&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb25-13" title="13">  <span class="op">}</span></a>
<a class="sourceLine" id="cb25-14" title="14"><span class="op">};</span></a></code></pre></div>
<p><strong>Imagine we had forgotten to drop the <code>Cats</code> table in the <code>down</code> method.</strong> That is: imagine the <code>down</code> method was somehow left empty. If we rollback the migration nothing will be done by the empty <code>down</code> method. Thus the incorrect <code>Cats</code> table we created will not have been dropped. The wrong <code>Cats</code> table would still exist.</p>
<p>Imagine we next fix the migration’s <code>up</code> method. We want to rerun the migration now and create the corrected <code>Cats</code> table. But when try to do this, Sequelize will hit an error! Rerunning the migration will try to <code>CREATE TABLE "Cats"</code> again, but SQL will complain because a <code>Cats</code> table already exists. It was created the first time we ran the migration, but never dropped when we tried to rollback the migration!</p>
<p>Inevitably all programmers will sometimes make mistakes like this. In these circumstances, you will probably have to open <code>psql</code> and write a SQL <code>DROP TABLE</code> command to fix things. Having manually corrected things, you can finally rerun the corrected migration.</p>
<p>You should <strong>never</strong> manually drop a table on a production database. That is incredibly dangerous, and typically cannot be undone. Even if database backups do not exist, recently inserted data will be lost forever. This is yet another reason why you ought not rollback migrations that have been pushed from your local development environment!</p>
<h2 id="advantages-of-migrations">Advantages Of Migrations</h2>
<p>Having seen how to <em>use</em> Sequelize migrations, we can discuss their benefits versus writing SQL commands like <code>CREATE TABLE ...</code> yourself.</p>
<p>The first advantage is that Sequelize migration code is written in JavaScript, which you may find simpler to write/read than the corresponding SQL code. Most programmers write more JavaScript than SQL, so they are typically better at remembering how to do things in JavaScript than in SQL.</p>
<p>A second advantage is that migration files store SQL schema change code permanently. The migration files can be checked into git, so that you don’t ever forget how your database was configured.</p>
<p>A third (related) advantage comes when another developer wants to collaborate on your JavaScript program. By cloning your git repository, they get all the migration files, too. To setup their own copy of your database, a collaborator can run the migration files on their own computer, playing back the schema changes one-by-one. Because they apply the same migrations as you, they end up with the same schema as you.</p>
<p>Last, by using migrations you are able to rollback database changes to fix bugs. This can be helpful in a local development environment where it is typical to make mistakes. Remember though: you should <strong>never</strong> rollback migrations that have been run on a production server.</p>
<h2 id="conclusion-1">Conclusion</h2>
<p>Having completed this reading, you now are able to:</p>
<ul>
<li>Describe advantages to using migrations over raw SQL commands to create, modify, and drop tables.</li>
<li>Generate (and modify as needed)) migrations that create and drop tables.</li>
<li>Run migrations to change the database schema.</li>
<li>Undo incorrect migrations, fix them, and rerun them.</li>
</ul>
<hr />
<h1 id="crud-operations-using-sequelize">CRUD Operations Using Sequelize</h1>
<p>There are four general ways to interact with a database. To illustrate these, recall our <code>Cats</code> table. We can:</p>
<ol type="1">
<li>Save a new cat to the database by <em>creating</em> a new row in the <code>Cats</code> table,</li>
<li>We can <em>read</em> previously stored cat data by fetching a row (or multiple rows) out of the <code>Cats</code> table,</li>
<li>We can <em>update</em> some of the column values for a pre-existing cat by modifying a row in the <code>Cats</code> table,</li>
<li>We can delete (<em>destroy</em>) the data for a cat by removing a row in the <code>Cats</code> table.</li>
</ol>
<p>These four actions are sometimes abbreviated as <em>CRUD</em>. After this reading, you will be able to:</p>
<ul>
<li>Use Sequelize to create new records in a table,</li>
<li>Use Sequelize to read/fetch existing records by primary key,</li>
<li>Use Sequelize to update existing records with new attribute values,</li>
<li>Use Sequelize to delete records from a table.</li>
</ul>
<h2 id="creating-a-new-record">Creating A New Record</h2>
<p>To save a new cat’s data as a row in the <code>Cats</code> table, we do a two step process:</p>
<ol type="1">
<li>We call the static <code>build</code> method on the <code>Cat</code> class with the desired values.</li>
<li>We call the <code>save</code> method on the <code>cat</code> instance.</li>
</ol>
<p>Let’s see an example:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-2" title="2"></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb26-4" title="4">  <span class="co">// Constructs an instance of the JavaScript `Cat` class. **Does not</span></a>
<a class="sourceLine" id="cb26-5" title="5">  <span class="co">// save anything to the database yet**. Attributes are passed in as a</span></a>
<a class="sourceLine" id="cb26-6" title="6">  <span class="co">// POJO.</span></a>
<a class="sourceLine" id="cb26-7" title="7">  <span class="kw">const</span> cat <span class="op">=</span> <span class="va">Cat</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb26-8" title="8">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Markov&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb26-9" title="9">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="st">&quot;sleeping&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb26-10" title="10">    <span class="dt">age</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></a>
<a class="sourceLine" id="cb26-11" title="11">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-12" title="12"></a>
<a class="sourceLine" id="cb26-13" title="13">  <span class="co">// This actually creates a new `Cats` record in the database. We must</span></a>
<a class="sourceLine" id="cb26-14" title="14">  <span class="co">// wait for this asynchronous operation to succeed.</span></a>
<a class="sourceLine" id="cb26-15" title="15">  <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb26-16" title="16"></a>
<a class="sourceLine" id="cb26-17" title="17">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb26-18" title="18"></a>
<a class="sourceLine" id="cb26-19" title="19">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb26-20" title="20"><span class="op">}</span></a>
<a class="sourceLine" id="cb26-21" title="21"></a>
<a class="sourceLine" id="cb26-22" title="22"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Running the code:</p>
<pre><code>Executing (default): INSERT INTO &quot;Cats&quot; (&quot;id&quot;,&quot;firstName&quot;,&quot;specialSkill&quot;,&quot;age&quot;,&quot;createdAt&quot;,&quot;updatedAt&quot;) VALUES (DEFAULT,$1,$2,$3,$4,$5) RETURNING *;
{
  id: 1,
  firstName: &#39;Markov&#39;,
  specialSkill: &#39;sleeping&#39;,
  age: 5,
  updatedAt: 2020-02-11T19:04:23.116Z,
  createdAt: 2020-02-11T19:04:23.116Z
}</code></pre>
<p>A new row has been inserted into the <code>Cats</code> table. We see that <code>id</code>, <code>updatedAt</code>, and <code>createdAt</code> were each autogenerated for us.</p>
<h2 id="reading-a-record-by-primary-key">Reading A Record By Primary Key</h2>
<p>Let’s read an existing record from the database:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb28-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb28-2" title="2"></a>
<a class="sourceLine" id="cb28-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb28-4" title="4">  <span class="co">// Fetch the cat with id #1.</span></a>
<a class="sourceLine" id="cb28-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb28-6" title="6">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb28-7" title="7"></a>
<a class="sourceLine" id="cb28-8" title="8">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb28-9" title="9"><span class="op">}</span></a>
<a class="sourceLine" id="cb28-10" title="10"></a>
<a class="sourceLine" id="cb28-11" title="11"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Running this code prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;
{
  id: 1,
  firstName: &#39;Markov&#39;,
  specialSkill: &#39;sleeping&#39;,
  age: 5,
  createdAt: 2020-02-11T19:04:23.116Z,
  updatedAt: 2020-02-11T19:04:23.116Z
}</code></pre>
<p>Fetching a record by primary key is the most common form of read operation from a database. In another reading we will learn other ways to fetch data. For instance: we will learn how to fetch all cats named “Markov” (there may be many).</p>
<h2 id="updating-a-record">Updating A Record</h2>
<p>Let’s tweak our reading code to change (<em>update</em>) an attribute of Markov:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb30-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span>  <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-2" title="2"></a>
<a class="sourceLine" id="cb30-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb30-4" title="4">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-5" title="5"></a>
<a class="sourceLine" id="cb30-6" title="6">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Old Markov: &quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-7" title="7">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb30-8" title="8"></a>
<a class="sourceLine" id="cb30-9" title="9">  <span class="co">// The Cat object is modified, but the corresponding record in the</span></a>
<a class="sourceLine" id="cb30-10" title="10">  <span class="co">// database is *not* yet changed at all.</span></a>
<a class="sourceLine" id="cb30-11" title="11">  <span class="va">cat</span>.<span class="at">specialSkill</span> <span class="op">=</span> <span class="st">&quot;super deep sleeping&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb30-12" title="12">  <span class="co">// Only by calling `save` will the data be saved.</span></a>
<a class="sourceLine" id="cb30-13" title="13">  <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb30-14" title="14"></a>
<a class="sourceLine" id="cb30-15" title="15">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;New Markov: &quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-16" title="16">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb30-17" title="17"></a>
<a class="sourceLine" id="cb30-18" title="18">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb30-19" title="19"><span class="op">}</span></a>
<a class="sourceLine" id="cb30-20" title="20"></a>
<a class="sourceLine" id="cb30-21" title="21"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Running this code prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;
Old Markov:
{
  id: 1,
  firstName: &#39;Markov&#39;,
  specialSkill: &#39;sleeping&#39;,
  age: 5,
  createdAt: 2020-02-11T19:04:23.116Z,
  updatedAt: 2020-02-11T19:04:23.116Z
}
Executing (default): UPDATE &quot;Cats&quot; SET &quot;specialSkill&quot;=$1,&quot;updatedAt&quot;=$2 WHERE &quot;id&quot; = $3
New Markov:
{
  id: 1,
  firstName: &#39;Markov&#39;,
  specialSkill: &#39;super deep sleeping&#39;,
  age: 5,
  createdAt: 2020-02-11T19:04:23.116Z,
  updatedAt: 2020-02-11T19:15:08.668Z
}</code></pre>
<p><strong>Important note</strong>: changing an attribute of a <code>Cat</code> object does not immediately change any data in the <code>Cats</code> table. To change data in the <code>Cats</code> table, you must also call <code>save</code>. If you forget to call <code>save</code>, no data will be changed. <code>save</code> is asynchronous, so you must also <code>await</code> for it to complete.</p>
<p>If you look carefully, you can see that the <code>updatedAt</code> attribute was changed for us when we updated Markov!</p>
<h2 id="destroying-a-record">Destroying A Record</h2>
<p>We can also destroy records and remove them from the database:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb32-1" title="1"><span class="kw">const</span> process <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;process&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-2" title="2"></a>
<a class="sourceLine" id="cb32-3" title="3"><span class="kw">const</span> <span class="op">{</span> sequelize <span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-4" title="4"></a>
<a class="sourceLine" id="cb32-5" title="5"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb32-6" title="6">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-7" title="7">  <span class="co">// Remove the Markov record.</span></a>
<a class="sourceLine" id="cb32-8" title="8">  <span class="cf">await</span> <span class="va">cat</span>.<span class="at">destroy</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb32-9" title="9"></a>
<a class="sourceLine" id="cb32-10" title="10">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb32-11" title="11"><span class="op">}</span></a>
<a class="sourceLine" id="cb32-12" title="12"></a>
<a class="sourceLine" id="cb32-13" title="13"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This code prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;
Executing (default): DELETE FROM &quot;Cats&quot; WHERE &quot;id&quot; = 1</code></pre>
<h2 id="class-methods-for-crud">Class Methods For CRUD</h2>
<p>When creating a record, you can avoid the two step process of (1) creating a <code>Cat</code> instance and (2) calling the <code>save</code> instance method. You can do a one step process of calling the <code>create</code> <strong>class method</strong>:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb34-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb34-2" title="2"></a>
<a class="sourceLine" id="cb34-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb34-4" title="4">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">create</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb34-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Curie&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb34-6" title="6">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="st">&quot;jumping&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb34-7" title="7">    <span class="dt">age</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></a>
<a class="sourceLine" id="cb34-8" title="8">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb34-9" title="9"></a>
<a class="sourceLine" id="cb34-10" title="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb34-11" title="11"></a>
<a class="sourceLine" id="cb34-12" title="12">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb34-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb34-14" title="14"></a>
<a class="sourceLine" id="cb34-15" title="15"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>The <code>create</code> class method does both steps in one. It is just a convenience. Similar to before, this code prints:</p>
<pre><code>Executing (default): INSERT INTO &quot;Cats&quot; (&quot;id&quot;,&quot;firstName&quot;,&quot;specialSkill&quot;,&quot;age&quot;,&quot;createdAt&quot;,&quot;updatedAt&quot;) VALUES (DEFAULT,$1,$2,$3,$4,$5) RETURNING *;
{
  id: 3,
  firstName: &#39;Curie&#39;,
  specialSkill: &#39;jumping&#39;,
  age: 4,
  updatedAt: 2020-02-11T19:36:03.858Z,
  createdAt: 2020-02-11T19:36:03.858Z
}</code></pre>
<p>When destroying, we also did a two step process: (1) fetch the record, (2) call the <code>destroy</code> instance method. Instead, we could just call the <code>destroy</code> <strong>class method</strong> directly:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb36-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb36-2" title="2"></a>
<a class="sourceLine" id="cb36-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb36-4" title="4">  <span class="co">// Destroy the Cat record with id #3.</span></a>
<a class="sourceLine" id="cb36-5" title="5">  <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">destroy</span>(<span class="op">{</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="dv">3</span> <span class="op">}</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb36-6" title="6"></a>
<a class="sourceLine" id="cb36-7" title="7">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb36-8" title="8"><span class="op">}</span></a>
<a class="sourceLine" id="cb36-9" title="9"></a>
<a class="sourceLine" id="cb36-10" title="10"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): DELETE FROM &quot;Cats&quot; WHERE &quot;id&quot; = 3</code></pre>
<p>An advantage to the class method form of destroying is that we avoid an unnecessary fetch of <code>Cat.findByPk(3)</code>. Database queries can sometimes be slow, though typically a few extra queries won’t make a big difference. Choosing between the instance and class methods of destroying usually comes down to which you consider easier to read/understand.</p>
<h2 id="conclusion-2">Conclusion</h2>
<p>As ever, the best resource for learning about Sequelize model methods is the <a href="https://sequelize.org/master/class/lib/model.js~Model.html">documentation</a>. The documentation explains the <code>create</code>, <code>destroy</code>, <code>findByPk</code>, and <code>save</code> methods in depth.</p>
<p>Having completed this reading, you now know how to:</p>
<ul>
<li>Use Sequelize to create new records in a table (using both instance and class methods),</li>
<li>Use Sequelize to read/fetch existing records by primary key,</li>
<li>Use Sequelize to update existing records with new attribute values,</li>
<li>Use Sequelize to delete records from a table (using both instance and class methods).</li>
</ul>
<hr />
<h1 id="querying-using-sequelize">Querying Using Sequelize</h1>
<p>We have already seen how to find a single record by primary key: <code>findByPk</code>. In this reading we will learn about more advanced ways to query a table. We will learn how to:</p>
<ul>
<li>Fetch all <code>Cats</code> whose name is <code>"Markov"</code>,</li>
<li>Fetch all <code>Cats</code> whose name is <code>"Markov"</code> <strong>OR</strong> <code>"Curie"</code>,</li>
<li>Fetch all <code>Cats</code> whose age is <strong>not</strong> 5,</li>
<li>Fetch all <code>Cats</code> whose name is <code>"Markov"</code> <strong>AND</strong> whose age is 5,</li>
<li>Fetch all <code>Cats</code> whose age is <strong>less than</strong> 5,</li>
</ul>
<p>We will also learn how to:</p>
<ul>
<li>Order <code>Cats</code> results by age (descending or ascending),</li>
<li>Limit <code>Cats</code> results to a finite number.</li>
</ul>
<h2 id="basic-usage-of-findall-to-retrieve-multiple-records">Basic Usage Of <code>findAll</code> To Retrieve Multiple Records</h2>
<p>Let’s consider a simple example where we want to retrieve all the <code>Cats</code> in the database:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb38-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-2" title="2"></a>
<a class="sourceLine" id="cb38-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb38-4" title="4">  <span class="co">// `findAll` asks to retrieve _ALL_ THE CATS!!  An array of `Cat`</span></a>
<a class="sourceLine" id="cb38-5" title="5">  <span class="co">// objects will be returned.</span></a>
<a class="sourceLine" id="cb38-6" title="6">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb38-7" title="7"></a>
<a class="sourceLine" id="cb38-8" title="8">  <span class="co">// Log the fetched cats.</span></a>
<a class="sourceLine" id="cb38-9" title="9">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb38-10" title="10"></a>
<a class="sourceLine" id="cb38-11" title="11">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb38-12" title="12"><span class="op">}</span></a>
<a class="sourceLine" id="cb38-13" title="13"></a>
<a class="sourceLine" id="cb38-14" title="14"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Since this is an array we can’t use that <code>.toJSON()</code> method we learned earlier, so we can instead use <code>JSON.stringify</code> on the Array.</p>
<p>Pro tip: giving a 3rd argument to <code>JSON.stringify</code> will pretty-print the result with the specified spacing. (We pass <code>null</code> as the 2nd argument to skip it.) You can read more at the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify"><code>JSON.stringify</code> docs</a>.</p>
<p>Running this code prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot;;
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  },
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>It isn’t typical to want to fetch <em>every</em> record. We typically want to get only those records that match some criterion. In SQL, we use a <code>WHERE</code> clause to do this. With Sequelize, we issue a <code>WHERE</code> query like so:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb40-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-2" title="2"></a>
<a class="sourceLine" id="cb40-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb40-4" title="4">  <span class="co">// Fetch all cats named Markov.</span></a>
<a class="sourceLine" id="cb40-5" title="5">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb40-6" title="6">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb40-7" title="7">      <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Markov&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb40-8" title="8">    <span class="op">},</span></a>
<a class="sourceLine" id="cb40-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-10" title="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb40-11" title="11"></a>
<a class="sourceLine" id="cb40-12" title="12">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb40-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb40-14" title="14"></a>
<a class="sourceLine" id="cb40-15" title="15"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Which prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;firstName&quot; = &#39;Markov&#39;;
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  }
]</code></pre>
<p>We’ve passed the <code>findAll</code> class method the <code>where</code> option. The <code>where</code> option tells Sequelize to use a <code>WHERE</code> clause. The option value passed is <code>{ firstName: "Markov" }</code>. This tells Sequelize to only return those <code>Cats</code> where <code>firstName</code> is equal to <code>"Markov"</code>.</p>
<p>If we wanted to select those <code>Cats</code> named Markov <strong>OR</strong> Curie, we can map <code>firstName</code> to an array of <code>["Markov", "Curie"]</code>. For example:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb42-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-2" title="2"></a>
<a class="sourceLine" id="cb42-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb42-4" title="4">  <span class="co">// Fetch all cats named either Markov or Curie.</span></a>
<a class="sourceLine" id="cb42-5" title="5">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb42-6" title="6">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb42-7" title="7">      <span class="dt">firstName</span><span class="op">:</span> [<span class="st">&quot;Markov&quot;</span><span class="op">,</span> <span class="st">&quot;Curie&quot;</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb42-8" title="8">    <span class="op">},</span></a>
<a class="sourceLine" id="cb42-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-10" title="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb42-11" title="11"></a>
<a class="sourceLine" id="cb42-12" title="12">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb42-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb42-14" title="14"></a>
<a class="sourceLine" id="cb42-15" title="15"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;firstName&quot; IN (&#39;Markov&#39;, &#39;Curie&#39;);
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  },
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>The difference is that we’ve passed <code>{ firstName: ["Markov", "Curie" ]}</code>. Sequelize will return all <code>Cats</code> whose <code>firstName</code> matches either <code>"Markov"</code> or <code>"Curie"</code>.</p>
<h2 id="using-findall-to-find-objects-not-matching-a-criterion">Using <code>findAll</code> To Find Objects Not Matching A Criterion</h2>
<p>We can also find all the <code>Cats</code> whose names are <strong>NOT</strong> Markov, but we will need to require in the <code>Op</code> object from Sequelize so we can use the “not equal” operator from it:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb44-1" title="1"><span class="kw">const</span> <span class="op">{</span> Op <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;sequelize&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./db/models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-3" title="3"></a>
<a class="sourceLine" id="cb44-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb44-5" title="5">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb44-6" title="6">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb44-7" title="7">      <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb44-8" title="8">        <span class="co">// Op.ne means the &quot;not equal&quot; operator.</span></a>
<a class="sourceLine" id="cb44-9" title="9">        [<span class="va">Op</span>.<span class="at">ne</span>]<span class="op">:</span> <span class="st">&quot;Markov&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb44-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb44-11" title="11">    <span class="op">},</span></a>
<a class="sourceLine" id="cb44-12" title="12">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-13" title="13">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb44-14" title="14"></a>
<a class="sourceLine" id="cb44-15" title="15">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-16" title="16"><span class="op">}</span></a>
<a class="sourceLine" id="cb44-17" title="17"></a>
<a class="sourceLine" id="cb44-18" title="18"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;firstName&quot; != &#39;Markov&#39;;
[
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>This is our first example of a Sequelize <a href="https://sequelize.org/v5/manual/querying.html#operators"><em>operator</em></a>: <code>Op.ne</code>. <code>ne</code> stands for “not equal.” Instead of mapping <code>firstName</code> to a single value like <code>"Markov"</code> or an array of values like <code>["Markov", "Curie"]</code>, we have mapped it to:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb46-1" title="1"><span class="op">{</span> [<span class="va">Op</span>.<span class="at">ne</span>]<span class="op">:</span> <span class="st">&quot;Markov&quot;</span> <span class="op">}</span></a></code></pre></div>
<p>How does this work? <code>Op.ne</code> is a JavaScript <em>symbol</em>: <code>Op.ne === Symbol.for('ne')</code>. To simplify, let’s just imagine that <code>Op.ne === "ne"</code>.</p>
<p>When we write <code>{ [Op.ne]: "Markov" }</code>, the <code>[]</code> brackets perform key interpolation. So this is equal to <code>{ "ne": "Markov" }</code>. So overall, we are effectively writing:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb47-1" title="1"><span class="va">db</span>.<span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb47-2" title="2">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb47-3" title="3">    <span class="co">// Won&#39;t exactly work (you need to use `[Op.ne]` after all). Does</span></a>
<a class="sourceLine" id="cb47-4" title="4">    <span class="co">// illustrate the concept though.</span></a>
<a class="sourceLine" id="cb47-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span> <span class="st">&quot;ne&quot;</span><span class="op">:</span> <span class="st">&quot;Markov&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb47-6" title="6">  <span class="op">},</span></a>
<a class="sourceLine" id="cb47-7" title="7"><span class="op">}</span>)</a></code></pre></div>
<p>This perhaps makes it clearer how Sequelize understands what we want. Sequelize is being passed an <em>object</em> as the <code>firstName</code> value. The object is specifying that we want to do a <code>!=</code> SQL operation by using the <code>"ne"</code> (“not equal”) key. The value to “not equal” is specified as <code>"Markov"</code>.</p>
<h2 id="combining-criteria-with-op.and">Combining Criteria with <code>Op.and</code></h2>
<p>We’ve seen one way to do an <code>OR</code> operation above (by mapping a column name to an array of values). Let’s see how to do an <code>AND</code> operation:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb48-1" title="1"><span class="kw">const</span> <span class="op">{</span> Op <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;sequelize&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb48-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize <span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb48-3" title="3"></a>
<a class="sourceLine" id="cb48-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb48-5" title="5">  <span class="co">// fetch cats with name != Markov AND age = 4.</span></a>
<a class="sourceLine" id="cb48-6" title="6">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb48-7" title="7">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb48-8" title="8">      <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb48-9" title="9">        [<span class="va">Op</span>.<span class="at">ne</span>]<span class="op">:</span> <span class="st">&quot;Markov&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb48-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb48-11" title="11">      <span class="dt">age</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></a>
<a class="sourceLine" id="cb48-12" title="12">    <span class="op">},</span></a>
<a class="sourceLine" id="cb48-13" title="13">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb48-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb48-15" title="15"></a>
<a class="sourceLine" id="cb48-16" title="16">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb48-17" title="17"><span class="op">}</span></a>
<a class="sourceLine" id="cb48-18" title="18"></a>
<a class="sourceLine" id="cb48-19" title="19"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;firstName&quot; != &#39;Markov&#39; AND &quot;Cat&quot;.&quot;age&quot; = 4;
[
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>Simply by listing more key/value pairs in the <code>where</code> object, we ask Sequelize to “AND” together multiple criteria.</p>
<p>Another way to do the same thing is like so:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb50-1" title="1"><span class="kw">const</span> <span class="op">{</span> Op <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;sequelize&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize <span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-3" title="3"></a>
<a class="sourceLine" id="cb50-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb50-5" title="5">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb50-6" title="6">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-7" title="7">      [<span class="va">Op</span>.<span class="at">and</span>]<span class="op">:</span> [</a>
<a class="sourceLine" id="cb50-8" title="8">        <span class="op">{</span> <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span> [<span class="va">Op</span>.<span class="at">ne</span>]<span class="op">:</span> <span class="st">&quot;Markov&quot;</span> <span class="op">}</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb50-9" title="9">        <span class="op">{</span> <span class="dt">age</span><span class="op">:</span> <span class="dv">4</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb50-10" title="10">      ]<span class="op">,</span></a>
<a class="sourceLine" id="cb50-11" title="11">    <span class="op">},</span></a>
<a class="sourceLine" id="cb50-12" title="12">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-13" title="13">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb50-14" title="14"></a>
<a class="sourceLine" id="cb50-15" title="15">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb50-16" title="16"><span class="op">}</span></a>
<a class="sourceLine" id="cb50-17" title="17"></a>
<a class="sourceLine" id="cb50-18" title="18"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>The use of the <code>Op.and</code> operator is somewhat similar to <code>Op.ne</code>. This time we map <code>Op.and</code> to an <em>array</em> of criteria. Returned records must match all the criteria.</p>
<h2 id="combining-criteria-with-op.or">Combining Criteria with <code>Op.or</code></h2>
<p>We’ve already seen how to do an <code>OR</code> to match a <em>single column</em> against <em>multiple values</em>. You can use <code>Op.or</code> for even greater flexibility:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb51-1" title="1"><span class="kw">const</span> <span class="op">{</span> Op <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;sequelize&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-3" title="3"></a>
<a class="sourceLine" id="cb51-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb51-5" title="5">  <span class="co">// fetch cats with name == Markov OR age = 4.</span></a>
<a class="sourceLine" id="cb51-6" title="6">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb51-7" title="7">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb51-8" title="8">      [<span class="va">Op</span>.<span class="at">or</span>]<span class="op">:</span> [</a>
<a class="sourceLine" id="cb51-9" title="9">        <span class="op">{</span> <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Markov&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb51-10" title="10">        <span class="op">{</span> <span class="dt">age</span><span class="op">:</span> <span class="dv">4</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb51-11" title="11">      ]<span class="op">,</span></a>
<a class="sourceLine" id="cb51-12" title="12">    <span class="op">},</span></a>
<a class="sourceLine" id="cb51-13" title="13">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb51-15" title="15"></a>
<a class="sourceLine" id="cb51-16" title="16">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb51-17" title="17"><span class="op">}</span></a>
<a class="sourceLine" id="cb51-18" title="18"></a>
<a class="sourceLine" id="cb51-19" title="19"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE (&quot;Cat&quot;.&quot;firstName&quot; = &#39;Markov&#39; OR &quot;Cat&quot;.&quot;age&quot; = 4);
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  },
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>Our query is to find all cats whose names are “Markov” and whose age is 4. Therefore both cats are returned: Markov and Curie (whose age is 4).</p>
<h2 id="querying-with-comparisons">Querying With Comparisons</h2>
<p>We can use operators like <code>Op.gt</code> (greater than) and <code>Op.lt</code> (less than) to select by comparing values. We use these just like <code>Op.ne</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb53-1" title="1"><span class="kw">const</span> <span class="op">{</span> Op <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;sequelize&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb53-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb53-3" title="3"></a>
<a class="sourceLine" id="cb53-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb53-5" title="5">  <span class="co">// Fetch all cats whose age is &gt; 4.</span></a>
<a class="sourceLine" id="cb53-6" title="6">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb53-7" title="7">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb53-8" title="8">      <span class="dt">age</span><span class="op">:</span> <span class="op">{</span> [<span class="va">Op</span>.<span class="at">gt</span>]<span class="op">:</span> <span class="dv">4</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb53-9" title="9">    <span class="op">},</span></a>
<a class="sourceLine" id="cb53-10" title="10">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb53-11" title="11">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb53-12" title="12"></a>
<a class="sourceLine" id="cb53-13" title="13">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb53-14" title="14"><span class="op">}</span></a>
<a class="sourceLine" id="cb53-15" title="15"></a>
<a class="sourceLine" id="cb53-16" title="16"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;age&quot; &gt; 4;
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  }
]</code></pre>
<h2 id="ordering-results">Ordering Results</h2>
<p>We’ve seen how to use a <code>where</code> query option to filter results with a SQL <code>WHERE</code> clause. We can use the <code>order</code> query option to perform a SQL <code>ORDER BY</code>:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb55-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb55-2" title="2"></a>
<a class="sourceLine" id="cb55-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb55-4" title="4">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb55-5" title="5">    <span class="dt">order</span><span class="op">:</span> [[<span class="st">&quot;age&quot;</span><span class="op">,</span> <span class="st">&quot;DESC&quot;</span>]]<span class="op">,</span></a>
<a class="sourceLine" id="cb55-6" title="6">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb55-7" title="7">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb55-8" title="8"></a>
<a class="sourceLine" id="cb55-9" title="9">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb55-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb55-11" title="11"></a>
<a class="sourceLine" id="cb55-12" title="12"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; ORDER BY &quot;Cat&quot;.&quot;age&quot; DESC;
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  },
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>We’ve specified <code>{ order: [["age", "DESC"]] }</code>. Notice how we specify the sort order with a doubly-nested array. If we wanted to sort ascending we could more simply write: <code>{ order: ["age"] }</code>.</p>
<p>What if we wanted to sort by <em>two</em> columns? For instance, say we wanted to <code>SORT BY age DESC, firstName</code>. We would write: <code>{ order: [["age", "DESC"], "firstName"] }</code>. That would sort descending by <code>age</code>, and then ascending by <code>firstName</code> for cats with the same age.</p>
<h2 id="limiting-results-and-findone">Limiting Results and <code>findOne</code></h2>
<p>If we want only the oldest cat we can use the <code>limit</code> query option:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb57-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb57-2" title="2"></a>
<a class="sourceLine" id="cb57-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb57-4" title="4">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb57-5" title="5">    <span class="dt">order</span><span class="op">:</span> [[<span class="st">&quot;age&quot;</span><span class="op">,</span> <span class="st">&quot;DESC&quot;</span>]]<span class="op">,</span></a>
<a class="sourceLine" id="cb57-6" title="6">    <span class="dt">limit</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></a>
<a class="sourceLine" id="cb57-7" title="7">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb57-8" title="8">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb57-9" title="9"></a>
<a class="sourceLine" id="cb57-10" title="10">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb57-11" title="11"><span class="op">}</span></a>
<a class="sourceLine" id="cb57-12" title="12"></a>
<a class="sourceLine" id="cb57-13" title="13"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This selects only one (the oldest) cat:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; ORDER BY &quot;Cat&quot;.&quot;age&quot; DESC LIMIT 1;
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  }
]</code></pre>
<p>Since we know that there will be only one result, it is pointless to return an array. In cases when we want a maximum of one result, we can use <code>findOne</code>:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb59-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb59-2" title="2"></a>
<a class="sourceLine" id="cb59-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb59-4" title="4">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findOne</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb59-5" title="5">    <span class="dt">order</span><span class="op">:</span> [[<span class="st">&quot;age&quot;</span><span class="op">,</span> <span class="st">&quot;DESC&quot;</span>]]<span class="op">,</span></a>
<a class="sourceLine" id="cb59-6" title="6">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb59-7" title="7">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cat<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb59-8" title="8"></a>
<a class="sourceLine" id="cb59-9" title="9">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb59-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb59-11" title="11"></a>
<a class="sourceLine" id="cb59-12" title="12"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Which prints:</p>
<pre><code>&gt;&gt; node index.js
Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; ORDER BY &quot;Cat&quot;.&quot;age&quot; DESC LIMIT 1;
{
  &quot;id&quot;: 4,
  &quot;firstName&quot;: &quot;Markov&quot;,
  &quot;specialSkill&quot;: &quot;sleeping&quot;,
  &quot;age&quot;: 5,
  &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
  &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
}</code></pre>
<p>This returned the <code>Cat</code> object directly, not wrapped in an array.</p>
<p>If there is no record matching the criteria passed to <code>findOne</code>, it will return <code>null</code> (rather than an empty array):</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb61-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb61-2" title="2"></a>
<a class="sourceLine" id="cb61-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb61-4" title="4">  <span class="co">// Try to find a non-existant cat.</span></a>
<a class="sourceLine" id="cb61-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findOne</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb61-6" title="6">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb61-7" title="7">      <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Franklin Delano Catsevelt&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb61-8" title="8">    <span class="op">},</span></a>
<a class="sourceLine" id="cb61-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb61-10" title="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cat<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb61-11" title="11"></a>
<a class="sourceLine" id="cb61-12" title="12">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb61-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb61-14" title="14"></a>
<a class="sourceLine" id="cb61-15" title="15"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>No such cat exists:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;firstName&quot; = &#39;Franklin Delano Catsevelt&#39; LIMIT 1;
null</code></pre>
<h2 id="conclusion-3">Conclusion</h2>
<p>We’ve scratched the surface of the many query options supported by Sequelize. You may find more information as necessary by reading the <a href="https://sequelize.org/v5/manual/querying.html">Sequelize querying documentation</a>. You can in particular review the <a href="https://sequelize.org/v5/manual/querying.html#operators">list of Sequelize query operators</a>.</p>
<p>Now that you’ve completed this reading you should know how to:</p>
<ul>
<li>Use the <code>where</code> query option,</li>
<li>Use the <code>Op.and</code> operator to match <strong>all</strong> of multiple criteria,</li>
<li>Use the <code>Op.or</code> operator to match <strong>any</strong> of multiple criteria,</li>
<li>Use the <code>Op.ne</code> to match rows where the value <strong>does not equal</strong> the specified value,</li>
<li>Use the <code>Op.gt</code>, <code>Op.lt</code> operators to <strong>compare</strong> values,</li>
<li>Use the <code>order</code> query option to <strong>order</strong> results,</li>
<li>Use the <code>limit</code> query option to <strong>limit</strong> the number of returned results,</li>
<li>Use <code>findOne</code> when only one result is expected or desired.</li>
</ul>
<hr />
<h1 id="model-validations-with-sequelize">Model Validations With Sequelize</h1>
<p>It’s important to make sure that data stored to a database is not erroneous or incomplete. Imagine the following forms of “garbage data:”</p>
<ul>
<li>A <code>Cats</code> record with <code>firstName</code> set to <code>NULL</code>. All <code>Cats</code> ought to have a name.</li>
<li>A <code>Cats</code> record with <code>firstName</code> set to the empty string: <code>""</code>.</li>
<li>A <code>Cats</code> record with an <code>age</code> less than <code>0</code>. <code>age</code> must always be non-negative.</li>
<li>Perhaps the <code>specialSkill</code> should come from a pre-defined limited list of <code>["jumping", "sleeping", "purring"]</code>. A <code>Cats</code> record with a <code>specialSkill</code> of <code>"pearl diving"</code> would thus be invalid.</li>
</ul>
<p>Sequelize lets us write JavaScript code that will check that these data requirements are satisfied before saving a record to the database. The JavaScript code that does this is called a <em>validation</em>. A validation is code that makes sure that data is valid.</p>
<p>In this reading you will learn how to:</p>
<ol type="1">
<li>Validate that an attribute is not set to <code>NULL</code>.</li>
<li>Validate that a string attribute is not set to the empty string <code>""</code>.</li>
<li>Validate that a string attribute is not too long (has too many characters).</li>
<li>Validate that a numeric attribute meets minimum or maximum thresholds.</li>
<li>Validate that an attribute is within a limited set of options.</li>
</ol>
<h2 id="validating-that-an-attribute-is-not-null">Validating That An Attribute Is Not <code>NULL</code></h2>
<p>We should not allow a <code>Cat</code> to be saved to the database if it lacks</p>
<ol type="1">
<li>a <code>firstName</code>,</li>
<li>an <code>age</code>, or</li>
<li>a <code>specialSkill</code>.</li>
</ol>
<p>None of these should be set to <code>NULL</code>.</p>
<p>Before adding validations to check these requirements, let’s review what our <code>Cat</code> model code currently looks like:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb63-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb63-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb63-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb63-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb63-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb63-6" title="6">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb63-7" title="7">    <span class="dt">age</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb63-8" title="8">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb63-9" title="9">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb63-10" title="10">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb63-11" title="11">  <span class="op">};</span></a>
<a class="sourceLine" id="cb63-12" title="12">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb63-13" title="13"><span class="op">};</span></a></code></pre></div>
<p>We will modify our model definition to give more specific instructions to Sequelize about the <code>firstName</code>, <code>specialSkill</code>, and <code>age</code> attributes:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb64-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb64-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb64-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-6" title="6">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb64-7" title="7">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb64-8" title="8">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-9" title="9">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-10" title="10">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb64-11" title="11">        <span class="op">},</span></a>
<a class="sourceLine" id="cb64-12" title="12">      <span class="op">},</span></a>
<a class="sourceLine" id="cb64-13" title="13">    <span class="op">},</span></a>
<a class="sourceLine" id="cb64-14" title="14">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-15" title="15">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb64-16" title="16">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb64-17" title="17">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-18" title="18">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-19" title="19">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb64-20" title="20">        <span class="op">},</span></a>
<a class="sourceLine" id="cb64-21" title="21">      <span class="op">},</span></a>
<a class="sourceLine" id="cb64-22" title="22">    <span class="op">},</span></a>
<a class="sourceLine" id="cb64-23" title="23">    <span class="dt">age</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-24" title="24">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb64-25" title="25">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb64-26" title="26">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-27" title="27">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-28" title="28">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;age must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb64-29" title="29">        <span class="op">},</span></a>
<a class="sourceLine" id="cb64-30" title="30">      <span class="op">},</span></a>
<a class="sourceLine" id="cb64-31" title="31">    <span class="op">},</span></a>
<a class="sourceLine" id="cb64-32" title="32">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb64-33" title="33">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb64-34" title="34">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb64-35" title="35">  <span class="op">};</span></a>
<a class="sourceLine" id="cb64-36" title="36">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb64-37" title="37"><span class="op">};</span></a></code></pre></div>
<p>What has changed? We now map each attribute name (<code>firstName</code>, <code>specialSkill</code>, <code>age</code>) to a POJO that tells Sequelize how to configure that attribute. Here is the POJO for <code>firstName</code>:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb65-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb65-2" title="2">  <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb65-3" title="3">  <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb65-4" title="4">  <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb65-5" title="5">    <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb65-6" title="6">      <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb65-7" title="7">    <span class="op">},</span></a>
<a class="sourceLine" id="cb65-8" title="8">  <span class="op">},</span></a>
<a class="sourceLine" id="cb65-9" title="9"><span class="op">}</span></a></code></pre></div>
<p>The <code>type</code> attribute is of course vital: this used to be the only thing we specified. We’ve added two new attributes. The first is <code>allowNull: false</code>. This tells Sequelize not to let us set the <code>firstName</code> attribute to <code>NULL</code>.</p>
<p>The second attribute is <code>validate</code>. We will spend a lot of time examining this attribute in this reading. Validation logic for <code>firstName</code> is configured inside the <code>validate</code> attribute. Our <code>validate</code> configuration is:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb66-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb66-2" title="2">  <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb66-3" title="3">    <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb66-4" title="4">  <span class="op">},</span></a>
<a class="sourceLine" id="cb66-5" title="5"><span class="op">}</span></a></code></pre></div>
<p>This configuration tells Sequelize what error message to give if we try to set the <code>firstName</code> attribute to <code>NULL</code>. It’s odd that we have to set both <code>allowNull: false</code> and <code>notNull: { msg:  ... }</code>. This feels like unnecessary duplication. Regardless, that’s what Sequelize wants us to do. On the other hand, we do get a chance to specify the error message to print if the validation fails (<code>"firstName must not be null"</code>).</p>
<p>Let’s see how the validation logic helps us avoid saving junk data to our database:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb67-1" title="1"><span class="co">// index.js</span></a>
<a class="sourceLine" id="cb67-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb67-3" title="3"></a>
<a class="sourceLine" id="cb67-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb67-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="va">Cat</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb67-6" title="6">    <span class="co">// Empty cat. All fields set to `null`.</span></a>
<a class="sourceLine" id="cb67-7" title="7">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb67-8" title="8"></a>
<a class="sourceLine" id="cb67-9" title="9">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb67-10" title="10">    <span class="co">// Try to save cat to the database.</span></a>
<a class="sourceLine" id="cb67-11" title="11">    <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb67-12" title="12"></a>
<a class="sourceLine" id="cb67-13" title="13">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb67-14" title="14">    <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cat<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb67-15" title="15">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb67-16" title="16">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save failed!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb67-17" title="17"></a>
<a class="sourceLine" id="cb67-18" title="18">    <span class="co">// Print list of errors.</span></a>
<a class="sourceLine" id="cb67-19" title="19">    <span class="cf">for</span> (<span class="kw">const</span> validationError <span class="kw">of</span> <span class="va">err</span>.<span class="at">errors</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb67-20" title="20">      <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;*&quot;</span><span class="op">,</span> <span class="va">validationError</span>.<span class="at">message</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb67-21" title="21">    <span class="op">}</span></a>
<a class="sourceLine" id="cb67-22" title="22">  <span class="op">}</span></a>
<a class="sourceLine" id="cb67-23" title="23"></a>
<a class="sourceLine" id="cb67-24" title="24">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb67-25" title="25"><span class="op">}</span></a>
<a class="sourceLine" id="cb67-26" title="26"></a>
<a class="sourceLine" id="cb67-27" title="27"><span class="at">main</span>()</a></code></pre></div>
<p>Running this code prints:</p>
<pre><code>Save failed!
* firstName must not be null
* specialSkill must not be null
* age must not be null</code></pre>
<p>What happened? When we call the <code>save</code> method on a <code>Cat</code>, Sequelize will check that all the specified validations are satisfied. In this case none of them are! The <code>save</code> method will throw an exception, which we handle using <code>try { ... } catch (err) { ... }</code>.</p>
<p>What kind of exception? The thrown error is a <a href="https://sequelize.org/v5/class/lib/errors/validation-error.js~ValidationError.html"><code>ValidationError</code></a>. This has an <code>errors</code> attribute, which stores an array of <a href="https://sequelize.org/v5/class/lib/errors/validation-error.js~ValidationErrorItem.html"><code>ValidationErrorItem</code>s</a>. We print out the message for each item error.</p>
<p>Because there were validation failures, Sequelize <strong>will not save</strong> the invalid <code>Cats</code> record to the database. Sequelize thus keeps us from inserting junk data into the database.</p>
<p>If we want to save our <code>Cat</code> object, we would have to change its attributes to meet the validations (i.e., set them to something other than <code>NULL</code>) and call <code>save</code> a second time. For example:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb69-1" title="1"><span class="co">// index.js</span></a>
<a class="sourceLine" id="cb69-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb69-3" title="3"></a>
<a class="sourceLine" id="cb69-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb69-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="va">Cat</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb69-6" title="6">    <span class="co">// Empty cat. All fields set to `null`.</span></a>
<a class="sourceLine" id="cb69-7" title="7">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb69-8" title="8"></a>
<a class="sourceLine" id="cb69-9" title="9">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb69-10" title="10">    <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb69-11" title="11">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb69-12" title="12">    <span class="co">// The save will not succeed!</span></a>
<a class="sourceLine" id="cb69-13" title="13">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;We will fix and try again!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb69-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb69-15" title="15"></a>
<a class="sourceLine" id="cb69-16" title="16">  <span class="co">// Fix the various validation problems.</span></a>
<a class="sourceLine" id="cb69-17" title="17">  <span class="va">cat</span>.<span class="at">firstName</span> <span class="op">=</span> <span class="st">&quot;Markov&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb69-18" title="18">  <span class="va">cat</span>.<span class="at">specialSkill</span> <span class="op">=</span> <span class="st">&quot;sleeping&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb69-19" title="19">  <span class="va">cat</span>.<span class="at">age</span> <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></a>
<a class="sourceLine" id="cb69-20" title="20"></a>
<a class="sourceLine" id="cb69-21" title="21">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb69-22" title="22">    <span class="co">// Trying to save a second time!</span></a>
<a class="sourceLine" id="cb69-23" title="23">    <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb69-24" title="24"></a>
<a class="sourceLine" id="cb69-25" title="25">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb69-26" title="26">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb69-27" title="27">    <span class="co">// The save *should* succeed!</span></a>
<a class="sourceLine" id="cb69-28" title="28">    <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb69-29" title="29">  <span class="op">}</span></a>
<a class="sourceLine" id="cb69-30" title="30"></a>
<a class="sourceLine" id="cb69-31" title="31">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb69-32" title="32"><span class="op">}</span></a>
<a class="sourceLine" id="cb69-33" title="33"></a>
<a class="sourceLine" id="cb69-34" title="34"><span class="at">main</span>()</a></code></pre></div>
<h2 id="the-notempty-validation">The <code>notEmpty</code> Validation</h2>
<p>Even though we are not allowed to set <code>firstName</code> and <code>specialSkill</code> to <code>NULL</code>, we could still set them to the empty string <code>""</code>:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb70-1" title="1"><span class="co">// index.js</span></a>
<a class="sourceLine" id="cb70-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb70-3" title="3"></a>
<a class="sourceLine" id="cb70-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb70-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="va">Cat</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb70-6" title="6">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb70-7" title="7">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="st">&quot;&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb70-8" title="8">    <span class="dt">age</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></a>
<a class="sourceLine" id="cb70-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb70-10" title="10"></a>
<a class="sourceLine" id="cb70-11" title="11">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb70-12" title="12">    <span class="co">// Try to save cat to the database.</span></a>
<a class="sourceLine" id="cb70-13" title="13">    <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb70-14" title="14"></a>
<a class="sourceLine" id="cb70-15" title="15">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb70-16" title="16">    <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cat<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb70-17" title="17">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb70-18" title="18">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save failed!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb70-19" title="19"></a>
<a class="sourceLine" id="cb70-20" title="20">    <span class="co">// Print list of errors.</span></a>
<a class="sourceLine" id="cb70-21" title="21">    <span class="cf">for</span> (<span class="kw">const</span> validationError <span class="kw">of</span> <span class="va">err</span>.<span class="at">errors</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb70-22" title="22">      <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;*&quot;</span><span class="op">,</span> <span class="va">validationError</span>.<span class="at">message</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb70-23" title="23">    <span class="op">}</span></a>
<a class="sourceLine" id="cb70-24" title="24">  <span class="op">}</span></a>
<a class="sourceLine" id="cb70-25" title="25"></a>
<a class="sourceLine" id="cb70-26" title="26">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb70-27" title="27"><span class="op">}</span></a>
<a class="sourceLine" id="cb70-28" title="28"></a>
<a class="sourceLine" id="cb70-29" title="29"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<pre><code>Executing (default): INSERT INTO &quot;Cats&quot; (&quot;id&quot;,&quot;firstName&quot;,&quot;specialSkill&quot;,&quot;age&quot;,&quot;createdAt&quot;,&quot;updatedAt&quot;) VALUES (DEFAULT,$1,$2,$3,$4,$5) RETURNING *;
Save success!
{
  &quot;id&quot;: 8,
  &quot;firstName&quot;: &quot;&quot;,
  &quot;specialSkill&quot;: &quot;&quot;,
  &quot;age&quot;: 5,
  &quot;updatedAt&quot;: &quot;2020-02-12T21:34:49.250Z&quot;,
  &quot;createdAt&quot;: &quot;2020-02-12T21:34:49.250Z&quot;
}</code></pre>
<p>This is bogus: <code>Cats</code> records should have a non-empty <code>firstName</code> and <code>specialSkill</code>. We will therefore add a second validation for both <code>firstName</code> and <code>specialSkill</code>:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb72-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb72-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb72-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-6" title="6">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb72-7" title="7">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb72-8" title="8">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-9" title="9">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-10" title="10">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb72-11" title="11">        <span class="op">},</span></a>
<a class="sourceLine" id="cb72-12" title="12">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-13" title="13">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be empty&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb72-14" title="14">        <span class="op">},</span></a>
<a class="sourceLine" id="cb72-15" title="15">      <span class="op">},</span></a>
<a class="sourceLine" id="cb72-16" title="16">    <span class="op">},</span></a>
<a class="sourceLine" id="cb72-17" title="17">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-18" title="18">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb72-19" title="19">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb72-20" title="20">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-21" title="21">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-22" title="22">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb72-23" title="23">        <span class="op">},</span></a>
<a class="sourceLine" id="cb72-24" title="24">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-25" title="25">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must not be empty&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb72-26" title="26">        <span class="op">},</span></a>
<a class="sourceLine" id="cb72-27" title="27">      <span class="op">},</span></a>
<a class="sourceLine" id="cb72-28" title="28">    <span class="op">},</span></a>
<a class="sourceLine" id="cb72-29" title="29">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb72-30" title="30">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb72-31" title="31">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb72-32" title="32">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb72-33" title="33">  <span class="op">};</span></a>
<a class="sourceLine" id="cb72-34" title="34">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb72-35" title="35"><span class="op">};</span></a></code></pre></div>
<p>When we run the same <code>index.js</code> that tries to save the <code>Cats</code> record with the empty <code>firstName</code> and <code>specialSkill</code>, we now print:</p>
<pre><code>Save failed!
* firstName must not be empty
* specialSkill must not be empty</code></pre>
<p>Excellent! We’ve added the new validation by adding a <code>notEmpty</code> key to the <code>validate</code> POJO. Just like with <code>notNull</code>, we specify a message to print.</p>
<p>This is the typical story: we add new validations by adding new key/value pairs to the <code>validate</code> POJO. Sequelize provides many different kinds of validations for us, but we configure all of them in the same general manner.</p>
<h2 id="forbidding-long-string-values">Forbidding Long String Values</h2>
<p>We don’t want our cats to have names that are too long. We add a <code>len</code> validation like so:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb74-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb74-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb74-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb74-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb74-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb74-6" title="6">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb74-7" title="7">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb74-8" title="8">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb74-9" title="9">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb74-10" title="10">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb74-11" title="11">        <span class="op">},</span></a>
<a class="sourceLine" id="cb74-12" title="12">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb74-13" title="13">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be empty&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb74-14" title="14">        <span class="op">},</span></a>
<a class="sourceLine" id="cb74-15" title="15">        <span class="dt">len</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb74-16" title="16">          <span class="dt">args</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">8</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb74-17" title="17">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be more than eight letters long&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb74-18" title="18">        <span class="op">},</span></a>
<a class="sourceLine" id="cb74-19" title="19">      <span class="op">},</span></a>
<a class="sourceLine" id="cb74-20" title="20">    <span class="op">},</span></a>
<a class="sourceLine" id="cb74-21" title="21">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb74-22" title="22">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb74-23" title="23">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb74-24" title="24">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb74-25" title="25">  <span class="op">};</span></a>
<a class="sourceLine" id="cb74-26" title="26">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb74-27" title="27"><span class="op">};</span></a></code></pre></div>
<p>If we try to run:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb75-1" title="1"><span class="co">// index.js</span></a>
<a class="sourceLine" id="cb75-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb75-3" title="3"></a>
<a class="sourceLine" id="cb75-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb75-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="va">Cat</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb75-6" title="6">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Markov The Magnificent&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb75-7" title="7">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="st">&quot;sleeping&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb75-8" title="8">    <span class="dt">age</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></a>
<a class="sourceLine" id="cb75-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb75-10" title="10"></a>
<a class="sourceLine" id="cb75-11" title="11">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb75-12" title="12">    <span class="co">// Try to save cat to the database.</span></a>
<a class="sourceLine" id="cb75-13" title="13">    <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb75-14" title="14"></a>
<a class="sourceLine" id="cb75-15" title="15">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb75-16" title="16">    <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cat<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb75-17" title="17">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb75-18" title="18">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save failed!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb75-19" title="19"></a>
<a class="sourceLine" id="cb75-20" title="20">    <span class="co">// Print list of errors.</span></a>
<a class="sourceLine" id="cb75-21" title="21">    <span class="cf">for</span> (<span class="kw">const</span> validationError <span class="kw">of</span> <span class="va">err</span>.<span class="at">errors</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb75-22" title="22">      <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;*&quot;</span><span class="op">,</span> <span class="va">validationError</span>.<span class="at">message</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb75-23" title="23">    <span class="op">}</span></a>
<a class="sourceLine" id="cb75-24" title="24">  <span class="op">}</span></a>
<a class="sourceLine" id="cb75-25" title="25"></a>
<a class="sourceLine" id="cb75-26" title="26">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb75-27" title="27"><span class="op">}</span></a>
<a class="sourceLine" id="cb75-28" title="28"></a>
<a class="sourceLine" id="cb75-29" title="29"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>We will be told:</p>
<pre><code>Save failed!
* firstName must not be more than eight letters long</code></pre>
<p>The <code>len</code> validation gets a <code>msg</code> attribute as usual. We also configure <code>args: [0, 8]</code>. These are the “arguments” to the <code>len</code> validation. We are telling Sequelize to trigger a validation error if the <code>firstName</code> property has a length less than zero (impossible) or greater than eight.</p>
<p>Note that even though the <code>len</code> validation is not triggered for a length of zero, the <code>notEmpty</code> validation still will be.</p>
<p>If desired, we could use the <code>len</code> validation to set a true minimum length for a string. If we wanted a minimum length of two letters, we would just change <code>args: [2, 8]</code>. (We ought also update the <code>msg</code> appropriately.)</p>
<h2 id="validating-that-a-numeric-value-is-within-a-specified-range">Validating That A Numeric Value Is Within A Specified Range</h2>
<p>A <code>Cat</code> should never have a negative age. Perhaps, also, a <code>Cat</code> should have a theoretical maximum age of 99 years. We can add validations to enforce these requirements:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb77-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb77-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb77-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb77-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb77-5" title="5">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb77-6" title="6">    <span class="dt">age</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb77-7" title="7">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb77-8" title="8">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb77-9" title="9">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb77-10" title="10">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb77-11" title="11">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;age must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb77-12" title="12">        <span class="op">},</span></a>
<a class="sourceLine" id="cb77-13" title="13">        <span class="dt">min</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb77-14" title="14">          <span class="dt">args</span><span class="op">:</span> [<span class="dv">0</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb77-15" title="15">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;age must not be less than zero&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb77-16" title="16">        <span class="op">},</span></a>
<a class="sourceLine" id="cb77-17" title="17">        <span class="dt">max</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb77-18" title="18">          <span class="dt">args</span><span class="op">:</span> [<span class="dv">99</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb77-19" title="19">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;age must not be greater than 99&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb77-20" title="20">        <span class="op">},</span></a>
<a class="sourceLine" id="cb77-21" title="21">      <span class="op">},</span></a>
<a class="sourceLine" id="cb77-22" title="22">    <span class="op">},</span></a>
<a class="sourceLine" id="cb77-23" title="23">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb77-24" title="24">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb77-25" title="25">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb77-26" title="26">  <span class="op">};</span></a>
<a class="sourceLine" id="cb77-27" title="27">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb77-28" title="28"><span class="op">};</span></a></code></pre></div>
<p>You can see that the <code>min</code> and <code>max</code> validations are configured in the same sort of way that the <code>len</code> validation is.</p>
<p>If we try to save a <code>Cat</code> with an <code>age</code> of <code>-1</code>, we are printed:</p>
<pre><code>Save failed!
* age must not be less than zero</code></pre>
<p>Likewise, if we try to save a <code>Cat</code> with an <code>age</code> of <code>123</code> we are printed:</p>
<pre><code>Save failed!
* age must not be greater than 99</code></pre>
<p><em>(Note: I’ve stopped repeating our <code>index.js</code> file, since there are only trivial modifications to a <code>Cat</code>’s attributes each time.)</em></p>
<h2 id="validating-that-an-attribute-is-among-a-finite-set-of-values">Validating That An Attribute Is Among A Finite Set Of Values</h2>
<p>Let’s say that a <code>Cat</code>’s <code>specialSkill</code> should be restricted to a pre-defined list of <code>["jumping", "sleeping", "purring"]</code>. That is: a <code>Cat</code> should not be allowed to have just any <code>specialSkill</code>. The <code>specialSkill</code> must be on the list.</p>
<p>We can enforce this requirement like so:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb80-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb80-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb80-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-5" title="5">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb80-6" title="6">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-7" title="7">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb80-8" title="8">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb80-9" title="9">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-10" title="10">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-11" title="11">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb80-12" title="12">        <span class="op">},</span></a>
<a class="sourceLine" id="cb80-13" title="13">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-14" title="14">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must not be empty&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb80-15" title="15">        <span class="op">},</span></a>
<a class="sourceLine" id="cb80-16" title="16">        <span class="dt">isIn</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-17" title="17">          <span class="dt">args</span><span class="op">:</span> [[<span class="st">&quot;jumping&quot;</span><span class="op">,</span> <span class="st">&quot;sleeping&quot;</span><span class="op">,</span> <span class="st">&quot;purring&quot;</span>]]<span class="op">,</span></a>
<a class="sourceLine" id="cb80-18" title="18">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must be either jumping, sleeping, or purring&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb80-19" title="19">        <span class="op">},</span></a>
<a class="sourceLine" id="cb80-20" title="20">      <span class="op">},</span></a>
<a class="sourceLine" id="cb80-21" title="21">    <span class="op">},</span></a>
<a class="sourceLine" id="cb80-22" title="22">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb80-23" title="23">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb80-24" title="24">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb80-25" title="25">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb80-26" title="26">  <span class="op">};</span></a>
<a class="sourceLine" id="cb80-27" title="27">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb80-28" title="28"><span class="op">};</span></a></code></pre></div>
<p>Notice how we <strong>doubly-nest</strong> the list of special skills (<code>["jumping, "sleeping", "purring"]</code>) when specifying the <code>args</code> for the <code>isIn</code> validation. This is because we want to pass <strong>one</strong> argument: an array of three possible special skills.</p>
<p>Now when we try to save a <code>Cat</code> with <code>specialSkill</code> set to <code>"pearl diving"</code>, our code will print:</p>
<pre><code>Save failed!
* specialSkill must be either jumping, sleeping, or purring</code></pre>
<h2 id="conclusion-4">Conclusion</h2>
<p>There is a very large variety of validations that are provided by Sequelize. You can find many more in the Sequelize <a href="https://sequelize.org/v5/manual/models-definition.html#validations">documentation for validations</a>.</p>
<p>Having completed this reading, you now know how to:</p>
<ol type="1">
<li>Validate that an attribute is not set to <code>NULL</code>.</li>
<li>Validate that a string attribute is not set to the empty string <code>""</code>.</li>
<li>Validate that a string attribute is not too long (has too many characters).</li>
<li>Validate that a numeric attribute meets minimum or maximum thresholds.</li>
<li>Validate that an attribute is within a limited set of options.</li>
</ol>
<hr />
<h1 id="recipe-box-with-sequelize-project">Recipe Box With Sequelize Project</h1>
<p>In this project, you will build the Data Access Layer to power a Web application. Unlike previously, you will use the Sequelize library and tools to do this to build a more maintainable application.</p>
<p>It has more steps than the SQL version, but it’s more maintainable in the long run. Also, the SQL version hid a lot of complexity from you with respect to the running of the SQL. Go look at the SQL version of the files in the <strong>controllers</strong> directory to see what we had to do to load the SQL and execute it.</p>
<p>Now, compare the <em>simplicity</em> of those with the simplicity of the files in the <strong>controllers</strong> directory for <em>this</em> version of the application. It’s easier to understand <em>this</em> version. You want to know where to add a column to a table? Go to the migrations. You want to know where to fix a query? Go to the proper repository file.</p>
<p>It’s just <em>so</em> much better organized.</p>
<p>Quite often, you will see that you will have more files and, overall, more lines of code in well-organized, highly-maintainable software project. Remembering where code is <em>is hard</em>. That’s why having clearly-named files and directories is so very important.</p>
<h2 id="the-data-model-analysis">The data model analysis</h2>
<p>This looks no different because it’s the same application.</p>
<p>What goes into a recipe box? Why, recipes, of course! Here’s an example recipe card.</p>
<figure>
<img src="images/sql-recipe-card.jpeg" alt="Recipe card" /><figcaption>Recipe card</figcaption>
</figure>
<p>You can see that a recipe is made up of three basic parts:</p>
<ul>
<li>A title,</li>
<li>A list of ingredients, and</li>
<li>A list of instructions.</li>
</ul>
<p>You’re going to add a little more to that, too. It will also have</p>
<ul>
<li>The date/time that it was entered into the recipe box, and</li>
<li>The date/time it was last updated in the recipe box.</li>
</ul>
<p>These are good pieces of data to have so that you can show them “most recent” for example.</p>
<p>Ingredients themselves are complex data types and need their own structure. They “belong” to a recipe. That means they’ll need to reference that recipe. That means an ingredient is made up of:</p>
<ul>
<li>An amount (optional),</li>
<li>A unit of measure (optional),</li>
<li>The actual food stuff, and</li>
<li>The id of the recipe that it belongs to.</li>
</ul>
<p>That unit of measure is a good candidate for normalization, don’t you think? It’s a predefined list of options that should not change and that you don’t want people just typing whatever they want in there, not if you want to maintain data integrity. Otherwise, you’ll end up with “C”, “c”, “cup”, “CUP”, “Cup”, and all the other permutations, each of which is a distinct value but means the same thing.</p>
<p>Instructions are also complex objects, but not by looking at them. Initially, one might only see text that comprises an instruction. But, very importantly, instructions have <em>order</em>. They also <em>belong</em> to the recipe. With that in mind, an instruction is made up of:</p>
<ul>
<li>The text of the instruction,</li>
<li>The order that it appears in the recipe, and</li>
<li>The id of the recipe that it belongs to.</li>
</ul>
<p>That is enough to make a good model for the recipe box.</p>
<figure>
<img src="images/sql-recipe-box-data-model.png" alt="recipe box data model" /><figcaption>recipe box data model</figcaption>
</figure>
<h2 id="the-application">The application</h2>
<p>The application is a standard <a href="https://www.expressjs.com">express.js</a> application using the <a href="https://pugjs.org">pug</a> library to generate the HTML and the <a href="https://node-postgres.com">node-postgres</a> library to connect to the database.</p>
<p>It already has <a href="https://www.npmjs.com/package/sequelize">sequelize</a> and <a href="https://www.npmjs.com/package/sequelize-cli">sequelize-cli</a> installed.</p>
<h2 id="getting-started">Getting started</h2>
<ul>
<li>Clone the starter project from https://github.com/appacademy-starters/sql-orm-recipe-box</li>
<li>Run <code>npm install</code> to install the packages</li>
<li>Run <code>npm run dev</code> to start the server on port 3000</li>
</ul>
<p>You’ll do all of your work in the <strong>data-access-layer</strong> directory. In there, you will find a series of JS files. Each of these will hold your JavaScript code rather than SQL code.</p>
<h2 id="your-code">Your code</h2>
<p>You’re going to be using JavaScript and the tools of Sequelize. Keep the <a href="https://sequelize.org/v5/">Sequelize documentation</a> open and handy. Even developers that use ORMs every day will keep the documentation open because there’s so much to know about them.</p>
<h2 id="phase-1-initialize-the-sequelize-project">Phase 1: Initialize the Sequelize project</h2>
<p>Because this project already has <a href="https://www.npmjs.com/package/sequelize-cli">sequelize-cli</a> installed, you can initialize the project by typing <code>npx sequelize-cli init</code>. The <code>npx</code> command runs locally-installed tools. That will create the project structure that Sequelize expects for us to continue to use its tools.</p>
<h2 id="phase-2-create-a-database-user-for-the-project">Phase 2: Create a database user for the project</h2>
<p>Using a PostgreSQL client like <code>psql</code> or Postbird, create a new user for this application named “sequelize_recipe_box_app” with the password “HfKfK79k” <em>and</em> the ability to create a database. Here’s the <a href="https://www.postgresql.org/docs/current/sql-createuser.html">link to the CREATE USER documentation</a> so that you can determine which options to give.</p>
<h2 id="phase-2-change-the-connection-configuration">Phase 2: Change the connection configuration</h2>
<p>The project contains a directory named <strong>config</strong>. Inside there, you will find a file named <strong>config.json</strong>. You need to make some configuration changes.</p>
<ul>
<li>Change all the “user” and “password” values to the information for the user that you created in Phase 2.</li>
<li>Change the “database” values to be “recipe_box_development”, “recipe_box_test”, and “recipe_box_production”.</li>
<li>Change all of the “dialect” values from “mysql” to “postgres”.</li>
<li>Delete all of the “operatorAliases” entries. It’s to support earlier versions of the Sequelize library. Make sure to remove the comma from the preceding line so that it’s valid JSON.</li>
<li>Because you’ll be using seed data in this project, add <code>"seederStorage": "sequelize"</code> to each of the different blocks so that Sequelize CLI won’t run a seeder more than once causing duplicate entries in the database.</li>
</ul>
<p>That will configure the application and the Sequelize tools to properly connect to your development database.</p>
<h2 id="phase-3-create-your-database">Phase 3: Create your database</h2>
<p>Rather than writing SQL to do this, you will use the tools. Run</p>
<pre><code>npx sequelize-cli db:create</code></pre>
<p>That runs the Sequelize CLI with the command <code>db:create</code>.</p>
<p>When you run this, it will default to the “development” setting and read the information from the configuration file to create your database for you! It should print out something like</p>
<pre><code>Sequelize CLI [Node: 10.19.0, CLI: 5.5.1, ORM: 5.21.5]

Loaded configuration file &quot;config/config.json&quot;.
Using environment &quot;development&quot;.
Database recipe_box_development created.</code></pre>
<p>You can also drop the database by typing … you guessed it! The Sequelize CLI with the command <code>db:drop</code>!</p>
<pre><code>npx sequelize-cli db:drop</code></pre>
<p>If you run that, run the “create” command, again, so the database exists.</p>
<h2 id="phase-4-the-units-of-measurement-data">Phase 4: The units of measurement data</h2>
<p>Just as a review, here is the specification for the table that holds units of measurement.</p>
<table>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Column Type</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>SERIAL</td>
<td>PK</td>
</tr>
<tr class="even">
<td>name</td>
<td>VARCHAR(20)</td>
<td>NOT NULL</td>
</tr>
</tbody>
</table>
<p>Luckily, the Sequelize models and migrations take care of the “id” property for you without you having to do anything. So, you can just focus on that “name” property.</p>
<h3 id="create-a-migration">Create a migration</h3>
<p>It’s time to create the first migration, the one that defines the table that will hold units of measure. You can use the Sequelize CLI to generate the migration for you. You can <em>also</em> tell it to create a model for you, and it will create a migration along <em>with</em> the model. You should do that to get the biggest return on investment for the characters that you will type.</p>
<p>The command is <code>model:generate</code> and it takes a couple of arguments, “–name” which contains the name of the model (as a singular noun) to generate, and “–attributes” which has a comma-separated list of “property-name:data-type” pairs.</p>
<p><strong>Learning Tip</strong>: It is <em>so very important</em> that you don’t copy and paste this. Type these things out so it has a better chance of creating durable knowledge.</p>
<pre><code>npx sequelize-cli model:generate \
  --name MeasurementUnit \
  --attributes name:string</code></pre>
<p>That will create two files, if everything works well. (The name of your migration file will be different because it’s time-based.)</p>
<pre><code>New model was created at models/measurementunit.js
New migration was created at migrations/20200101012349-MeasurementUnit.js</code></pre>
<p>The <strong>model</strong> file will be used by the application to query the database. It will be used by the express.js application. It is part of the running software.</p>
<p>The <strong>migration</strong> file is used to construct the database. It is only used by the Sequelize CLI tool to build the database. Unlike those schema and seed files that you had in the SQL version of this project which destroyed <em>everything</em> when run, migrations are designed to change your database as your application grows. This is a much better strategy so that existing data in the databases that other people use aren’t damaged.</p>
<p>Because the data model requires the “name” column to be both non-null <em>and</em> unique, you have to add some information to the migration file. Open it and, for the “name” property, make non-nullable by looking at how the other properties are configured. Then, add the “unique” property set to <code>true</code> to the “name” configuration, as well. That should be enough for Sequelize to create the table for you.</p>
<p>The last thing to do is to change the length of the “name” property. By default, Sequelize will make it 255 characters long. The specification for the table says it should really only be 20 characters. To tell the migration that, change the type for “name” from <code>Sequelize.STRING</code> to <code>Sequelize.STRING(20)</code>.</p>
<h2 id="run-your-migration">Run your migration</h2>
<p>If you now run your migration with the Sequelize CLI, it will create the table for you.</p>
<pre><code>npx sequelize-cli db:migrate</code></pre>
<p>That should give you some output that looks similar to this.</p>
<pre><code>Loaded configuration file &quot;config/config.json&quot;.
Using environment &quot;development&quot;.
== 20200101012349-create-measurement-unit: migrating =======
== 20200101012349-create-measurement-unit: migrated (0.021s)</code></pre>
<p>You can confirm that the table “MeasurementUnits” is created by using your PostgreSQL client. You’ll also see that another table is created, “SequelizeMeta”, which contains information about which migration has most recently been run. It contains a single column, “name”. Each row contains an entry of which migration file has run. Now that you’ve run your migration file, the table contains one entry, the name of your migration file. When you run more migrations, you will see more rows, each containing the name of the file that you’ve run.</p>
<p><strong>psql Note</strong>: If you are using <code>psql</code> as you PostgreSQL command, be aware that it will lowercase any entity and column names you type in there. If you type <code>SELECT * FROM MeasurementUnits</code>, it converts that to <code>SELECT * FROM measurementunits</code> before running it. To prevent that from happening, use quotation marks around the table name. <code>SELECT * FROM "MeasurementUnits"</code> will do the trick.</p>
<p>It’s important that you <em>never</em> change the name of a migration file after it’s been run.</p>
<p>In the real world, you should <em>never</em> change the content of a migration file after it’s been committed and shared in your Git repository. Asking others to rollback their migrations just because you changed one of yours is bad manners. Instead, you should add a new migration that makes the change that you want.</p>
<h2 id="create-the-seed-data">Create the seed data</h2>
<p>You can create the seed data for the unit of measurements by creating a <strong>seeder</strong> as the Sequelize CLI calls them. You can create one using the Sequelize CLI tool. Run the following and make sure you don’t get any errors.</p>
<pre><code>npx sequelize-cli seed:generate --name default-measurement-units</code></pre>
<p>Now, you want to insert the seed data. You will do this by using the <code>bulkInsert</code> method of the object passed in through the <code>queryInterface</code> parameter of the <code>up</code> method. Feel free to delete the comment in the <code>up</code> method and replace it with this.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb90-1" title="1"><span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkInsert</span>(<span class="st">&#39;MeasurementUnits&#39;</span><span class="op">,</span> [</a>
<a class="sourceLine" id="cb90-2" title="2">  <span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;cups&#39;</span><span class="op">,</span> <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span> <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>() <span class="op">},</span></a>
<a class="sourceLine" id="cb90-3" title="3">])<span class="op">;</span></a></code></pre></div>
<p>The <code>bulkInsert</code> method takes two parameters:</p>
<ul>
<li>The name of the table to insert into, and</li>
<li>An array of objects that have property names that match the column names in the table.</li>
</ul>
<p>You can see that the first object has been provided by the example. Now, create objects for all of these values, as well. (The empty item in the list is an empty string and is intentional) Make sure you do them <strong>in this order,</strong> or when we get to the seed data for the other tables it won’t work. (We’ve supplied you with files for the seed data for the other tables because there is a lot of it)</p>
<ul>
<li>“fluid ounces”</li>
<li>“gallons”</li>
<li>“grams”</li>
<li>“liters”</li>
<li>“milliliters”</li>
<li>“ounces”</li>
<li>“pinch”</li>
<li>“pints”</li>
<li>“pounds”</li>
<li>“quarts”</li>
<li>“tablespoons”</li>
<li>“teaspoons”</li>
<li>""</li>
<li>“cans”</li>
<li>“slices”</li>
<li>“splash”</li>
</ul>
<p>Now, run the Sequelize CLI with the command <code>db:seed:all</code>.</p>
<p>After you get that done, you can confirm that all of the records (rows) were created in the “MeasurementUnits” table.</p>
<h2 id="phase-5-the-recipe-table-model">Phase 5: The recipe table model</h2>
<p>This will go much like the last one, except there’s no seed data. Just to refresh your memory, here’s the specification for the “recipes” table.</p>
<table>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Column Type</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>SERIAL</td>
<td>PK</td>
</tr>
<tr class="even">
<td>title</td>
<td>VARCHAR(200)</td>
<td>NOT NULL</td>
</tr>
<tr class="odd">
<td>created</td>
<td>TIMESTAMP</td>
<td>NOT NULL, DEFAULT CURRENT_TIMESTAMP</td>
</tr>
<tr class="even">
<td>updated</td>
<td>TIMESTAMP</td>
<td>NOT NULL, DEFAULT CURRENT_TIMESTAMP</td>
</tr>
</tbody>
</table>
<p>As you’ve discovered, Sequelize takes care of the “id” for you <em>and</em> the columns to track when the recipe has been created and updated! Your job is to</p>
<ul>
<li>Generate a model for the “recipe”</li>
<li>Customize the migration so the “title” column is not nullable</li>
</ul>
<p>Run your migration and confirm that you defined it correctly by checking the attributes in the description of the table. The important parts to check are that the “title” column is a VARCHAR(200) and is non-nullable. (The “Collation” column has been removed for brevity.)</p>
<pre><code>                  Table &quot;public.Recipes&quot;
  Column   |           Type           | Nullable |  Default
-----------+--------------------------+----------+------------
 id        | integer                  | not null | nextval(...
 title     | character varying(200)   | not null |
 createdAt | timestamp with time zone | not null |
 updatedAt | timestamp with time zone | not null |
Indexes:
    &quot;Recipes_pkey&quot; PRIMARY KEY, btree (id)</code></pre>
<h2 id="phase-6-the-instruction-table-model">Phase 6: The instruction table model</h2>
<p>Now, things get a little trickier because this model will reference the recipe model. Here’s the specification for the “instructions” table.</p>
<table>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Column Type</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>SERIAL</td>
<td>PK</td>
</tr>
<tr class="even">
<td>specification</td>
<td>TEXT</td>
<td>NOT NULL</td>
</tr>
<tr class="odd">
<td>listOrder</td>
<td>INTEGER</td>
<td>NOT NULL</td>
</tr>
<tr class="even">
<td>recipeId</td>
<td>INTEGER</td>
<td>FK, NOT NULL</td>
</tr>
</tbody>
</table>
<p>When you type out your migration generation command, the “–attributes” parameter will look like this:</p>
<pre><code>--attributes column1:type1,column2:type2,column3:type3</code></pre>
<p>Instead of using “string” for the “specification” column of the table, use “text” to generate a TEXT column.</p>
<p>After it generates the migration file, modify each of the column descriptors in the migration so that the columns are not nullable. Then, add a new property to the one for “recipeId” called “references” that is an object that contains a “model” property set to “Recipes”. It should look like this.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb93-1" title="1">recipeId<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb93-2" title="2">  <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb93-3" title="3">  <span class="dt">references</span><span class="op">:</span> <span class="op">{</span> <span class="dt">model</span><span class="op">:</span> <span class="st">&quot;Recipes&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb93-4" title="4">  <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb93-5" title="5"><span class="op">},</span></a></code></pre></div>
<p>With that in place, run the migration. Then, check the table definition in your PostgreSQL client.</p>
<pre><code>                   Table &quot;public.Instructions&quot;
    Column     |           Type           | Nullable |     Default
---------------+--------------------------+----------+-----------------
 id            | integer                  | not null | nextval(&#39;&quot;Ins...
 specification | text                     | not null |
 listOrder     | integer                  | not null |
 recipeId      | integer                  | not null |
 createdAt     | timestamp with time zone | not null |
 updatedAt     | timestamp with time zone | not null |
Indexes:
    &quot;Instructions_pkey&quot; PRIMARY KEY, btree (id)
Foreign-key constraints:
    &quot;Instructions_recipeId_fkey&quot; FOREIGN KEY (&quot;recipeId&quot;)
                                 REFERENCES &quot;Recipes&quot;(id)</code></pre>
<p>You should see all non-null columns and a foreign key between the “Instructions” table and the “Recipes” table.</p>
<h2 id="phase-7-the-ingredients-model">Phase 7: The ingredients model</h2>
<p>The model for ingredients has <em>two</em> foreign keys. Create the model and migration for it. Here’s the table specification.</p>
<table>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Column Type</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>SERIAL</td>
<td>PK</td>
</tr>
<tr class="even">
<td>amount</td>
<td>NUMERIC(5, 2)</td>
<td>NOT NULL</td>
</tr>
<tr class="odd">
<td>measurementUnitId</td>
<td>INTEGER</td>
<td>FK, NOT NULL</td>
</tr>
<tr class="even">
<td>foodStuff</td>
<td>VARCHAR(500)</td>
<td>NOT NULL</td>
</tr>
<tr class="odd">
<td>recipeId</td>
<td>INTEGER</td>
<td>FK, NOT NULL</td>
</tr>
</tbody>
</table>
<p>After you modify and run your migration, you should have a table in your database that looks like this, with two foreign keys, one to the “Recipes” table and the other to the “MeasurementUnits” table.</p>
<pre><code>                       Table &quot;public.Ingredients&quot;
      Column       |           Type           | Nullable |      Default
-------------------+--------------------------+----------+-----------------
 id                | integer                  | not null | nextval(&#39;&quot;Ing...
 amount            | numeric(5,2)             | not null |
 measurementUnitId | integer                  | not null |
 foodStuff         | character varying(500)   | not null |
 recipeId          | integer                  | not null |
 createdAt         | timestamp with time zone | not null |
 updatedAt         | timestamp with time zone | not null |
Indexes:
    &quot;Ingredients_pkey&quot; PRIMARY KEY, btree (id)
Foreign-key constraints:
    &quot;Ingredients_measurementUnitId_fkey&quot;
        FOREIGN KEY (&quot;measurementUnitId&quot;)
        REFERENCES &quot;MeasurementUnits&quot;(id)
    &quot;Ingredients_recipeId_fkey&quot;
        FOREIGN KEY (&quot;recipeId&quot;)
        REFERENCES &quot;Recipes&quot;(id)</code></pre>
<h2 id="phase-8-seed-data-for-all-of-the-tables">Phase 8: Seed data for all of the tables</h2>
<p>Now that you have tables in the database, it’s time to create some seed data for all of them. In the <strong>data-access-layer</strong> directory, you will find three text files each containing JavaScript objects on each row that match the tables in the previous three sections.</p>
<p>If you didn’t seed the MeasurementUnits data in the correct order listed in the section above, you may have to redo that seed file, because the data from the text files depends on the ids of the data in the <code>MeasurementUnits</code> table being correct.</p>
<p>There are three tables to seed: Ingredients, Instructions, and Recipes. It is important to note that you will need to seed them in the correct order due to foreign key dependencies.</p>
<p>Look at the data model for the application, again.</p>
<figure>
<img src="images/sql-recipe-box-data-model.png" alt="recipe box data model" /><figcaption>recipe box data model</figcaption>
</figure>
<p>You can see that the Instructions depends on Recipes because it has the foreign key “recipeId” to the Recipes table. You can also see that the Ingredients table has dependencies on the Recipes and MeasurementUnits tables because of its foreign keys “measurementUnitId” and “recipeId”. (You’ve already seeded the MeasurementUnits table in Phase 4, so that data exists for use by the Ingredients table.) Recipes does not have any foreign keys. You need to seed Recipes, first, because it does not have any foreign keys and, therefore, does not have any data dependencies. Then, you can seed the Instructions and Ingredients tables in either order because their data dependencies will have been met.</p>
<p>Create seeder files for them in that order: Recipes, first, then Ingredients and Instructions. Use the contents of each of the text files in <strong>data-access-layer</strong> to do bulk inserts.</p>
<p>After you create each seed file, run</p>
<pre><code>npx sequelize-cli db:seed:all</code></pre>
<p>to make sure you don’t have any errors. If you do, fix them before moving onto the next seed file.</p>
<p>If you end up seeding the data in the wrong order and getting a foreign key constraint error, just use the CLI to drop the database, create the database, migrate the database, and then you can try running your seeders, again. You may need to rename your migration filenames to get your seeds running in the correct order.</p>
<h2 id="phase-9-updating-models-with-references">Phase 9: Updating models with references</h2>
<p>Now that you have all of the migrations set up correctly and a database defined, it is time for you to turn your attention to the model files that were generated in the previous phases.</p>
<p>Consider the relationship between an Instruction and a Recipe. A Recipe <em>has many</em> Instructions. In the other direction, you would say that an Instruction <em>has one</em> Recipe, or that Instruction <em>belongs to</em> the Recipe. To set that up in your model, open the file <strong>models/recipe.js</strong>. In there, you will see the following.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb97-1" title="1"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb97-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb97-3" title="3">  <span class="kw">const</span> Recipe <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Recipe&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb97-4" title="4">    <span class="dt">title</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb97-5" title="5">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb97-6" title="6">  <span class="va">Recipe</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb97-7" title="7">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb97-8" title="8">  <span class="op">};</span></a>
<a class="sourceLine" id="cb97-9" title="9">  <span class="cf">return</span> Recipe<span class="op">;</span></a>
<a class="sourceLine" id="cb97-10" title="10"><span class="op">};</span></a></code></pre></div>
<p>In the <code>associate</code> function is where you can define the association between the Recipe and the Instruction. Replace the comment with the following statement.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb98-1" title="1"><span class="va">Recipe</span>.<span class="at">hasMany</span>(<span class="va">models</span>.<span class="at">Instruction</span><span class="op">,</span> <span class="op">{</span> <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;recipeId&#39;</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>This instructs Sequelize that Recipe should have a collection of Instruction objects associated with it. To insure that Sequelize uses the foreign key column that you created on the “Instructions” table in your migration, you must specify it as part of the collection definition.</p>
<p>In the file <strong>models/instruction.js</strong>, replace the comment with the following to define the other side of the relationship.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb99-1" title="1"><span class="va">Instruction</span>.<span class="at">belongsTo</span>(<span class="va">models</span>.<span class="at">Recipe</span><span class="op">,</span> <span class="op">{</span> <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;recipeId&#39;</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>This instructs Sequelize that Instruction has a single Recipe object associated with it. Again, because of inconsistent naming conventions used by Sequelize, you must specify the foreign key column name in the “Instructions” table.</p>
<p>Think about the many-to-one and one-to-many relationships between Ingredient, MeasurementUnit, and Recipe. Then, modify those model files accordingly with the <code>hasMany</code> and <code>belongsTo</code> associations, always specifying the name of the foreign key column that binds the two tables together.</p>
<h2 id="phase-10-updating-models-with-validations">Phase 10: Updating models with validations</h2>
<p>Now that you have seed data created, it will be important to prevent users from entering data that does not meet the expectations of the data model.</p>
<p>Consider the content of <strong>models/instruction.js</strong></p>
<div class="sourceCode" id="cb100"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb100-1" title="1"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb100-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb100-3" title="3">  <span class="kw">const</span> Instruction <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Instruction&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb100-4" title="4">    <span class="dt">specification</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">TEXT</span><span class="op">,</span></a>
<a class="sourceLine" id="cb100-5" title="5">    <span class="dt">listOrder</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb100-6" title="6">    <span class="dt">recipeId</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb100-7" title="7">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb100-8" title="8">  <span class="va">Instruction</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb100-9" title="9">    <span class="va">Instruction</span>.<span class="at">belongsTo</span>(<span class="va">models</span>.<span class="at">Recipe</span><span class="op">,</span> <span class="op">{</span> <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;recipeId&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb100-10" title="10">  <span class="op">};</span></a>
<a class="sourceLine" id="cb100-11" title="11">  <span class="cf">return</span> Instruction<span class="op">;</span></a>
<a class="sourceLine" id="cb100-12" title="12"><span class="op">};</span></a></code></pre></div>
<p>It would be nice if the model could validate each of those properties to make sure that no one sets them to null and that <code>listOrder</code> is greater than 0, for example. You can do that with <a href="https://sequelize.org/master/manual/validations-and-constraints.html#per-attribute-validations">per-attribute validations</a>.</p>
<p>For example, you can change the above code to the following to make sure that the “specification” property won’t get set to an empty string when someone tries to save the object.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb101-1" title="1"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb101-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb101-3" title="3">  <span class="kw">const</span> Instruction <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Instruction&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb101-4" title="4">    <span class="dt">specification</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb101-5" title="5">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">TEXT</span><span class="op">,</span></a>
<a class="sourceLine" id="cb101-6" title="6">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb101-7" title="7">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb101-8" title="8">      <span class="op">},</span></a>
<a class="sourceLine" id="cb101-9" title="9">    <span class="op">},</span></a>
<a class="sourceLine" id="cb101-10" title="10">    <span class="dt">listOrder</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb101-11" title="11">    <span class="dt">recipeId</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb101-12" title="12">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb101-13" title="13">  <span class="va">Instruction</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb101-14" title="14">    <span class="va">Instruction</span>.<span class="at">belongsTo</span>(<span class="va">models</span>.<span class="at">Recipe</span><span class="op">,</span> <span class="op">{</span> <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;recipeId&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb101-15" title="15">  <span class="op">};</span></a>
<a class="sourceLine" id="cb101-16" title="16">  <span class="cf">return</span> Instruction<span class="op">;</span></a>
<a class="sourceLine" id="cb101-17" title="17"><span class="op">};</span></a></code></pre></div>
<p>Make sure all of the other string properties in the models won’t allow the empty string to be set on them.</p>
<h2 id="phase-11-cascade-delete-for-recipes">Phase 11: Cascade delete for recipes</h2>
<p>The Recipe model has dependencies: the Instruction and the Ingredient both have <em>belongs to</em> relationships. This means that the row in the “Recipes” table must exist to have records in the “Ingredients” and “Instructions” table. If you try to delete a Recipe row from the database that has either Instructions or Ingredients, it won’t work due to referential integrity. You would have to delete all of the Ingredients and Instructions <em>before</em> being able to delete the Recipe.</p>
<p>Sequelize provides a handy shortcut for that and will manage deleting the associated records for you when you delete a row from the Recipes table. It’s called a <em>cascading delete</em>. Open the <strong>models/recipe.js</strong> file. In there, modify the second argument of each of the <code>hasMany</code> calls to include two new property/value pairs:</p>
<ul>
<li><code>onDelete: 'CASCADE'</code></li>
<li><code>hooks: true</code></li>
</ul>
<p>Refer to the documentation on <a href="https://sequelize.org/master/manual/hooks.html#associations">Associations</a> to see an example. But, don’t delete the <code>foreignKey</code> property that you put there in Phase 9.</p>
<h2 id="phase-12-building-the-repositories">Phase 12: Building the repositories</h2>
<p>Now that you have the seeds, models, and migrations out of the way, you can build the data access layer with a lot of speed. Sequelize will now handle all of the SQL generation for you. You can just use the models that you’ve painstakingly crafted.</p>
<p>Because you are writing JavaScript files, you want the server to restart because it won’t automatically reload the changed JavaScript that you’re writing. To that end, you will use a different command while developing.</p>
<pre><code>npm run dev</code></pre>
<p>This runs a special script that will reload the JavaScript in the data access layer every time you make a change. You can see what’s run in the <strong>package.json</strong> file in this project in the “scripts” section for the “dev” property.</p>
<p>You will work in the three files named</p>
<ul>
<li><strong>recipes-repository.js</strong>: The collection of functions needed to interact with recipes for the application</li>
<li><strong>instructions-repository.js</strong>: The collection of functions needed to interact with the instructions for the application</li>
<li><strong>ingredients-repository.js</strong>: The collection of functions needed to interact with the ingredients for the application</li>
</ul>
<p>Each of the files imports your models and makes them available to you. Then, you can use them in your querying. Follow the hints in each of the repository functions.</p>
