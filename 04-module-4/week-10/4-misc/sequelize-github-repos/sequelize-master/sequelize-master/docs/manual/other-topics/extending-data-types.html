<h1 id="extending-data-types">Extending Data Types</h1>
<p>Most likely the type you are trying to implement is already included in <a href="data-types.html">DataTypes</a>. If a new datatype is not included, this manual will show how to write it yourself.</p>
<p>Sequelize doesn’t create new datatypes in the database. This tutorial explains how to make Sequelize recognize new datatypes and assumes that those new datatypes are already created in the database.</p>
<p>To extend Sequelize datatypes, do it before any Sequelize instance is created.</p>
<h2 id="example">Example</h2>
<p>In this example, we will create a type called <code>SOMETYPE</code> that replicates the built-in datatype <code>DataTypes.INTEGER(11).ZEROFILL.UNSIGNED</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">const</span> <span class="op">{</span> Sequelize<span class="op">,</span> DataTypes<span class="op">,</span> Utils <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;Sequelize&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="at">createTheNewDataType</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">const</span> sequelize <span class="op">=</span> <span class="kw">new</span> <span class="at">Sequelize</span>(<span class="st">&#39;sqlite::memory:&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">function</span> <span class="at">createTheNewDataType</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7">  <span class="kw">class</span> SOMETYPE <span class="kw">extends</span> <span class="va">DataTypes</span>.<span class="at">ABSTRACT</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="co">// Mandatory: complete definition of the new type in the database</span></a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="at">toSql</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-10" title="10">      <span class="cf">return</span> <span class="st">&#39;INTEGER(11) UNSIGNED ZEROFILL&#39;</span></a>
<a class="sourceLine" id="cb1-11" title="11">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-12" title="12"></a>
<a class="sourceLine" id="cb1-13" title="13">    <span class="co">// Optional: validator function</span></a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="at">validate</span>(value<span class="op">,</span> options) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-15" title="15">      <span class="cf">return</span> (<span class="kw">typeof</span> value <span class="op">===</span> <span class="st">&#39;number&#39;</span>) <span class="op">&amp;&amp;</span> (<span class="op">!</span><span class="va">Number</span>.<span class="at">isNaN</span>(value))<span class="op">;</span></a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-17" title="17"></a>
<a class="sourceLine" id="cb1-18" title="18">    <span class="co">// Optional: sanitizer</span></a>
<a class="sourceLine" id="cb1-19" title="19">    <span class="at">_sanitize</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-20" title="20">      <span class="co">// Force all numbers to be positive</span></a>
<a class="sourceLine" id="cb1-21" title="21">      <span class="cf">return</span> value <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">0</span> : <span class="va">Math</span>.<span class="at">round</span>(value)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-22" title="22">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-23" title="23"></a>
<a class="sourceLine" id="cb1-24" title="24">    <span class="co">// Optional: value stringifier before sending to database</span></a>
<a class="sourceLine" id="cb1-25" title="25">    <span class="at">_stringify</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-26" title="26">      <span class="cf">return</span> <span class="va">value</span>.<span class="at">toString</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb1-27" title="27">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-28" title="28"></a>
<a class="sourceLine" id="cb1-29" title="29">    <span class="co">// Optional: parser for values received from the database</span></a>
<a class="sourceLine" id="cb1-30" title="30">    <span class="kw">static</span> <span class="at">parse</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-31" title="31">      <span class="cf">return</span> <span class="va">Number</span>.<span class="at">parseInt</span>(value)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-32" title="32">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-33" title="33">  <span class="op">}</span></a>
<a class="sourceLine" id="cb1-34" title="34"></a>
<a class="sourceLine" id="cb1-35" title="35">  <span class="co">// Mandatory: set the type key</span></a>
<a class="sourceLine" id="cb1-36" title="36">  <span class="va">SOMETYPE</span>.<span class="va">prototype</span>.<span class="at">key</span> <span class="op">=</span> <span class="va">SOMETYPE</span>.<span class="at">key</span> <span class="op">=</span> <span class="st">&#39;SOMETYPE&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb1-37" title="37"></a>
<a class="sourceLine" id="cb1-38" title="38">  <span class="co">// Mandatory: add the new type to DataTypes. Optionally wrap it on `Utils.classToInvokable` to</span></a>
<a class="sourceLine" id="cb1-39" title="39">  <span class="co">// be able to use this datatype directly without having to call `new` on it.</span></a>
<a class="sourceLine" id="cb1-40" title="40">  <span class="va">DataTypes</span>.<span class="at">SOMETYPE</span> <span class="op">=</span> <span class="va">Utils</span>.<span class="at">classToInvokable</span>(SOMETYPE)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-41" title="41"></a>
<a class="sourceLine" id="cb1-42" title="42">  <span class="co">// Optional: disable escaping after stringifier. Do this at your own risk, since this opens opportunity for SQL injections.</span></a>
<a class="sourceLine" id="cb1-43" title="43">  <span class="co">// DataTypes.SOMETYPE.escape = false;</span></a>
<a class="sourceLine" id="cb1-44" title="44"></a>
<a class="sourceLine" id="cb1-45" title="45"><span class="op">}</span></a></code></pre></div>
<p>After creating this new datatype, you need to map this datatype in each database dialect and make some adjustments.</p>
<h2 id="postgresql">PostgreSQL</h2>
<p>Let’s say the name of the new datatype is <code>pg_new_type</code> in the postgres database. That name has to be mapped to <code>DataTypes.SOMETYPE</code>. Additionally, it is required to create a child postgres-specific datatype.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">function</span> <span class="at">createTheNewDataType</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="co">// [...]</span></a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="kw">const</span> PgTypes <span class="op">=</span> <span class="va">DataTypes</span>.<span class="at">postgres</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6">  <span class="co">// Mandatory: map postgres datatype name</span></a>
<a class="sourceLine" id="cb2-7" title="7">  <span class="va">DataTypes</span>.<span class="va">SOMETYPE</span>.<span class="va">types</span>.<span class="at">postgres</span> <span class="op">=</span> [<span class="st">&#39;pg_new_type&#39;</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb2-8" title="8"></a>
<a class="sourceLine" id="cb2-9" title="9">  <span class="co">// Mandatory: create a postgres-specific child datatype with its own parse</span></a>
<a class="sourceLine" id="cb2-10" title="10">  <span class="co">// method. The parser will be dynamically mapped to the OID of pg_new_type.</span></a>
<a class="sourceLine" id="cb2-11" title="11">  <span class="va">PgTypes</span>.<span class="at">SOMETYPE</span> <span class="op">=</span> <span class="kw">function</span> <span class="at">SOMETYPE</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="cf">if</span> (<span class="op">!</span>(<span class="kw">this</span> <span class="kw">instanceof</span> <span class="va">PgTypes</span>.<span class="at">SOMETYPE</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-13" title="13">      <span class="cf">return</span> <span class="kw">new</span> <span class="va">PgTypes</span>.<span class="at">SOMETYPE</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-15" title="15">    <span class="va">DataTypes</span>.<span class="va">SOMETYPE</span>.<span class="at">apply</span>(<span class="kw">this</span><span class="op">,</span> <span class="kw">arguments</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-16" title="16">  <span class="op">}</span></a>
<a class="sourceLine" id="cb2-17" title="17">  <span class="kw">const</span> util <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;util&#39;</span>)<span class="op">;</span> <span class="co">// Built-in Node package</span></a>
<a class="sourceLine" id="cb2-18" title="18">  <span class="va">util</span>.<span class="at">inherits</span>(<span class="va">PgTypes</span>.<span class="at">SOMETYPE</span><span class="op">,</span> <span class="va">DataTypes</span>.<span class="at">SOMETYPE</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-19" title="19"></a>
<a class="sourceLine" id="cb2-20" title="20">  <span class="co">// Mandatory: create, override or reassign a postgres-specific parser</span></a>
<a class="sourceLine" id="cb2-21" title="21">  <span class="co">// PgTypes.SOMETYPE.parse = value =&gt; value;</span></a>
<a class="sourceLine" id="cb2-22" title="22">  <span class="va">PgTypes</span>.<span class="va">SOMETYPE</span>.<span class="at">parse</span> <span class="op">=</span> <span class="va">DataTypes</span>.<span class="va">SOMETYPE</span>.<span class="at">parse</span> <span class="op">||</span> x <span class="kw">=&gt;</span> x<span class="op">;</span></a>
<a class="sourceLine" id="cb2-23" title="23"></a>
<a class="sourceLine" id="cb2-24" title="24">  <span class="co">// Optional: add or override methods of the postgres-specific datatype</span></a>
<a class="sourceLine" id="cb2-25" title="25">  <span class="co">// like toSql, escape, validate, _stringify, _sanitize...</span></a>
<a class="sourceLine" id="cb2-26" title="26"></a>
<a class="sourceLine" id="cb2-27" title="27"><span class="op">}</span></a></code></pre></div>
<h3 id="ranges">Ranges</h3>
<p>After a new range type has been <a href="https://www.postgresql.org/docs/current/static/rangetypes.html#RANGETYPES-DEFINING">defined in postgres</a>, it is trivial to add it to Sequelize.</p>
<p>In this example the name of the postgres range type is <code>SOMETYPE_range</code> and the name of the underlying postgres datatype is <code>pg_new_type</code>. The key of <code>subtypes</code> and <code>castTypes</code> is the key of the Sequelize datatype <code>DataTypes.SOMETYPE.key</code>, in lower case.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">function</span> <span class="at">createTheNewDataType</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="co">// [...]</span></a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4">  <span class="co">// Add postgresql range, SOMETYPE comes from DataType.SOMETYPE.key in lower case</span></a>
<a class="sourceLine" id="cb3-5" title="5">  <span class="va">DataTypes</span>.<span class="va">RANGE</span>.<span class="va">types</span>.<span class="va">postgres</span>.<span class="va">subtypes</span>.<span class="at">SOMETYPE</span> <span class="op">=</span> <span class="st">&#39;SOMETYPE_range&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-6" title="6">  <span class="va">DataTypes</span>.<span class="va">RANGE</span>.<span class="va">types</span>.<span class="va">postgres</span>.<span class="va">castTypes</span>.<span class="at">SOMETYPE</span> <span class="op">=</span> <span class="st">&#39;pg_new_type&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="op">}</span></a></code></pre></div>
<p>The new range can be used in model definitions as <code>DataTypes.RANGE(DataTypes.SOMETYPE)</code> or <code>DataTypes.RANGE(DataTypes.SOMETYPE)</code>.</p>
