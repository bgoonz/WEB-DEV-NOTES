<h2 id="orm-w10d4---learning-objectives">ORM (W10D4) - Learning Objectives</h2>
<h3 id="orm">ORM</h3>
<ol type="1">
<li>How to install, configure, and use Sequelize, an ORM for JavaScript</li>
</ol>
<ul>
<li>To start a new project we use our standard npm initialize statement
<ul>
<li><code>npm init -y</code></li>
</ul></li>
<li>Add in the packages we will need (sequelize, sequelize-cli, and pg)
<ul>
<li><code>npm install sequelize@^5.0.0 sequelize-cli@^5.0.0 pg@^8.0.0</code></li>
</ul></li>
<li>Initialize sequelize in our project
<ul>
<li><code>npx sequelize-cli init</code></li>
</ul></li>
<li>Create a database user with credentials we will use for the project
<ul>
<li><code>psql</code></li>
<li><code>CREATE USER example_user WITH PASSWORD 'badpassword'</code></li>
</ul></li>
<li>Here we can also create databases since we are already in postgres
<ul>
<li><code>CREATE DATABASE example_app_development WITH OWNER example_user</code></li>
<li><code>CREATE DATABASE example_app_test WITH OWNER example_user</code></li>
<li><code>CREATE DATABASE example_app_production WITH OWNER example_user</code></li>
</ul></li>
<li>If we don’t create these databases now, we could also create them after we make our changes to our config file. If we take this approach, we need to make sure our user that we created has the <code>CREATEDB</code> option when we make them, since sequelize will attempt to make the databases with this user. This other approach would look like:
<ul>
<li>In psql: <code>CREATE USER example_user WITH PASSWORD 'badpassword' CREATEDB</code></li>
<li>In terminal: <code>npx sequelize-cli db:create</code></li>
</ul></li>
<li>Double check that our configuration file matches our username, password, database, dialect, and seederStorage (these will be filled out for you in an assessment scenario):</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb1-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="dt">&quot;development&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-3" title="3">    <span class="dt">&quot;username&quot;</span><span class="fu">:</span> <span class="st">&quot;sequelize_recipe_box_app&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-4" title="4">    <span class="dt">&quot;password&quot;</span><span class="fu">:</span> <span class="st">&quot;HfKfK79k&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-5" title="5">    <span class="dt">&quot;database&quot;</span><span class="fu">:</span> <span class="st">&quot;recipe_box_development&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="dt">&quot;host&quot;</span><span class="fu">:</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="dt">&quot;dialect&quot;</span><span class="fu">:</span> <span class="st">&quot;postgres&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="dt">&quot;seederStorage&quot;</span><span class="fu">:</span> <span class="st">&quot;sequelize&quot;</span></a>
<a class="sourceLine" id="cb1-9" title="9">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb1-10" title="10">  <span class="dt">&quot;test&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-11" title="11">    <span class="dt">&quot;username&quot;</span><span class="fu">:</span> <span class="st">&quot;sequelize_recipe_box_app&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-12" title="12">    <span class="dt">&quot;password&quot;</span><span class="fu">:</span> <span class="st">&quot;HfKfK79k&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-13" title="13">    <span class="dt">&quot;database&quot;</span><span class="fu">:</span> <span class="st">&quot;recipe_box_test&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="dt">&quot;host&quot;</span><span class="fu">:</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-15" title="15">    <span class="dt">&quot;dialect&quot;</span><span class="fu">:</span> <span class="st">&quot;postgres&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="dt">&quot;seederStorage&quot;</span><span class="fu">:</span> <span class="st">&quot;sequelize&quot;</span></a>
<a class="sourceLine" id="cb1-17" title="17">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb1-18" title="18">  <span class="dt">&quot;production&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-19" title="19">    <span class="dt">&quot;username&quot;</span><span class="fu">:</span> <span class="st">&quot;sequelize_recipe_box_app&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-20" title="20">    <span class="dt">&quot;password&quot;</span><span class="fu">:</span> <span class="st">&quot;HfKfK79k&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-21" title="21">    <span class="dt">&quot;database&quot;</span><span class="fu">:</span> <span class="st">&quot;recipe_box_production&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-22" title="22">    <span class="dt">&quot;host&quot;</span><span class="fu">:</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-23" title="23">    <span class="dt">&quot;dialect&quot;</span><span class="fu">:</span> <span class="st">&quot;postgres&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-24" title="24">    <span class="dt">&quot;seederStorage&quot;</span><span class="fu">:</span> <span class="st">&quot;sequelize&quot;</span></a>
<a class="sourceLine" id="cb1-25" title="25">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="fu">}</span></a></code></pre></div>
<ol start="2" type="1">
<li>How to use database migrations to make your database grow with your application in a source-control enabled way</li>
</ol>
<ul>
<li><h4 id="migrations">Migrations</h4>
<ul>
<li>In order to make new database tables and sequelize models that reflect them, we want to generate a migration file and model file using <code>model:generate</code>
<ul>
<li><code>npx sequelize-cli model:generate --name Cat --attributes "firstName:string,specialSkill:string"</code></li>
<li>Here we are creating a migration file and a model file for a Cat. We are specifying that we want this table to have fields for firstName and specialSkill. Sequelize will automatically make fields for an id, createdAt, and updatedAt, as well, so we do not need to specify these.</li>
</ul></li>
<li>Once our migration file is created, we can go in and edit any details that we need to. Most often we will want to add in database constraints such as <code>allowNull: false</code>, adding a uniqueness constraint with <code>unique: true</code>, adding in character limits to fields such as <code>type: Sequelize.STRING(100)</code>, or specifying a foreign key with references to another table <code>references: { model: 'Categories' }</code>.</li>
<li>After we make any necessary changes to our migration file, we need to perform the migration, which will run the SQL commands to actually create the table.
<ul>
<li><code>npx sequelize-cli db:migrate</code></li>
<li>This command runs any migration files that have not been previously run, in the order that they were created (this is why the timestamp in the file name is important)</li>
</ul></li>
<li>If we realize that we made a mistake after migrating, we can undo our previous migration, or all of our migrations. After undoing them, we can make any changes necessary to our migration files (They won’t be deleted from the undo, so we don’t need to generate anything! Just make the necessary changes to the files that already exist and save the files.). Running the migrations again will make the tables with the updates reflected.
<ul>
<li><code>npx sequelize-cli db:migrate:undo</code></li>
<li><code>npx sequelize-cli db:migrate:undo:all</code></li>
</ul></li>
</ul></li>
<li><h4 id="models---validations-and-associations">Models - Validations and Associations</h4>
<ul>
<li>In addition to the migration files, our <code>model:generate</code> command also created a model file for us. This file is what allows sequelize to transform the results of its SQL queries into useful JavaScript objects for us.</li>
<li><p>The model is where we can specify a validation that we want to perform before trying to run a SQL query. If the validation fails, we can respond with a message instead of running the query, which can be an expensive operation that we know won’t work.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// Before we make changes, sequelize generates the type that this field represents</span></a>
<a class="sourceLine" id="cb2-2" title="2">specification<span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">TEXT</span></a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co">// We can replace the generated format with an object to specify not only the type, but the validations that we want to implement. The validations can also take in messages the respond with on failure and arguments.</span></a>
<a class="sourceLine" id="cb2-5" title="5">specification<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-6" title="6">  <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">TEXT</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-7" title="7">  <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-9" title="9">      <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;The specification cannot be empty&#39;</span></a>
<a class="sourceLine" id="cb2-10" title="10">    <span class="op">},</span></a>
<a class="sourceLine" id="cb2-11" title="11">    <span class="dt">len</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-12" title="12">      <span class="dt">args</span><span class="op">:</span> [<span class="dv">10</span><span class="op">,</span> <span class="dv">100</span>]</a>
<a class="sourceLine" id="cb2-13" title="13">      <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;The specifcation must be between 10 and 100 characters&#39;</span></a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-15" title="15">  <span class="op">}</span></a>
<a class="sourceLine" id="cb2-16" title="16"><span class="op">}</span></a></code></pre></div></li>
<li>Another key part of the model file is setting up our associations. We can use the <code>belongsTo</code>, <code>hasMany</code>, and <code>belongsToMany</code> methods to set up model-level associations. Doing so is what creates the helpful functionality like <code>addOwner</code> that we saw in the pets example, a function that automatically generates the SQL necessary to create a petOwner record and supplies the appropriate petId and ownerId.
<ul>
<li>In a one-to-many association, we need to have a <code>belongsTo</code> association on the “many” side, and a <code>hasMany</code> association on the “one” side:
<ul>
<li><code>Instruction.belongsTo(models.Recipe, { foreignKey: 'recipeId' });</code></li>
<li><code>Recipe.hasMany(models.Instruction, { foreignKey: 'recipeId' });</code></li>
</ul></li>
<li><p>In a many-to-many association, we need to have a <code>belongsToMany</code> on each side of the association. We generally specify a columnMapping object to show the association more clearly:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// In our Owner model</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co">// To connect this Owner to a Pet through the PetOwner</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">const</span> columnMapping <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-4" title="4">  <span class="dt">through</span><span class="op">:</span> <span class="st">&#39;PetOwner&#39;</span><span class="op">,</span> <span class="co">// joins table</span></a>
<a class="sourceLine" id="cb3-5" title="5">  <span class="dt">otherKey</span><span class="op">:</span> <span class="st">&#39;petId&#39;</span><span class="op">,</span> <span class="co">// key that connects to other table we have a many association with</span></a>
<a class="sourceLine" id="cb3-6" title="6">  <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;ownerId&#39;</span> <span class="co">// our foreign key in the joins table</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="va">Owner</span>.<span class="at">belongsToMany</span>(<span class="va">models</span>.<span class="at">Pet</span><span class="op">,</span> columnMapping)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-9" title="9"></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co">// In our Pet model</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co">// To connect this Pet to an Owner through the PetOwner</span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="kw">const</span> columnMapping <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-13" title="13">  <span class="dt">through</span><span class="op">:</span> <span class="st">&#39;PetOwner&#39;</span><span class="op">,</span> <span class="co">// joins table</span></a>
<a class="sourceLine" id="cb3-14" title="14">  <span class="dt">otherKey</span><span class="op">:</span> <span class="st">&#39;ownerId&#39;</span><span class="op">,</span> <span class="co">// key that connects to other table we have a many association with</span></a>
<a class="sourceLine" id="cb3-15" title="15">  <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;petId&#39;</span> <span class="co">// our foreign key in the joins table</span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="va">Pet</span>.<span class="at">belongsToMany</span>(<span class="va">models</span>.<span class="at">Owner</span><span class="op">,</span> columnMapping)<span class="op">;</span></a></code></pre></div></li>
</ul></li>
</ul></li>
</ul>
<ol start="3" type="1">
<li>How to perform CRUD operations with Sequelize</li>
</ol>
<ul>
<li><h4 id="seed-files">Seed Files</h4>
<ul>
<li>Seed files can be used to populate our database with starter data.
<ul>
<li><code>npx sequelize-cli seed:generate --name add-cats</code></li>
<li><code>up</code> indicates what to create when we seed our database, <code>down</code> indicates what to delete if we want to unseed the database.</li>
<li><p>For our up, we use the <code>queryInterface.bulkInsert()</code> method, which takes in the name of the table to seed and an array of objects representing the records we want to create:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1">up<span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkInsert</span>(<span class="st">&#39;&lt;&lt;TableName&gt;&gt;&#39;</span><span class="op">,</span> [</a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="op">{</span> <span class="dt">field1</span><span class="op">:</span> value1a<span class="op">,</span> <span class="dt">field2</span><span class="op">:</span> value2a <span class="op">},</span></a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="op">{</span> <span class="dt">field1</span><span class="op">:</span> value1b<span class="op">,</span> <span class="dt">field2</span><span class="op">:</span> value2b <span class="op">},</span></a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="op">{</span> <span class="dt">field1</span><span class="op">:</span> value1c<span class="op">,</span> <span class="dt">field2</span><span class="op">:</span> value2c <span class="op">}</span></a>
<a class="sourceLine" id="cb4-6" title="6">  ])<span class="op">;</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="op">}</span></a></code></pre></div></li>
<li>For our down, we use the <code>queryInterface.bulkDelete()</code> method, which takes in the name of the table and an object representing our WHERE clause. Unseeding will delete all records from the specified table that match the WHERE clause.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// If we want to specify what to remove:</span></a>
<a class="sourceLine" id="cb5-2" title="2">down<span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkDelete</span>(<span class="st">&#39;&lt;&lt;TableName&gt;&gt;&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="dt">field1</span><span class="op">:</span> [value1a<span class="op">,</span> value1b<span class="op">,</span> value1c] <span class="co">//...etc.</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="op">}</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co">// If we want to remove everything from the table:</span></a>
<a class="sourceLine" id="cb5-8" title="8">down<span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-9" title="9">  <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkDelete</span>(<span class="st">&#39;&lt;&lt;TableName&gt;&gt;&#39;</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-10" title="10"><span class="op">}</span></a></code></pre></div>
<ul>
<li>Running <code>npx sequelize-cli db:seed:all</code> will run all of our seeder files.</li>
<li><code>npx sequelize-cli db:seed:undo:all</code> will undo all of our seeding.</li>
<li>If we omit the <code>:all</code> we can run specific seed files</li>
</ul></li>
</ul></li>
<li><h4 id="inserting-with-build-and-create">Inserting with Build and Create</h4>
<ul>
<li>In addition to seed files, which we generally use for starter data, we can create new records in our database by using <code>build</code> and <code>save</code>, or the combined <code>create</code>
<ul>
<li>Use the .build method of the Cat model to create a new Cat instance in index.js</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="co">// Constructs an instance of the JavaScript `Cat` class. **Does not</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co">// save anything to the database yet**. Attributes are passed in as a</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">// POJO.</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw">const</span> newCat <span class="op">=</span> <span class="va">Cat</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb6-5" title="5">  <span class="dt">firstName</span><span class="op">:</span> <span class="st">&#39;Markov&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-6" title="6">  <span class="dt">specialSkill</span><span class="op">:</span> <span class="st">&#39;sleeping&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-7" title="7">  <span class="dt">age</span><span class="op">:</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-9" title="9"></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co">// This actually creates a new `Cats` record in the database. We must</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="co">// wait for this asynchronous operation to succeed.</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="cf">await</span> <span class="va">newCat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb6-13" title="13"></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="co">// This builds and saves all in one step. If we don&#39;t need to perform any operations on the instance before saving it, this can optimize our code.</span></a>
<a class="sourceLine" id="cb6-15" title="15"><span class="kw">const</span> newerCat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">create</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb6-16" title="16">  <span class="dt">firstName</span><span class="op">:</span> <span class="st">&#39;Whiskers&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-17" title="17">  <span class="dt">specialSkill</span><span class="op">:</span> <span class="st">&#39;sleeping&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-18" title="18">  <span class="dt">age</span><span class="op">:</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb6-19" title="19"><span class="op">}</span>)</a></code></pre></div></li>
</ul></li>
<li><h4 id="updating-records">Updating Records</h4>
<ul>
<li>When we have a reference to an instance of a model (i.e. after we have queried for it or created it), we can update values by simply reassigning those fields and using the <code>save</code> method</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="co">// Get a reference to the cat record that we want to update (here just the cat with primary key of 1)</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-3" title="3"></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co">// Change cat&#39;s attributes.</span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="va">cat</span>.<span class="at">firstName</span> <span class="op">=</span> <span class="st">&quot;Curie&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="va">cat</span>.<span class="at">specialSkill</span> <span class="op">=</span> <span class="st">&quot;jumping&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="va">cat</span>.<span class="at">age</span> <span class="op">=</span> <span class="dv">123</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-8" title="8"></a>
<a class="sourceLine" id="cb7-9" title="9"><span class="co">// Save the new name to the database.</span></a>
<a class="sourceLine" id="cb7-10" title="10"><span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a></code></pre></div></li>
<li><h4 id="deleting-records">Deleting Records</h4>
<ul>
<li>When we have a reference to an instance of a model, we can delete that record by using <code>destroy</code></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">// Remove the Markov record.</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="cf">await</span> <span class="va">cat</span>.<span class="at">destroy</span>()<span class="op">;</span></a></code></pre></div>
<ul>
<li>We can also call <code>destroy</code> on the model itself. By passing in an object that specifies a where clause, we can destroy all records that match that query</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="cf">await</span> <span class="va">Cat</span>.<span class="at">destroy</span>(<span class="op">{</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> <span class="dt">specialSkill</span><span class="op">:</span> <span class="st">&#39;jumping&#39;</span> <span class="op">}</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div></li>
</ul>
<ol start="4" type="1">
<li>How to query using Sequelize</li>
</ol>
<ul>
<li><h4 id="findall">findAll</h4>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="co">// Log the fetched cats.</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="co">// The extra arguments to stringify are a replacer and a space respectively</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="co">// Here we&#39;re specifying a space of 2 in order to print more legibly</span></a>
<a class="sourceLine" id="cb10-5" title="5"><span class="co">// We don&#39;t want a replacer, so we pass null just so that we can pass a 3rd argument</span></a>
<a class="sourceLine" id="cb10-6" title="6"><span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a></code></pre></div></li>
<li><h4 id="where-clause">WHERE clause</h4>
<ul>
<li>Passing an object to findAll can add on clauses to our query</li>
<li>The <code>where</code> key takes an object as a value to indicate what we are filtering by</li>
<li>{ where: { field: value } } =&gt; WHERE field = value</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-3" title="3">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Markov&quot;</span></a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a></code></pre></div></li>
<li><h4 id="or-in-the-where-clause">OR in the WHERE clause</h4>
<ul>
<li>Using an array for the value tells sequelize we want to match any of these values</li>
<li>{ where: { field: [value1, value2] } =&gt; WHERE field IN (value1, value2)</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-3" title="3">    <span class="dt">firstName</span><span class="op">:</span> [<span class="st">&quot;Markov&quot;</span><span class="op">,</span> <span class="st">&quot;Curie&quot;</span>]</a>
<a class="sourceLine" id="cb12-4" title="4">  <span class="op">}</span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a></code></pre></div></li>
<li><h4 id="and-in-the-where-clause">AND in the WHERE clause</h4>
<ul>
<li>Providing additional key/value pairs to the where object indicates all filters must match</li>
<li>{ where: { field1: value1, field2: value2 } } =&gt; WHERE field1 = value1 AND field2 = value2</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-3" title="3">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Markov&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb13-4" title="4">    <span class="dt">age</span><span class="op">:</span> <span class="dv">4</span></a>
<a class="sourceLine" id="cb13-5" title="5">  <span class="op">}</span></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a></code></pre></div></li>
<li><h4 id="sequelize-op-operator">Sequelize Op operator</h4>
<ul>
<li>By requiring Op from the sequelize library we can provide more advanced comparison operators</li>
<li><code>const { Op } = require("sequelize");</code></li>
<li><p>Op.ne: Not equal operator</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-3" title="3">    <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-4" title="4">      <span class="co">// All cats where the name is not equal to &quot;Markov&quot;</span></a>
<a class="sourceLine" id="cb14-5" title="5">      <span class="co">// We use brackets in order to evaluate Op.ne and use the value as the key</span></a>
<a class="sourceLine" id="cb14-6" title="6">      [<span class="va">Op</span>.<span class="at">ne</span>]<span class="op">:</span> <span class="st">&quot;Markov&quot;</span></a>
<a class="sourceLine" id="cb14-7" title="7">    <span class="op">},</span></a>
<a class="sourceLine" id="cb14-8" title="8">  <span class="op">},</span></a>
<a class="sourceLine" id="cb14-9" title="9"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-10" title="10"><span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a></code></pre></div></li>
<li><p>Op.and: and operator</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-3" title="3">    <span class="co">// The array that Op.and points to must all be true</span></a>
<a class="sourceLine" id="cb15-4" title="4">    <span class="co">// Here, we find cats where the name is not &quot;Markov&quot; and the age is 4</span></a>
<a class="sourceLine" id="cb15-5" title="5">    [<span class="va">Op</span>.<span class="at">and</span>]<span class="op">:</span> [</a>
<a class="sourceLine" id="cb15-6" title="6">      <span class="op">{</span> <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span> [<span class="va">Op</span>.<span class="at">ne</span>]<span class="op">:</span> <span class="st">&quot;Markov&quot;</span> <span class="op">}</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb15-7" title="7">      <span class="op">{</span> <span class="dt">age</span><span class="op">:</span> <span class="dv">4</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb15-8" title="8">    ]<span class="op">,</span></a>
<a class="sourceLine" id="cb15-9" title="9">  <span class="op">},</span></a>
<a class="sourceLine" id="cb15-10" title="10"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-11" title="11"><span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a></code></pre></div></li>
<li><p>Op.or: or operator</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb16-2" title="2">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb16-3" title="3">    <span class="co">// One condition in the array that Op.or points to must be true</span></a>
<a class="sourceLine" id="cb16-4" title="4">    <span class="co">// Here, we find cats where the name is &quot;Markov&quot; or where the age is 4</span></a>
<a class="sourceLine" id="cb16-5" title="5">    [<span class="va">Op</span>.<span class="at">or</span>]<span class="op">:</span> [</a>
<a class="sourceLine" id="cb16-6" title="6">      <span class="op">{</span> <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Markov&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb16-7" title="7">      <span class="op">{</span> <span class="dt">age</span><span class="op">:</span> <span class="dv">4</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb16-8" title="8">    ]<span class="op">,</span></a>
<a class="sourceLine" id="cb16-9" title="9">  <span class="op">},</span></a>
<a class="sourceLine" id="cb16-10" title="10"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-11" title="11"><span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a></code></pre></div></li>
<li><p>Op.gt and Op.lt: greater than and less than operators</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb17-2" title="2">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-3" title="3">    <span class="co">// Find all cats where the age is greater than 4</span></a>
<a class="sourceLine" id="cb17-4" title="4">    <span class="dt">age</span><span class="op">:</span> <span class="op">{</span> [<span class="va">Op</span>.<span class="at">gt</span>]<span class="op">:</span> <span class="dv">4</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb17-5" title="5">  <span class="op">}</span></a>
<a class="sourceLine" id="cb17-6" title="6">  <span class="op">},</span></a>
<a class="sourceLine" id="cb17-7" title="7">})<span class="op">;</span></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a></code></pre></div></li>
</ul></li>
<li><h4 id="ordering-results">Ordering results</h4>
<ul>
<li>Just like the where clause, we can pass an order key to specify we want our results ordered</li>
<li>The key <code>order</code> points to an array with the fields that we want to order by</li>
<li>By default, the order is ascending, just like standard SQL. If we want to specify descending, we can instead use a nested array with the field name as the first element and “DESC” as the second element. (We could also specify “ASC” as a second element in a nested array, but it is unnecessary as it is default)</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb18-2" title="2">  <span class="co">// Order by age descending, then by firstName ascending if cats have the same age</span></a>
<a class="sourceLine" id="cb18-3" title="3">  <span class="dt">order</span><span class="op">:</span> [[<span class="st">&quot;age&quot;</span><span class="op">,</span> <span class="st">&quot;DESC&quot;</span>]<span class="op">,</span> <span class="st">&quot;firstName&quot;</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-5" title="5"><span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a></code></pre></div></li>
<li><h4 id="limiting-results">Limiting results</h4>
<ul>
<li>We can provide a <code>limit</code> key in order to limit our results to a specified number</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb19-2" title="2">  <span class="dt">order</span><span class="op">:</span> [[<span class="st">&quot;age&quot;</span><span class="op">,</span> <span class="st">&quot;DESC&quot;</span>]]<span class="op">,</span></a>
<a class="sourceLine" id="cb19-3" title="3">  <span class="co">// Here we are limiting our results to one record. It will still return an array, just with one object inside. We could have said any number here, the result is always an array.</span></a>
<a class="sourceLine" id="cb19-4" title="4">  <span class="dt">limit</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a></code></pre></div></li>
<li><h4 id="findone">findOne</h4>
<ul>
<li>If we only want one record to be returned we can use findOne instead of findAll</li>
<li>If multiple records would have matched our findOne query, it will return the first record</li>
<li>Unlike findAll, findOne will return the object directly instead of an array. If no records matched the query it will return null.</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb20-1" title="1"><span class="co">// finds the oldest cat</span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findOne</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb20-3" title="3">  <span class="dt">order</span><span class="op">:</span> [[<span class="st">&quot;age&quot;</span><span class="op">,</span> <span class="st">&quot;DESC&quot;</span>]]<span class="op">,</span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cat<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a></code></pre></div></li>
<li><h4 id="querying-with-associations">Querying with Associations</h4>
<ul>
<li>We can include associated data by adding an <code>include</code> key to our options object</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb21-1" title="1"><span class="kw">const</span> pet <span class="op">=</span> <span class="va">Pet</span>.<span class="at">findByPk</span>(<span class="dv">1</span><span class="op">,</span> <span class="op">{</span> <span class="dt">include</span><span class="op">:</span> [ PetType<span class="op">,</span> Owner ] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb21-2" title="2"><span class="va">console</span>.<span class="at">log</span>(</a>
<a class="sourceLine" id="cb21-3" title="3">  <span class="va">pet</span>.<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb21-4" title="4">  <span class="va">pet</span>.<span class="at">name</span><span class="op">,</span></a>
<a class="sourceLine" id="cb21-5" title="5">  <span class="va">pet</span>.<span class="at">age</span><span class="op">,</span></a>
<a class="sourceLine" id="cb21-6" title="6">  <span class="va">pet</span>.<span class="at">petTypeId</span><span class="op">,</span></a>
<a class="sourceLine" id="cb21-7" title="7">  <span class="va">pet</span>.<span class="va">PetType</span>.<span class="at">type</span><span class="op">,</span></a>
<a class="sourceLine" id="cb21-8" title="8">  <span class="va">pet</span>.<span class="at">Owners</span></a>
<a class="sourceLine" id="cb21-9" title="9">)</a></code></pre></div>
<ul>
<li>We can get nested associations by having <code>include</code> point to an object that specifies which <code>model</code> we have an association with, then chaining an association on with another <code>include</code></li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb22-1" title="1"><span class="kw">const</span> owner <span class="op">=</span> <span class="va">Owner</span>.<span class="at">findByPk</span>(<span class="dv">1</span><span class="op">,</span> <span class="op">{</span> <span class="dt">include</span><span class="op">:</span> <span class="op">{</span> <span class="dt">model</span><span class="op">:</span> Pet<span class="op">,</span> <span class="dt">include</span><span class="op">:</span> PetType <span class="op">}</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="va">console</span>.<span class="at">log</span>(</a>
<a class="sourceLine" id="cb22-3" title="3">  <span class="va">pet</span>.<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb22-4" title="4">  <span class="va">pet</span>.<span class="at">name</span><span class="op">,</span></a>
<a class="sourceLine" id="cb22-5" title="5">  <span class="va">pet</span>.<span class="at">age</span><span class="op">,</span></a>
<a class="sourceLine" id="cb22-6" title="6">  <span class="va">pet</span>.<span class="at">petTypeId</span><span class="op">,</span></a>
<a class="sourceLine" id="cb22-7" title="7">  <span class="va">pet</span>.<span class="va">PetType</span>.<span class="at">type</span><span class="op">,</span></a>
<a class="sourceLine" id="cb22-8" title="8">  <span class="va">pet</span>.<span class="at">Owners</span></a>
<a class="sourceLine" id="cb22-9" title="9">)</a></code></pre></div></li>
</ul>
<ol start="5" type="1">
<li>How to perform data validations with Sequelize</li>
</ol>
<ul>
<li>See the database migrations section above.</li>
<li>In general, we add in a validate key to each field that we want validations for. This key points to an object that specifies all of the validations we want to make on that field, such as <code>notEmpty</code>, <code>notNull</code>, <code>len</code>, <code>isIn</code>, etc.</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb23-1" title="1">specification<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb23-2" title="2">  <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">TEXT</span><span class="op">,</span></a>
<a class="sourceLine" id="cb23-3" title="3">  <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb23-4" title="4">    <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb23-5" title="5">      <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;The specification cannot be empty&#39;</span></a>
<a class="sourceLine" id="cb23-6" title="6">    <span class="op">},</span></a>
<a class="sourceLine" id="cb23-7" title="7">    <span class="dt">len</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb23-8" title="8">      <span class="dt">args</span><span class="op">:</span> [<span class="dv">10</span><span class="op">,</span> <span class="dv">100</span>]</a>
<a class="sourceLine" id="cb23-9" title="9">      <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;The specifcation must be between 10 and 100 characters&#39;</span></a>
<a class="sourceLine" id="cb23-10" title="10">    <span class="op">}</span></a>
<a class="sourceLine" id="cb23-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb23-12" title="12"><span class="op">}</span></a></code></pre></div>
<ol start="6" type="1">
<li>How to use transactions with Sequelize</li>
</ol>
<ul>
<li>We can create a transaction block in order to make sure either all operations are performed or none of them are</li>
<li>We use the <code>.transaction</code> method in order to create our block. The method takes in a callback with an argument to track our transaction id (typically just a simple <code>tx</code> variable).</li>
<li>All of our sequelize operations can be passed a <code>transaction</code> key on their options argument which points to our transaction id. This indicates that this operation is part of the transaction block and should only be executed in the database when the whole block executes without error.</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb24-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb24-2" title="2">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb24-3" title="3">    <span class="co">// Do all database access within the transaction.</span></a>
<a class="sourceLine" id="cb24-4" title="4">    <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">transaction</span>(<span class="kw">async</span> (tx) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb24-5" title="5">      <span class="co">// Fetch Markov and Curie&#39;s accounts.</span></a>
<a class="sourceLine" id="cb24-6" title="6">      <span class="kw">const</span> markovAccount <span class="op">=</span> <span class="cf">await</span> <span class="va">BankAccount</span>.<span class="at">findByPk</span>(</a>
<a class="sourceLine" id="cb24-7" title="7">        <span class="dv">1</span><span class="op">,</span> <span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">},</span></a>
<a class="sourceLine" id="cb24-8" title="8">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb24-9" title="9">      <span class="kw">const</span> curieAccount <span class="op">=</span> <span class="cf">await</span> <span class="va">BankAccount</span>.<span class="at">findByPk</span>(</a>
<a class="sourceLine" id="cb24-10" title="10">        <span class="dv">2</span><span class="op">,</span> <span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span></a>
<a class="sourceLine" id="cb24-11" title="11">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb24-12" title="12"></a>
<a class="sourceLine" id="cb24-13" title="13">      <span class="co">// No one can mess with Markov or Curie&#39;s accounts until the</span></a>
<a class="sourceLine" id="cb24-14" title="14">      <span class="co">// transaction completes! The account data has been locked!</span></a>
<a class="sourceLine" id="cb24-15" title="15"></a>
<a class="sourceLine" id="cb24-16" title="16">      <span class="co">// Increment Curie&#39;s balance by $5,000.</span></a>
<a class="sourceLine" id="cb24-17" title="17">      <span class="va">curieAccount</span>.<span class="at">balance</span> <span class="op">+=</span> <span class="dv">5000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb24-18" title="18">      <span class="cf">await</span> <span class="va">curieAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-19" title="19"></a>
<a class="sourceLine" id="cb24-20" title="20">      <span class="co">// Decrement Markov&#39;s balance by $5,000.</span></a>
<a class="sourceLine" id="cb24-21" title="21">      <span class="va">markovAccount</span>.<span class="at">balance</span> <span class="op">-=</span> <span class="dv">5000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb24-22" title="22">      <span class="cf">await</span> <span class="va">markovAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-23" title="23">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-24" title="24">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb24-25" title="25">    <span class="co">// Report if anything goes wrong.</span></a>
<a class="sourceLine" id="cb24-26" title="26">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Error!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-27" title="27"></a>
<a class="sourceLine" id="cb24-28" title="28">    <span class="cf">for</span> (<span class="kw">const</span> e <span class="kw">of</span> <span class="va">err</span>.<span class="at">errors</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb24-29" title="29">      <span class="va">console</span>.<span class="at">log</span>(</a>
<a class="sourceLine" id="cb24-30" title="30">        <span class="vs">`</span><span class="sc">${</span><span class="va">e</span>.<span class="va">instance</span>.<span class="at">clientName</span><span class="sc">}</span><span class="vs">: </span><span class="sc">${</span><span class="va">e</span>.<span class="at">message</span><span class="sc">}</span><span class="vs">`</span></a>
<a class="sourceLine" id="cb24-31" title="31">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb24-32" title="32">    <span class="op">}</span></a>
<a class="sourceLine" id="cb24-33" title="33">  <span class="op">}</span></a>
<a class="sourceLine" id="cb24-34" title="34"></a>
<a class="sourceLine" id="cb24-35" title="35">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb24-36" title="36"><span class="op">}</span></a>
<a class="sourceLine" id="cb24-37" title="37"></a>
<a class="sourceLine" id="cb24-38" title="38"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
