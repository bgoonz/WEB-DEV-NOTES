(window.webpackJsonp=window.webpackJsonp||[]).push([["quick-reload~b59ad437"],{Bcqe:function(e,t,i){var s=i("RNvQ"),o=i("tQYX");e.exports=function(e,t,i){var n=!0,a=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return o(i)&&(n="leading"in i?!!i.leading:n,a="trailing"in i?!!i.trailing:a),s(e,t,{leading:n,maxWait:t,trailing:a})}},UnvT:function(e,t,i){"use strict";i.r(t);var s=i("ERkP"),o=i.n(s),n=i("lZoD"),a=i("1U1M"),c=i("z9P0"),r=i("qhEF"),l=i("n3bg"),d=i("a0gl"),u=i("LEcB"),m=i("+6Tk"),h=i("Czhu"),p=i("zjfJ"),b=i("L21V"),v=i("lbXe"),g=i("hpu0"),f=i("3VMZ"),y=i("A79P"),w=i("gScn");const O=Object(b.f)({newVersion:{id:"quick-reload.new-version-published",description:"Flag title to inform user that a new page version is avilable on reload",defaultMessage:"New version published"},newComment:{id:"quick-reload.new-comment",description:"Flag title to inform user that a new page comment is avilable on reload",defaultMessage:"New comment"},newComments:{id:"quick-reload.new-comments",description:"Flag title to inform user that multiple new page comments are avilable on reload",defaultMessage:"{numComments} new comments"},somebodyCommented:{id:"quick-reload.somebody-commented",description:"Flag description to inform who has added a comment",defaultMessage:"{somebody} commented"},twoPeopleCommented:{id:"quick-reload.two-people-commented",description:"Flag description to inform that two people have added comments",defaultMessage:"{somebody} and {somebodyElse} commented"},atLeastThreePeopleCommented:{id:"quick-reload.at-least-three-people-commented",description:"Flag description to inform that multiple people have added comments",defaultMessage:"{somebody} and {numOthers} others commented"},newCommentsLoading:{id:"quick-reload.new-comments-loading",description:"Flag description to inform that comments for the page are being loaded",defaultMessage:"Loading comments for this page..."},somebodyPublished:{id:"quick-reload.somebody-published",description:"Flag description to inform who has re-published this page",defaultMessage:"{somebody} published a new version of this page"},twoPeoplePublished:{id:"quick-reload.two-people-published",description:"Flag description to inform that two people have re-published this page",defaultMessage:"{somebody} and {somebodyElse} published a new version of this page"},atLeastThreePeoplePublished:{id:"quick-reload.at-least-three-people-published",description:"Flag description to inform that multiple people have re-published this page",defaultMessage:"{somebody} and {numOthers} others published a new version of this page"},newContentLoading:{id:"quick-reload.new-content-loading",description:"Flag description to inform that page is being reloaded",defaultMessage:"Loading new version of this page..."},reload:{id:"quick-reload.reload",description:"Button label for button that causes a page reload",defaultMessage:"Reload"},viewComment:{id:"quick-reload.view-comment",description:"label to prompt user to view the latest comment",defaultMessage:"See the latest comment"},viewFirstComment:{id:"quick-reload.view-first-comment",description:"label to prompt user to view the first comment",defaultMessage:"See their comment"}});class k{constructor(e,t,i){this.intl=e,this.currentAccountId=t,this.showFlag=i,Object(p.a)(this,"numEvents",0),Object(p.a)(this,"uniqueNames",[]),Object(p.a)(this,"resetEvents",()=>{this.numEvents=0,this.uniqueNames=[]})}addEvents(e){let t=!1;if(e.forEach(e=>{e.accountId&&this.currentAccountId&&e.accountId===this.currentAccountId||(this.numEvents++,this.uniqueNames=[e.displayName,...this.uniqueNames.filter(t=>t!==e.displayName)],t=!0)}),t){const t=this.createMessage();e[0].url&&(t.url=e[0].url),this.showFlag(t)}}}class j extends k{createMessage(){const e={title:this.intl.formatMessage(O.newVersion),onClose:this.resetEvents};switch(this.uniqueNames.length){case 1:return Object(h.a)(Object(h.a)({},e),{},{description:this.intl.formatMessage(O.somebodyPublished,{somebody:this.uniqueNames[0]}),type:"single"});case 2:return Object(h.a)(Object(h.a)({},e),{},{description:this.intl.formatMessage(O.twoPeoplePublished,{somebody:this.uniqueNames[0],somebodyElse:this.uniqueNames[1]}),type:"batch"});default:return Object(h.a)(Object(h.a)({},e),{},{description:this.intl.formatMessage(O.atLeastThreePeoplePublished,{somebody:this.uniqueNames[0],numOthers:this.uniqueNames.length-1}),type:"batch"})}}}class I extends k{createMessage(){const e={onClose:this.resetEvents,title:1===this.numEvents?this.intl.formatMessage(O.newComment):this.intl.formatMessage(O.newComments,{numComments:this.numEvents})};switch(this.uniqueNames.length){case 1:return Object(h.a)(Object(h.a)({},e),{},{description:this.intl.formatMessage(O.somebodyCommented,{somebody:this.uniqueNames[0]}),type:"single"});case 2:return Object(h.a)(Object(h.a)({},e),{},{description:this.intl.formatMessage(O.twoPeopleCommented,{somebody:this.uniqueNames[0],somebodyElse:this.uniqueNames[1]}),type:"batch"});default:return Object(h.a)(Object(h.a)({},e),{},{description:this.intl.formatMessage(O.atLeastThreePeopleCommented,{somebody:this.uniqueNames[0],numOthers:this.uniqueNames.length-1}),type:"batch"})}}}class C extends s.PureComponent{constructor(...e){super(...e),Object(p.a)(this,"state",{}),Object(p.a)(this,"startPoller",e=>{this.stopPoller=this.props.poller(this.props.intl,this.props.timer,this.props.contentId,this.props.currentAccountId,e,this.makeShowFlag,this.hideFlags)}),Object(p.a)(this,"fireReloadAnalytics",e=>{const{createAnalyticsEvent:t}=this.props;t&&t({type:"sendUIEvent",data:{source:"quickReload",action:"clicked",actionSubject:"button",actionSubjectId:"quickReloadButton",attributes:Object(h.a)({veryQuickReload:!1},e)}}).fire()}),Object(p.a)(this,"resetEvents",e=>{if(this.props.subscription){const t=e?this.state.commentStream:this.state.editsStream;null==t||t.resetEvents()}else this.stopPoller(!1),this.startPoller(Date.now())}),Object(p.a)(this,"reload",async(e,t,i,s)=>{const{intl:o,push:n,contentId:a,isNextRendered:c,flagsStateContainer:r}=this.props,l=e?this.showingFlagIdsForType.comment:this.showingFlagIdsForType.edit,d=e?o.formatMessage(O.newCommentsLoading):o.formatMessage(O.newContentLoading);await r.updateFlag(l,{description:d,actions:[]});const u={veryQuickReload:!0,isNextRendered:c,contentId:a,type:e?"comment":"edit"};var m;let h;m=u,Object(g.b)().start({name:f.a.QUICK_RELOAD,timeout:y.a.DEFAULT,attributes:m});try{await t(s)}catch(p){h=p}var p;this.fireReloadAnalytics(u),h?(p=h,Object(g.c)(f.a.QUICK_RELOAD,p),i()):Object(g.b)().succeed({name:f.a.QUICK_RELOAD}),r.hideFlag(l),this.resetEvents(e),s&&n(s,!1)}),Object(p.a)(this,"commentFlagOnClick",async e=>{const{push:t,reloadComments:i}=this.props,s=()=>{e?t(e,!0):window.location.reload()};i?await this.reload(!0,i,s,e):(this.fireReloadAnalytics(),s())}),Object(p.a)(this,"contentFlagOnClick",async()=>{const{reloadContent:e}=this.props,t=()=>{window.location.reload()};e?await this.reload(!1,e,t):(this.fireReloadAnalytics(),t())}),Object(p.a)(this,"stopPoller",()=>{}),Object(p.a)(this,"actions",[{content:o.a.createElement("div",{"data-test-id":"quick-reload-reload-button"},this.props.intl.formatMessage(O.reload)),onClick:this.contentFlagOnClick}]),Object(p.a)(this,"showingFlagIdsForType",{edit:void 0,comment:void 0}),Object(p.a)(this,"makeShowFlag",e=>async t=>{const{createAnalyticsEvent:i}=this.props,s=this.showingFlagIdsForType[e],{url:n,type:a}=t,c=[{content:o.a.createElement("div",{"data-test-id":"quick-reload-reload-button"},"single"===a?this.props.intl.formatMessage(O.viewFirstComment):this.props.intl.formatMessage(O.viewComment)),onClick:()=>this.commentFlagOnClick(n)}],r=await this.props.flagsStateContainer.showInfoFlag(Object(h.a)(Object(h.a)({},t),{},{actions:"comment"===e?c:this.actions,onClose:()=>{delete this.showingFlagIdsForType[e],t.onClose(),i&&i({type:"sendUIEvent",data:{source:"quickReload",action:"closed",actionSubject:"flag",actionSubjectId:"flagCloseButton"}}).fire()}}));void 0===this.showingFlagIdsForType.edit&&void 0===this.showingFlagIdsForType.comment&&i&&i({type:"sendOperationalEvent",data:{source:"quickReload",action:"displayed",actionSubject:"quickReloadFlag"}}).fire(),this.showingFlagIdsForType[e]=r.id,void 0!==s&&await this.props.flagsStateContainer.hideFlag(s)}),Object(p.a)(this,"hideFlags",()=>{["edit","comment"].forEach(async e=>{const t=this.showingFlagIdsForType[e];void 0!==t&&(await this.props.flagsStateContainer.hideFlag(t),delete this.showingFlagIdsForType[t])})})}componentDidMount(){this.props.subscription?this.setState((e,t)=>Object(h.a)(Object(h.a)({},e),{},{commentStream:new I(t.intl,t.currentAccountId,this.makeShowFlag("comment")),editsStream:new j(t.intl,t.currentAccountId,this.makeShowFlag("edit"))})):this.startPoller(this.props.lastPollTime)}componentDidUpdate(e){const{subscription:t}=this.props,{commentStream:i,editsStream:s}=this.state;if(t&&!e.subscription&&this.stopPoller(),t){if(i&&s&&t!==e.subscription){var o,n;const{quickReloadSubscriptions:e}=t;var a,c,r,l;if("comment"===(null==e||null===(o=e.contentType)||void 0===o?void 0:o.value))i.addEvents([{displayName:null===(a=e.author)||void 0===a?void 0:a.displayName,url:null===(c=e.quickReloadContent)||void 0===c||null===(r=c.links)||void 0===r?void 0:r.webui,accountId:null===(l=e.author)||void 0===l?void 0:l.accountId}]);else if("page"===(null==e||null===(n=e.contentType)||void 0===n?void 0:n.value)){var d,u;s.addEvents([{displayName:null===(d=e.author)||void 0===d?void 0:d.displayName,accountId:null===(u=e.author)||void 0===u?void 0:u.accountId}])}}}else this.props.contentId!==e.contentId&&(this.stopPoller(),this.startPoller(this.props.lastPollTime))}componentWillUnmount(){this.props.subscription||this.stopPoller()}render(){return null}}const F=Object(b.g)(Object(v.a)()(Object(w.a)(C)));F.displayName="QuickReloadFlagsI18nProvider";var E=i("p0L4"),q=i("rc7/"),T=i("F4Ur"),R=i("8TdO"),A=i("H5qd"),S=i.n(A);const N=S.a`query QuickReloadQuery($contentId:ID!$since:ExperimentalLong!)@experimental{experimentalQuickReload(contentId:$contentId since:$since){time editorForPage{displayName accountId}comments{comment{id url author{displayName accountId}}}}}`,P=S.a`subscription QuickReloadSubscription($contentId:ID!){quickReloadSubscriptions(contentId:$contentId){contentId createdAt author{accountId displayName}contentType{value}quickReloadContent{...on CommentDocument{id links{webui}}}}}`,M=S.a`query PageRestrictionsQuery($contentId:ID!){content(id:$contentId){nodes{id hasInheritedRestrictions hasRestrictions hasViewRestrictions}}}`;async function x(e,t,i,s){return async function(e,t,i,s,o){var n,a,c;let r;if(!i||!t)return;try{r=await e({query:N,variables:{contentId:i,since:t},fetchPolicy:"no-cache",errorPolicy:"all",context:{fetchOptions:{ignoreNoNetworkError:!0},single:!0}})}catch(p){return void((Object(q.b)(p)||p instanceof E.a)&&Object(T.a)(p))}if(r.errors&&r.errors.length){var l;const e=null!=(l=r)&&null!=(l=l.data)&&null!=(l=l.experimentalQuickReload)?l.status:l;return void[...r.errors.filter(e=>Object(q.b)(e)),...r.errors.filter(t=>t instanceof E.a||!e)].forEach(e=>Object(T.a)(e))}if(o.stopped)return;if(s!==o.querySeq)return;const d=((null!=(c=r)&&null!=(c=c.data)&&null!=(c=c.experimentalQuickReload)?c.comments:c)||[]).map(e=>{var t,i,s,o;return{id:null!=(o=e)&&null!=(o=o.comment)?o.id:o,displayName:null!=(s=e)&&null!=(s=s.comment)&&null!=(s=s.author)?s.displayName:s,url:null!=(i=e)&&null!=(i=i.comment)?i.url:i,accountId:null!=(t=e)&&null!=(t=t.comment)&&null!=(t=t.author)?t.accountId:t}});d.length&&o.commentsStream.addEvents(d);const u=null!=(a=r)&&null!=(a=a.data)&&null!=(a=a.experimentalQuickReload)?a.editorForPage:a;if(u){var m,h;const e=(null!=(h=u)?h.displayName:h)||"",t=(null!=(m=u)?m.accountId:m)||null;o.editsStream.addEvents([{displayName:e,accountId:t}])}return null!=(n=r)&&null!=(n=n.data)&&null!=(n=n.experimentalQuickReload)?n.time:n}(Object(R.b)().query,e,t,i,s)}function L(e,t,i,s,o,n,a){const c={querySeq:0,stopped:!1,editsStream:new j(e,s,n("edit")),commentsStream:new I(e,s,n("comment"))},r=new t(async()=>{const e=await x(o,i,++c.querySeq,c);e&&(o=e)});return r.start(),(e=!0)=>{c.stopped=!0,r.stop(),e&&a()}}var D=i("Bcqe"),Q=i.n(D);const U={min:6e4,max:12e4,inactivity:12e4},B={min:4e3,max:4e3,inactivity:4e3};class _{isDocumentHidden(){return"boolean"==typeof window.__documentHiddenOverrideForUnitTest?window.__documentHiddenOverrideForUnitTest:document.hidden}calculateNextDue(){const e=Date.now()-this.lastActivityAt>=this.options.inactivity?this.options.max:this.options.min;return this.lastCallbackAt+e}setTimerToFireAt(e){void 0!==this.timer&&clearTimeout(this.timer);const t=Date.now(),i=Math.max(0,e-t);this.timer=setTimeout(this.timerDidFire,i),this.nextCallbackAt=t+i}bringTimerForwardTo(e){this.nextCallbackAt>e&&this.setTimerToFireAt(e)}executeCallback(){setTimeout(this.callback,0),this.lastCallbackAt=Date.now()}setTimerFromCold(){this.setTimerToFireAt(this.calculateNextDue())}constructor(e){if(this.callback=e,Object(p.a)(this,"options",void 0),Object(p.a)(this,"timer",void 0),Object(p.a)(this,"lastActivityAt",void 0),Object(p.a)(this,"lastCallbackAt",void 0),Object(p.a)(this,"nextCallbackAt",void 0),Object(p.a)(this,"timerDidFire",()=>{this.timer=void 0,this.executeCallback(),this.setTimerFromCold()}),Object(p.a)(this,"didReceiveActivity",Q()(()=>{this.lastActivityAt=Date.now(),this.bringTimerForwardTo(this.calculateNextDue())},500)),Object(p.a)(this,"visibilityDidChange",()=>{this.isDocumentHidden()?(void 0!==this.timer&&clearTimeout(this.timer),this.timer=void 0,this.nextCallbackAt=1/0):(this.lastActivityAt=Date.now(),this.setTimerFromCold())}),this.options=Object(h.a)({},U),window.__fastQuickReloadTimerForIntegrationTest){this.options=Object(h.a)(Object(h.a)({},this.options),B);const e=document.createElement("div");e.setAttribute("data-test-id","quick-reload-test-marker"),document.body.appendChild(e)}this.lastActivityAt=0,this.lastCallbackAt=0,this.nextCallbackAt=0}start(){window.addEventListener("focus",this.didReceiveActivity),document.addEventListener("visibilitychange",this.visibilityDidChange),document.addEventListener("click",this.didReceiveActivity),document.addEventListener("scroll",this.didReceiveActivity);const e=Date.now();this.lastCallbackAt=e,this.lastActivityAt=e,this.nextCallbackAt=1/0,this.setTimerFromCold()}stop(){window.removeEventListener("focus",this.didReceiveActivity),document.removeEventListener("visibilitychange",this.visibilityDidChange),document.removeEventListener("click",this.didReceiveActivity),document.removeEventListener("scroll",this.didReceiveActivity),clearTimeout(this.timer),this.timer=void 0}}var H=i("1N1n");i.d(t,"QuickReload",(function(){return V}));let $;const V=({contentId:e,lastPollTime:t,timerOverride:i,isNextRendered:h})=>{const{userId:p}=Object(d.a)(),{cohort:b}=Object(u.a)("confluence.frontend.quick.reload.strategy",["POLLING","SUBSCRIPTIONS","BOTH"],"POLLING"),[v,g]=Object(s.useState)(!document.hidden),[f,y]=Object(s.useState)(!v);Object(s.useEffect)(()=>{const e=()=>g(!document.hidden);return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[g]);const w=Object(l.b)(),{createAnalyticsEvent:O}=Object(c.a)();Object(s.useEffect)(()=>{v&&y(!1),w&&(v&&$&&(clearTimeout($),$=null),v||$||($=setTimeout(()=>{Object(l.a)().close(!0,!0),y(!0)},2e3)))},[w,v]),Object(s.useEffect)(()=>{"SUBSCRIPTIONS"!==b&&"BOTH"!==b||w||O({type:"sendTrackEvent",data:{source:"quickReload",actionSubject:"subscription",action:"fellbackOnPolling",attributes:{contentId:e,cohort:b,errorMessage:"WebSockets not available"}}}).fire()},[e,b,w,O]);const{reloaders:k}=Object(s.useContext)(H.b),j=Object(m.a)(H.a),I=j?k.content:void 0,C=j?k.comment:void 0,{data:E,error:q,loading:T}=Object(a.d)(M,{variables:{contentId:e}}),R=()=>{var e;if(!Object(l.b)()||f)return!0;if("SUBSCRIPTIONS"!==b&&"BOTH"!==b)return!0;const t=null==E||null===(e=E.content)||void 0===e?void 0:e.nodes[0];return!t||(t.hasInheritedRestrictions||t.hasRestrictions||t.hasViewRestrictions)},{data:A,error:S,loading:N}=Object(a.e)(P,{variables:{contentId:e},skip:R()}),x=N||!A?{}:A;if(Object(s.useEffect)(()=>{S&&O({type:"sendTrackEvent",data:{source:"quickReload",actionSubject:"subscription",action:"fellbackOnPolling",attributes:{contentId:e,errorMessage:S}}}).fire()},[S,O,e]),q||T)return null;return o.a.createElement(n.c,{to:[r.a]},s=>o.a.createElement(F,{flagsStateContainer:s,poller:L,subscription:"SUBSCRIPTIONS"!==b||R()||S?null:x,contentId:e,isNextRendered:h||!1,currentAccountId:p,reloadContent:I,reloadComments:C,lastPollTime:t,timer:i||_}))}}}]);
//# sourceMappingURL=quick-reload~b59ad437.JH9R8WsNL2.js.map